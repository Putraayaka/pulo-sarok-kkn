{% extends 'public/base.html' %}

{% block title %}Data Penduduk - Website Desa Pulosarok{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-gradient text-white py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4 fade-in">Data Penduduk</h1>
            <p class="text-xl opacity-90 fade-in">Informasi Demografis Desa Pulosarok</p>
        </div>
    </div>
</section>

<!-- Statistics Overview -->
<section class="py-16 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">Statistik Penduduk</h2>
            <p class="text-gray-600">Data demografis terkini Desa Pulosarok</p>
        </div>
        
        <div id="population-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
            <!-- Stats will be loaded here -->
        </div>
        
        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Distribusi Berdasarkan Jenis Kelamin</h3>
                <canvas id="genderChart" width="400" height="300"></canvas>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Distribusi Berdasarkan Usia</h3>
                <canvas id="ageChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
</section>

<!-- Population Data Section -->
<section class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 space-y-4 lg:space-y-0">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Data Penduduk per Dusun</h2>
                
                <!-- Filters -->
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 w-full lg:w-auto">
                    <select id="dusun-filter" class="w-full sm:w-auto px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        <option value="">Semua Dusun</option>
                    </select>
                    
                    <select id="gender-filter" class="w-full sm:w-auto px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        <option value="">Semua Jenis Kelamin</option>
                        <option value="L">Laki-laki</option>
                        <option value="P">Perempuan</option>
                    </select>
                    
                    <button onclick="exportPopulationData()" class="w-full sm:w-auto bg-primary-600 text-white px-3 py-2 text-sm rounded-lg hover:bg-primary-700 transition-colors">
                        <i class="fas fa-download mr-1 sm:mr-2"></i><span class="hidden sm:inline">Export</span><span class="sm:hidden">Export</span>
                    </button>
                </div>
            </div>
            
            <!-- Population Table -->
            <div class="overflow-x-auto -mx-4 sm:mx-0">
                <div class="inline-block min-w-full align-middle">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dusun</th>
                                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lorong</th>
                                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">L</th>
                                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P</th>
                                <th class="px-3 sm:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="population-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pagination -->
            <div id="pagination" class="flex items-center justify-between mt-6">
                <!-- Pagination will be loaded here -->
            </div>
        </div>
    </div>
</section>

<!-- Disability Data Section -->
<section class="py-16 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">Data Disabilitas</h2>
            <p class="text-gray-600">Informasi penduduk dengan kebutuhan khusus</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Distribusi Jenis Disabilitas</h3>
                <canvas id="disabilityChart" width="400" height="300"></canvas>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Statistik Disabilitas</h3>
                <div id="disability-stats" class="space-y-4">
                    <!-- Disability stats will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Population Detail Modal -->
<div id="population-modal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="population-modal-title" class="text-2xl font-bold text-gray-900"></h2>
                    <button onclick="closeModal('population-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="population-modal-content">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    class PopulationPage {
        constructor() {
            this.currentPage = 1;
            this.pageSize = 10;
            this.filters = {
                dusun: '',
                gender: ''
            };
            this.init();
        }
        
        async init() {
            await this.loadPopulationStats();
            await this.loadDusunOptions();
            await this.loadPopulationData();
            await this.loadDisabilityData();
            this.setupFilters();
        }
        
        setupFilters() {
            document.getElementById('dusun-filter').addEventListener('change', (e) => {
                this.filters.dusun = e.target.value;
                this.currentPage = 1;
                this.loadPopulationData();
            });
            
            document.getElementById('gender-filter').addEventListener('change', (e) => {
                this.filters.gender = e.target.value;
                this.currentPage = 1;
                this.loadPopulationData();
            });
        }
        
        async loadPopulationStats() {
            try {
                const data = await apiCall('/api/references/population-api/stats/');
                this.renderPopulationStats(data);
                this.renderGenderChart(data);
                this.renderAgeChart(data);
            } catch (error) {
                console.error('Error loading population stats:', error);
            }
        }
        
        renderPopulationStats(data) {
            const container = document.getElementById('population-stats');
            
            const statsData = [
                { icon: 'fas fa-users', label: 'Total Penduduk', value: data.total_population || 0, color: 'blue' },
                { icon: 'fas fa-male', label: 'Laki-laki', value: data.male_count || 0, color: 'green' },
                { icon: 'fas fa-female', label: 'Perempuan', value: data.female_count || 0, color: 'pink' },
                { icon: 'fas fa-home', label: 'Total Dusun', value: data.dusun_count || 0, color: 'purple' }
            ];
            
            container.innerHTML = statsData.map(stat => `
                <div class="bg-white rounded-lg shadow-lg p-6 text-center card-hover">
                    <div class="w-16 h-16 bg-${stat.color}-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="${stat.icon} text-${stat.color}-600 text-2xl"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-900 mb-2">${formatNumber(stat.value)}</h3>
                    <p class="text-gray-600">${stat.label}</p>
                </div>
            `).join('');
        }
        
        renderGenderChart(data) {
            const ctx = document.getElementById('genderChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Laki-laki', 'Perempuan'],
                    datasets: [{
                        data: [data.male_count || 0, data.female_count || 0],
                        backgroundColor: ['#3B82F6', '#EC4899'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        renderAgeChart(data) {
            const ctx = document.getElementById('ageChart').getContext('2d');
            const ageGroups = data.age_groups || {};
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-17', '18-64', '65+'],
                    datasets: [{
                        label: 'Jumlah Penduduk',
                        data: [
                            ageGroups['0-17'] || 0,
                            ageGroups['18-64'] || 0,
                            ageGroups['65+'] || 0
                        ],
                        backgroundColor: '#0EA5E9',
                        borderColor: '#0284C7',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        async loadDusunOptions() {
            try {
                const data = await apiCall('/api/references/dusun-api/');
                const select = document.getElementById('dusun-filter');
                
                if (data.results) {
                    data.results.forEach(dusun => {
                        const option = document.createElement('option');
                        option.value = dusun.id;
                        option.textContent = dusun.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading dusun options:', error);
            }
        }
        
        async loadPopulationData() {
            try {
                let url = `/api/references/population-api/?page=${this.currentPage}&page_size=${this.pageSize}`;
                
                if (this.filters.dusun) {
                    url += `&dusun=${this.filters.dusun}`;
                }
                if (this.filters.gender) {
                    url += `&gender=${this.filters.gender}`;
                }
                
                const data = await apiCall(url);
                this.renderPopulationTable(data.results || []);
                this.renderPagination(data);
            } catch (error) {
                console.error('Error loading population data:', error);
                document.getElementById('population-table-body').innerHTML = 
                    '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Gagal memuat data penduduk</td></tr>';
            }
        }
        
        renderPopulationTable(populations) {
            const tbody = document.getElementById('population-table-body');
            
            if (populations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-3 sm:px-6 py-3 sm:py-4 text-center text-gray-500 text-sm">Tidak ada data penduduk</td></tr>';
                return;
            }
            
            // Group by dusun and lorong
            const grouped = populations.reduce((acc, person) => {
                const key = `${person.dusun}-${person.lorong}`;
                if (!acc[key]) {
                    acc[key] = {
                        dusun: person.dusun,
                        lorong: person.lorong,
                        total: 0,
                        male: 0,
                        female: 0,
                        people: []
                    };
                }
                acc[key].total++;
                acc[key].people.push(person);
                if (person.gender === 'L') acc[key].male++;
                else acc[key].female++;
                return acc;
            }, {});
            
            tbody.innerHTML = Object.values(grouped).map(group => `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900">${group.dusun}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${group.lorong}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">${formatNumber(group.total)}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${formatNumber(group.male)}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${formatNumber(group.female)}</td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium">
                        <button onclick="showPopulationDetail('${group.dusun}', '${group.lorong}')" class="text-primary-600 hover:text-primary-900">
                            <i class="fas fa-eye mr-1"></i><span class="hidden sm:inline">Detail</span>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        renderPagination(data) {
            const container = document.getElementById('pagination');
            const totalPages = Math.ceil((data.count || 0) / this.pageSize);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Menampilkan ${((this.currentPage - 1) * this.pageSize) + 1} - ${Math.min(this.currentPage * this.pageSize, data.count)} dari ${data.count} data
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="populationPage.changePage(${this.currentPage - 1})" 
                                ${this.currentPage === 1 ? 'disabled' : ''} 
                                class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            Sebelumnya
                        </button>
                        <span class="px-3 py-2 text-sm font-medium text-gray-700">
                            Halaman ${this.currentPage} dari ${totalPages}
                        </span>
                        <button onclick="populationPage.changePage(${this.currentPage + 1})" 
                                ${this.currentPage === totalPages ? 'disabled' : ''} 
                                class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            Selanjutnya
                        </button>
                    </div>
                </div>
            `;
        }
        
        changePage(page) {
            if (page < 1) return;
            this.currentPage = page;
            this.loadPopulationData();
        }
        
        async loadDisabilityData() {
            try {
                const data = await apiCall('/api/references/disabilitas-api/');
                this.renderDisabilityChart(data);
                this.renderDisabilityStats(data);
            } catch (error) {
                console.error('Error loading disability data:', error);
            }
        }
        
        renderDisabilityChart(data) {
            const ctx = document.getElementById('disabilityChart').getContext('2d');
            const types = data.types || {};
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(types),
                    datasets: [{
                        data: Object.values(types),
                        backgroundColor: [
                            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        renderDisabilityStats(data) {
            const container = document.getElementById('disability-stats');
            const stats = data.stats || {};
            
            const statsData = [
                { label: 'Total Penyandang Disabilitas', value: stats.total || 0, icon: 'fas fa-wheelchair' },
                { label: 'Disabilitas Fisik', value: stats.physical || 0, icon: 'fas fa-walking' },
                { label: 'Disabilitas Mental', value: stats.mental || 0, icon: 'fas fa-brain' },
                { label: 'Disabilitas Sensorik', value: stats.sensory || 0, icon: 'fas fa-eye' }
            ];
            
            container.innerHTML = statsData.map(stat => `
                <div class="flex items-center p-4 bg-gray-50 rounded-lg">
                    <div class="w-12 h-12 bg-primary-100 rounded-full flex items-center justify-center mr-4">
                        <i class="${stat.icon} text-primary-600"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-600">${stat.label}</p>
                        <p class="text-2xl font-bold text-gray-900">${formatNumber(stat.value)}</p>
                    </div>
                </div>
            `).join('');
        }
    }
    
    async function showPopulationDetail(dusun, lorong) {
        try {
            const data = await apiCall(`/api/references/population-api/?dusun=${encodeURIComponent(dusun)}&lorong=${encodeURIComponent(lorong)}`);
            
            document.getElementById('population-modal-title').textContent = `Detail Penduduk ${dusun} - ${lorong}`;
            document.getElementById('population-modal-content').innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600">${data.results.length}</div>
                            <div class="text-sm text-blue-600">Total Penduduk</div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600">${data.results.filter(p => p.gender === 'L').length}</div>
                            <div class="text-sm text-green-600">Laki-laki</div>
                        </div>
                        <div class="bg-pink-50 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-pink-600">${data.results.filter(p => p.gender === 'P').length}</div>
                            <div class="text-sm text-pink-600">Perempuan</div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NIK</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">JK</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Umur</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${data.results.map(person => `
                                    <tr>
                                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${person.name}</td>
                                        <td class="px-4 py-3 text-sm text-gray-500">${person.nik}</td>
                                        <td class="px-4 py-3 text-sm text-gray-500">${person.gender}</td>
                                        <td class="px-4 py-3 text-sm text-gray-500">${person.age || '-'}</td>
                                        <td class="px-4 py-3 text-sm text-gray-500">${person.marital_status || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            openModal('population-modal');
        } catch (error) {
            console.error('Error loading population detail:', error);
        }
    }
    
    async function exportPopulationData() {
        try {
            let url = '/api/references/population-api/export/';
            const params = new URLSearchParams();
            
            if (populationPage.filters.dusun) {
                params.append('dusun', populationPage.filters.dusun);
            }
            if (populationPage.filters.gender) {
                params.append('gender', populationPage.filters.gender);
            }
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            window.open(url, '_blank');
        } catch (error) {
            console.error('Error exporting population data:', error);
        }
    }
    
    // Initialize population page
    let populationPage;
    document.addEventListener('DOMContentLoaded', function() {
        populationPage = new PopulationPage();
    });
</script>
{% endblock %}
