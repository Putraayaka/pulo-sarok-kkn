{% extends 'base.html' %}

{% block title %}Struktur Organisasi - Website Desa Pulosarok{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-gradient text-white py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4 fade-in">Struktur Organisasi</h1>
            <p class="text-xl opacity-90 fade-in">Pemerintahan Desa Pulosarok</p>
        </div>
    </div>
</section>

<!-- Organization Chart -->
<section class="py-16 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">Bagan Organisasi</h2>
            <p class="text-gray-600 max-w-2xl mx-auto">Struktur organisasi pemerintahan Desa Pulosarok periode saat ini</p>
        </div>
        
        <div id="organization-chart" class="bg-gray-50 rounded-lg p-8 overflow-x-auto">
            <!-- Organization chart will be loaded here -->
        </div>
    </div>
</section>

<!-- Filter Section -->
<section class="py-8 bg-gray-50 border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
            <div class="flex flex-col sm:flex-row gap-4 flex-1">
                <div class="flex-1">
                    <input type="text" id="search-input" placeholder="Cari pejabat..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                </div>
                
                <select id="position-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Semua Jabatan</option>
                    <option value="kepala_desa">Kepala Desa</option>
                    <option value="sekretaris_desa">Sekretaris Desa</option>
                    <option value="kaur">Kepala Urusan</option>
                    <option value="kasi">Kepala Seksi</option>
                    <option value="kadus">Kepala Dusun</option>
                    <option value="rt">Ketua RT</option>
                    <option value="rw">Ketua RW</option>
                    <option value="bpd">BPD</option>
                    <option value="pkk">PKK</option>
                    <option value="karang_taruna">Karang Taruna</option>
                </select>
                
                <select id="status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Semua Status</option>
                    <option value="aktif">Aktif</option>
                    <option value="nonaktif">Non-aktif</option>
                </select>
            </div>
            
            <div class="flex gap-2">
                <button onclick="toggleView('chart')" id="chart-btn" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                    <i class="fas fa-sitemap mr-2"></i>Bagan
                </button>
                <button onclick="toggleView('list')" id="list-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                    <i class="fas fa-list mr-2"></i>Daftar
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Officials List View -->
<section id="list-view" class="py-16 bg-gray-50 hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div id="officials-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Officials list will be loaded here -->
        </div>
        
        <!-- Pagination -->
        <div id="list-pagination" class="flex items-center justify-center mt-12">
            <!-- Pagination will be loaded here -->
        </div>
    </div>
</section>

<!-- Chart View -->
<section id="chart-view" class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div id="interactive-chart" class="bg-white rounded-lg shadow-lg p-8">
            <!-- Interactive chart will be loaded here -->
        </div>
    </div>
</section>

<!-- Statistics Section -->
<section class="py-16 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">Statistik Organisasi</h2>
            <p class="text-gray-600">Data dan informasi terkini mengenai struktur organisasi desa</p>
        </div>
        
        <div id="org-stats" class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-12">
            <!-- Stats will be loaded here -->
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Distribusi Jabatan</h3>
                <canvas id="positionChart" width="400" height="300"></canvas>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Distribusi Usia</h3>
                <canvas id="ageChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
</section>

<!-- Official Detail Modal -->
<div id="official-modal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="official-modal-title" class="text-2xl font-bold text-gray-900"></h2>
                    <button onclick="closeModal('official-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="official-modal-content">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Organization Chart Modal -->
<div id="chart-modal" class="fixed inset-0 bg-black bg-opacity-90 modal hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative max-w-6xl w-full">
            <button onclick="closeModal('chart-modal')" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <div id="chart-modal-content" class="bg-white rounded-lg p-8 overflow-auto max-h-screen">
                <!-- Chart content will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    class OrganizationPage {
        constructor() {
            this.currentView = 'chart';
            this.currentPage = 1;
            this.pageSize = 12;
            this.filters = {
                search: '',
                position: '',
                status: ''
            };
            this.officialsList = [];
            this.organizationData = null;
            this.init();
        }
        
        async init() {
            await this.loadOrganizationStats();
            await this.loadOrganizationData();
            await this.loadOfficials();
            this.setupFilters();
        }
        
        setupFilters() {
            document.getElementById('search-input').addEventListener('input', (e) => {
                this.filters.search = e.target.value;
                this.debounceSearch();
            });
            
            document.getElementById('position-filter').addEventListener('change', (e) => {
                this.filters.position = e.target.value;
                this.currentPage = 1;
                this.loadOfficials();
            });
            
            document.getElementById('status-filter').addEventListener('change', (e) => {
                this.filters.status = e.target.value;
                this.currentPage = 1;
                this.loadOfficials();
            });
        }
        
        debounceSearch() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.currentPage = 1;
                this.loadOfficials();
            }, 500);
        }
        
        async loadOrganizationStats() {
            try {
                const data = await apiCall('/pulosarok/village-profile/api/organization/stats/');
                this.renderOrganizationStats(data);
                this.renderPositionChart(data);
                this.renderAgeChart(data);
            } catch (error) {
                console.error('Error loading organization stats:', error);
                this.renderDefaultStats();
            }
        }
        
        renderOrganizationStats(data) {
            const stats = data.stats || {};
            const container = document.getElementById('org-stats');
            
            const statsData = [
                { icon: 'fas fa-users', label: 'Total Pejabat', value: stats.total || 0, color: 'blue' },
                { icon: 'fas fa-user-check', label: 'Pejabat Aktif', value: stats.active || 0, color: 'green' },
                { icon: 'fas fa-sitemap', label: 'Struktur Jabatan', value: stats.positions || 0, color: 'purple' },
                { icon: 'fas fa-calendar-alt', label: 'Rata-rata Masa Jabatan', value: `${stats.avg_tenure || 0} tahun`, color: 'orange' }
            ];
            
            container.innerHTML = statsData.map(stat => `
                <div class="bg-white rounded-lg shadow-lg p-6 text-center card-hover">
                    <div class="w-16 h-16 bg-${stat.color}-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="${stat.icon} text-${stat.color}-600 text-2xl"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-900 mb-2">${stat.label === 'Rata-rata Masa Jabatan' ? stat.value : formatNumber(stat.value)}</h3>
                    <p class="text-gray-600">${stat.label}</p>
                </div>
            `).join('');
        }
        
        renderDefaultStats() {
            const container = document.getElementById('org-stats');
            const statsData = [
                { icon: 'fas fa-users', label: 'Total Pejabat', value: 0, color: 'blue' },
                { icon: 'fas fa-user-check', label: 'Pejabat Aktif', value: 0, color: 'green' },
                { icon: 'fas fa-sitemap', label: 'Struktur Jabatan', value: 0, color: 'purple' },
                { icon: 'fas fa-calendar-alt', label: 'Rata-rata Masa Jabatan', value: '0 tahun', color: 'orange' }
            ];
            
            container.innerHTML = statsData.map(stat => `
                <div class="bg-white rounded-lg shadow-lg p-6 text-center card-hover">
                    <div class="w-16 h-16 bg-${stat.color}-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="${stat.icon} text-${stat.color}-600 text-2xl"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-900 mb-2">${stat.value}</h3>
                    <p class="text-gray-600">${stat.label}</p>
                </div>
            `).join('');
        }
        
        async loadOrganizationData() {
            try {
                const data = await apiCall('/pulosarok/village-profile/api/organization/');
                this.organizationData = data;
                this.renderOrganizationChart();
                this.renderInteractiveChart();
            } catch (error) {
                console.error('Error loading organization data:', error);
                this.renderDefaultChart();
            }
        }
        
        renderOrganizationChart() {
            const container = document.getElementById('organization-chart');
            
            if (!this.organizationData || !this.organizationData.results) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Data organisasi tidak tersedia</div>';
                return;
            }
            
            // Create hierarchical structure
            const hierarchy = this.buildHierarchy(this.organizationData.results);
            
            container.innerHTML = `
                <div class="org-chart">
                    ${this.renderHierarchyLevel(hierarchy, 0)}
                </div>
                <div class="text-center mt-8">
                    <button onclick="showFullChart()" class="bg-primary-600 text-white px-6 py-2 rounded-lg hover:bg-primary-700 transition-colors">
                        <i class="fas fa-expand mr-2"></i>Lihat Bagan Lengkap
                    </button>
                </div>
            `;
        }
        
        buildHierarchy(officials) {
            const hierarchy = {};
            const levels = {
                'kepala_desa': 1,
                'sekretaris_desa': 2,
                'kaur': 3,
                'kasi': 3,
                'kadus': 4,
                'rt': 5,
                'rw': 5,
                'bpd': 2,
                'pkk': 4,
                'karang_taruna': 4
            };
            
            officials.forEach(official => {
                const level = levels[official.jabatan] || 6;
                if (!hierarchy[level]) {
                    hierarchy[level] = [];
                }
                hierarchy[level].push(official);
            });
            
            return hierarchy;
        }
        
        renderHierarchyLevel(hierarchy, maxLevel = 3) {
            let html = '';
            
            for (let level = 1; level <= maxLevel; level++) {
                if (hierarchy[level] && hierarchy[level].length > 0) {
                    html += `
                        <div class="org-level level-${level} mb-8">
                            <div class="flex flex-wrap justify-center gap-4">
                                ${hierarchy[level].map(official => `
                                    <div class="org-card bg-white rounded-lg shadow-md p-4 text-center cursor-pointer hover:shadow-lg transition-shadow" 
                                         onclick="showOfficialDetail(${official.id})">
                                        <div class="w-16 h-16 bg-gray-200 rounded-full mx-auto mb-3 overflow-hidden">
                                            ${official.foto ? `
                                                <img src="${official.foto}" alt="${official.nama}" class="w-full h-full object-cover">
                                            ` : `
                                                <div class="w-full h-full flex items-center justify-center text-gray-400">
                                                    <i class="fas fa-user text-xl"></i>
                                                </div>
                                            `}
                                        </div>
                                        <h4 class="font-semibold text-gray-900 text-sm mb-1">${official.nama}</h4>
                                        <p class="text-xs text-gray-600">${this.getPositionLabel(official.jabatan)}</p>
                                        <div class="mt-2">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs ${this.getStatusColor(official.status)}">
                                                ${this.getStatusLabel(official.status)}
                                            </span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            return html;
        }
        
        renderDefaultChart() {
            const container = document.getElementById('organization-chart');
            container.innerHTML = '<div class="text-center text-gray-500 py-8">Gagal memuat bagan organisasi</div>';
        }
        
        renderInteractiveChart() {
            const container = document.getElementById('interactive-chart');
            
            if (!this.organizationData || !this.organizationData.results) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Data tidak tersedia</div>';
                return;
            }
            
            const hierarchy = this.buildHierarchy(this.organizationData.results);
            
            container.innerHTML = `
                <div class="text-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Struktur Organisasi Interaktif</h3>
                    <p class="text-gray-600">Klik pada setiap pejabat untuk melihat detail</p>
                </div>
                <div class="org-interactive">
                    ${this.renderHierarchyLevel(hierarchy, 6)}
                </div>
            `;
        }
        
        async loadOfficials() {
            try {
                let url = `/pulosarok/village-profile/api/organization/?page=${this.currentPage}&page_size=${this.pageSize}`;
                
                if (this.filters.search) {
                    url += `&search=${encodeURIComponent(this.filters.search)}`;
                }
                if (this.filters.position) {
                    url += `&jabatan=${this.filters.position}`;
                }
                if (this.filters.status) {
                    url += `&status=${this.filters.status}`;
                }
                
                const data = await apiCall(url);
                this.officialsList = data.results || [];
                
                if (this.currentView === 'list') {
                    this.renderOfficialsList();
                    this.renderPagination(data);
                }
            } catch (error) {
                console.error('Error loading officials:', error);
                if (this.currentView === 'list') {
                    document.getElementById('officials-list').innerHTML = '<div class="col-span-3 text-center text-gray-500 py-8">Gagal memuat data pejabat</div>';
                }
            }
        }
        
        renderOfficialsList() {
            const container = document.getElementById('officials-list');
            
            if (this.officialsList.length === 0) {
                container.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-8">Tidak ada pejabat ditemukan</div>';
                return;
            }
            
            container.innerHTML = this.officialsList.map(official => `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden card-hover cursor-pointer" onclick="showOfficialDetail(${official.id})">
                    <div class="p-6 text-center">
                        <div class="w-24 h-24 bg-gray-200 rounded-full mx-auto mb-4 overflow-hidden">
                            ${official.foto ? `
                                <img src="${official.foto}" alt="${official.nama}" class="w-full h-full object-cover">
                            ` : `
                                <div class="w-full h-full flex items-center justify-center text-gray-400">
                                    <i class="fas fa-user text-2xl"></i>
                                </div>
                            `}
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${official.nama}</h3>
                        <p class="text-gray-600 mb-3">${this.getPositionLabel(official.jabatan)}</p>
                        
                        <div class="space-y-2 text-sm text-gray-500 mb-4">
                            ${official.nip ? `
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-id-card mr-2"></i>
                                    <span>NIP: ${official.nip}</span>
                                </div>
                            ` : ''}
                            ${official.pendidikan ? `
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-graduation-cap mr-2"></i>
                                    <span>${official.pendidikan}</span>
                                </div>
                            ` : ''}
                            ${official.masa_jabatan ? `
                                <div class="flex items-center justify-center">
                                    <i class="fas fa-calendar-alt mr-2"></i>
                                    <span>${official.masa_jabatan}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getStatusColor(official.status)}">
                                ${this.getStatusLabel(official.status)}
                            </span>
                            <button class="text-primary-600 hover:text-primary-800 font-medium text-sm">
                                Lihat Detail <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        renderPagination(data) {
            const container = document.getElementById('list-pagination');
            const totalPages = Math.ceil((data.count || 0) / this.pageSize);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = `
                <div class="flex justify-center space-x-2">
                    <button onclick="organizationPage.changePage(${this.currentPage - 1})" 
                            ${this.currentPage === 1 ? 'disabled' : ''} 
                            class="px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-left mr-2"></i>Sebelumnya
                    </button>
                    <span class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md">
                        ${this.currentPage} / ${totalPages}
                    </span>
                    <button onclick="organizationPage.changePage(${this.currentPage + 1})" 
                            ${this.currentPage === totalPages ? 'disabled' : ''} 
                            class="px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Selanjutnya<i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
            `;
        }
        
        changePage(page) {
            if (page < 1) return;
            this.currentPage = page;
            this.loadOfficials();
        }
        
        renderPositionChart(data) {
            const ctx = document.getElementById('positionChart').getContext('2d');
            const positions = data.positions || {};
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(positions).map(key => this.getPositionLabel(key)),
                    datasets: [{
                        data: Object.values(positions),
                        backgroundColor: [
                            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4', '#84CC16', '#F97316'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        renderAgeChart(data) {
            const ctx = document.getElementById('ageChart').getContext('2d');
            const ageGroups = data.age_groups || {};
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['20-30', '31-40', '41-50', '51-60', '60+'],
                    datasets: [{
                        label: 'Jumlah Pejabat',
                        data: [
                            ageGroups['20-30'] || 0,
                            ageGroups['31-40'] || 0,
                            ageGroups['41-50'] || 0,
                            ageGroups['51-60'] || 0,
                            ageGroups['60+'] || 0
                        ],
                        backgroundColor: '#0EA5E9',
                        borderColor: '#0284C7',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        getPositionLabel(position) {
            const positions = {
                'kepala_desa': 'Kepala Desa',
                'sekretaris_desa': 'Sekretaris Desa',
                'kaur': 'Kepala Urusan',
                'kasi': 'Kepala Seksi',
                'kadus': 'Kepala Dusun',
                'rt': 'Ketua RT',
                'rw': 'Ketua RW',
                'bpd': 'BPD',
                'pkk': 'PKK',
                'karang_taruna': 'Karang Taruna'
            };
            return positions[position] || 'Lainnya';
        }
        
        getStatusLabel(status) {
            const statuses = {
                'aktif': 'Aktif',
                'nonaktif': 'Non-aktif',
                'cuti': 'Cuti'
            };
            return statuses[status] || 'Tidak Diketahui';
        }
        
        getStatusColor(status) {
            const colors = {
                'aktif': 'bg-green-100 text-green-800',
                'nonaktif': 'bg-red-100 text-red-800',
                'cuti': 'bg-yellow-100 text-yellow-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }
    }
    
    function toggleView(view) {
        const chartView = document.getElementById('chart-view');
        const listView = document.getElementById('list-view');
        const chartBtn = document.getElementById('chart-btn');
        const listBtn = document.getElementById('list-btn');
        
        if (view === 'chart') {
            chartView.classList.remove('hidden');
            listView.classList.add('hidden');
            chartBtn.classList.add('bg-primary-600', 'text-white');
            chartBtn.classList.remove('bg-gray-200', 'text-gray-700');
            listBtn.classList.add('bg-gray-200', 'text-gray-700');
            listBtn.classList.remove('bg-primary-600', 'text-white');
        } else {
            chartView.classList.add('hidden');
            listView.classList.remove('hidden');
            listBtn.classList.add('bg-primary-600', 'text-white');
            listBtn.classList.remove('bg-gray-200', 'text-gray-700');
            chartBtn.classList.add('bg-gray-200', 'text-gray-700');
            chartBtn.classList.remove('bg-primary-600', 'text-white');
        }
        
        organizationPage.currentView = view;
        if (view === 'list') {
            organizationPage.loadOfficials();
        }
    }
    
    async function showOfficialDetail(officialId) {
        try {
            const official = await apiCall(`/pulosarok/village-profile/api/organization/${officialId}/`);
            
            document.getElementById('official-modal-title').textContent = official.nama;
            document.getElementById('official-modal-content').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">
                        <div class="text-center">
                            <div class="w-48 h-48 bg-gray-200 rounded-lg mx-auto mb-4 overflow-hidden">
                                ${official.foto ? `
                                    <img src="${official.foto}" alt="${official.nama}" class="w-full h-full object-cover">
                                ` : `
                                    <div class="w-full h-full flex items-center justify-center text-gray-400">
                                        <i class="fas fa-user text-6xl"></i>
                                    </div>
                                `}
                            </div>
                            <div class="space-y-2">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${organizationPage.getStatusColor(official.status)}">
                                    ${organizationPage.getStatusLabel(official.status)}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-2">
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-3">Informasi Jabatan</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-600">Jabatan:</span>
                                        <p class="font-medium">${organizationPage.getPositionLabel(official.jabatan)}</p>
                                    </div>
                                    ${official.nip ? `
                                        <div>
                                            <span class="text-gray-600">NIP:</span>
                                            <p class="font-medium">${official.nip}</p>
                                        </div>
                                    ` : ''}
                                    ${official.masa_jabatan ? `
                                        <div>
                                            <span class="text-gray-600">Masa Jabatan:</span>
                                            <p class="font-medium">${official.masa_jabatan}</p>
                                        </div>
                                    ` : ''}
                                    ${official.sk_pengangkatan ? `
                                        <div>
                                            <span class="text-gray-600">SK Pengangkatan:</span>
                                            <p class="font-medium">${official.sk_pengangkatan}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-3">Informasi Pribadi</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    ${official.tempat_lahir || official.tanggal_lahir ? `
                                        <div>
                                            <span class="text-gray-600">Tempat, Tanggal Lahir:</span>
                                            <p class="font-medium">${official.tempat_lahir || ''}, ${official.tanggal_lahir ? formatDate(official.tanggal_lahir) : ''}</p>
                                        </div>
                                    ` : ''}
                                    ${official.jenis_kelamin ? `
                                        <div>
                                            <span class="text-gray-600">Jenis Kelamin:</span>
                                            <p class="font-medium">${official.jenis_kelamin === 'L' ? 'Laki-laki' : 'Perempuan'}</p>
                                        </div>
                                    ` : ''}
                                    ${official.agama ? `
                                        <div>
                                            <span class="text-gray-600">Agama:</span>
                                            <p class="font-medium">${official.agama}</p>
                                        </div>
                                    ` : ''}
                                    ${official.pendidikan ? `
                                        <div>
                                            <span class="text-gray-600">Pendidikan:</span>
                                            <p class="font-medium">${official.pendidikan}</p>
                                        </div>
                                    ` : ''}
                                    ${official.alamat ? `
                                        <div class="md:col-span-2">
                                            <span class="text-gray-600">Alamat:</span>
                                            <p class="font-medium">${official.alamat}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            ${official.kontak ? `
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-3">Kontak</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        ${official.kontak.telepon ? `
                                            <div class="flex items-center">
                                                <i class="fas fa-phone text-gray-400 mr-2"></i>
                                                <span>${official.kontak.telepon}</span>
                                            </div>
                                        ` : ''}
                                        ${official.kontak.email ? `
                                            <div class="flex items-center">
                                                <i class="fas fa-envelope text-gray-400 mr-2"></i>
                                                <span>${official.kontak.email}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${official.tugas_pokok && official.tugas_pokok.length > 0 ? `
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-3">Tugas Pokok</h4>
                                    <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                                        ${official.tugas_pokok.map(task => `<li>${task}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${official.prestasi && official.prestasi.length > 0 ? `
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-3">Prestasi</h4>
                                    <div class="space-y-2">
                                        ${official.prestasi.map(achievement => `
                                            <div class="flex items-start text-sm">
                                                <i class="fas fa-trophy text-yellow-500 mr-2 mt-1"></i>
                                                <span class="text-gray-700">${achievement}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            openModal('official-modal');
        } catch (error) {
            console.error('Error loading official detail:', error);
        }
    }
    
    function showFullChart() {
        if (!organizationPage.organizationData) return;
        
        const hierarchy = organizationPage.buildHierarchy(organizationPage.organizationData.results);
        
        document.getElementById('chart-modal-content').innerHTML = `
            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900 mb-2">Struktur Organisasi Lengkap</h3>
                <p class="text-gray-600">Pemerintahan Desa Pulosarok</p>
            </div>
            <div class="org-chart-full">
                ${organizationPage.renderHierarchyLevel(hierarchy, 6)}
            </div>
        `;
        
        openModal('chart-modal');
    }
    
    // Initialize organization page
    let organizationPage;
    document.addEventListener('DOMContentLoaded', function() {
        organizationPage = new OrganizationPage();
    });
</script>

<style>
.org-chart .org-level {
    position: relative;
}

.org-chart .org-level:not(:last-child)::after {
    content: '';
    position: absolute;
    bottom: -20px;
    left: 50%;
    transform: translateX(-50%);
    width: 2px;
    height: 20px;
    background-color: #d1d5db;
}

.org-card {
    min-width: 160px;
    max-width: 200px;
}

.line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}
