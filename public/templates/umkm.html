{% extends 'public/base.html' %}

{% block title %}UMKM Desa - Website Desa Pulosarok{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="hero-gradient text-white py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4 fade-in">UMKM Desa Pulosarok</h1>
            <p class="text-xl opacity-90 fade-in">Usaha Mikro Kecil dan Menengah Unggulan Desa Pulosarok</p>
        </div>
    </div>
</section>

<!-- UMKM Overview -->
<section class="py-16 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">Statistik UMKM</h2>
            <p class="text-gray-600 max-w-2xl mx-auto">Data dan informasi terkini mengenai perkembangan UMKM di Desa Pulosarok</p>
        </div>
        
        <div id="umkm-stats" class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-12">
            <!-- Stats will be loaded here -->
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">UMKM per Kategori</h3>
                <canvas id="categoryChart" width="400" height="300"></canvas>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-900 mb-4">Perkembangan UMKM</h3>
                <canvas id="growthChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
</section>

<!-- Filter Section -->
<section class="py-8 bg-gray-50 border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
            <div class="flex flex-col sm:flex-row gap-4 flex-1">
                <div class="flex-1">
                    <input type="text" id="search-input" placeholder="Cari UMKM..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                </div>
                
                <select id="category-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Semua Kategori</option>
                    <option value="kuliner">Kuliner</option>
                    <option value="kerajinan">Kerajinan</option>
                    <option value="pertanian">Pertanian</option>
                    <option value="peternakan">Peternakan</option>
                    <option value="perdagangan">Perdagangan</option>
                    <option value="jasa">Jasa</option>
                    <option value="teknologi">Teknologi</option>
                    <option value="fashion">Fashion</option>
                </select>
                
                <select id="status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Semua Status</option>
                    <option value="aktif">Aktif</option>
                    <option value="berkembang">Berkembang</option>
                    <option value="baru">Baru</option>
                </select>
                
                <select id="sort-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <option value="-tanggal_daftar">Terbaru</option>
                    <option value="tanggal_daftar">Terlama</option>
                    <option value="nama_usaha">A-Z</option>
                    <option value="-nama_usaha">Z-A</option>
                    <option value="-omzet">Omzet Tertinggi</option>
                </select>
            </div>
            
            <div class="flex gap-2">
                <button onclick="toggleView('grid')" id="grid-btn" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                    <i class="fas fa-th-large mr-2"></i>Grid
                </button>
                <button onclick="toggleView('list')" id="list-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                    <i class="fas fa-list mr-2"></i>List
                </button>
            </div>
        </div>
    </div>
</section>

<!-- UMKM Grid View -->
<section id="grid-view" class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div id="umkm-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- UMKM grid will be loaded here -->
        </div>
        
        <!-- Pagination -->
        <div id="grid-pagination" class="flex items-center justify-center mt-12">
            <!-- Pagination will be loaded here -->
        </div>
    </div>
</section>

<!-- UMKM List View -->
<section id="list-view" class="py-16 bg-gray-50 hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div id="umkm-list" class="space-y-6">
                <!-- UMKM list will be loaded here -->
            </div>
            
            <!-- Pagination -->
            <div id="list-pagination" class="flex items-center justify-between mt-8">
                <!-- Pagination will be loaded here -->
            </div>
        </div>
    </div>
</section>

<!-- Featured UMKM -->
<section class="py-16 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">UMKM Unggulan</h2>
            <p class="text-gray-600">UMKM dengan performa terbaik dan produk unggulan</p>
        </div>
        
        <div id="featured-umkm" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Featured UMKM will be loaded here -->
        </div>
    </div>
</section>

<!-- UMKM Detail Modal -->
<div id="umkm-modal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-6xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="umkm-modal-title" class="text-2xl font-bold text-gray-900"></h2>
                    <button onclick="closeModal('umkm-modal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="umkm-modal-content">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Gallery Modal -->
<div id="product-gallery-modal" class="fixed inset-0 bg-black bg-opacity-90 modal hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative max-w-4xl w-full">
            <button onclick="closeModal('product-gallery-modal')" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <div id="product-gallery-content" class="text-center">
                <!-- Gallery content will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    class UMKMPage {
        constructor() {
            this.currentView = 'grid';
            this.currentPage = 1;
            this.pageSize = 12;
            this.filters = {
                search: '',
                category: '',
                status: '',
                sort: '-created_at'
            };
            this.umkmList = [];
            this.init();
        }
        
        async init() {
            await this.loadUMKMStats();
            await this.loadUMKM();
            await this.loadFeaturedUMKM();
            this.setupFilters();
        }
        
        setupFilters() {
            document.getElementById('search-input').addEventListener('input', (e) => {
                this.filters.search = e.target.value;
                this.debounceSearch();
            });
            
            document.getElementById('category-filter').addEventListener('change', (e) => {
                this.filters.category = e.target.value;
                this.currentPage = 1;
                this.loadUMKM();
            });
            
            document.getElementById('status-filter').addEventListener('change', (e) => {
                this.filters.status = e.target.value;
                this.currentPage = 1;
                this.loadUMKM();
            });
            
            document.getElementById('sort-filter').addEventListener('change', (e) => {
                this.filters.sort = e.target.value;
                this.currentPage = 1;
                this.loadUMKM();
            });
        }
        
        debounceSearch() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.currentPage = 1;
                this.loadUMKM();
            }, 500);
        }
        
        async loadUMKMStats() {
            try {
                const data = await apiCall('/pulosarok/business/api/stats/');
                this.renderUMKMStats(data);
                this.renderCategoryChart(data);
                this.renderGrowthChart(data);
            } catch (error) {
                console.error('Error loading UMKM stats:', error);
                this.renderDefaultStats();
            }
        }
        
        renderUMKMStats(data) {
            const stats = data.stats || {};
            const container = document.getElementById('umkm-stats');
            
            const statsData = [
                { icon: 'fas fa-store', label: 'Total UMKM', value: stats.total || 0, color: 'blue' },
                { icon: 'fas fa-chart-line', label: 'UMKM Aktif', value: stats.active || 0, color: 'green' },
                { icon: 'fas fa-users', label: 'Total Pekerja', value: stats.total_workers || 0, color: 'purple' },
                { icon: 'fas fa-money-bill-wave', label: 'Omzet Bulanan', value: `Rp ${formatNumber(stats.total_revenue || 0)}`, color: 'orange' }
            ];
            
            container.innerHTML = statsData.map(stat => `
                <div class="bg-white rounded-lg shadow-lg p-6 text-center card-hover">
                    <div class="w-16 h-16 bg-${stat.color}-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="${stat.icon} text-${stat.color}-600 text-2xl"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-900 mb-2">${stat.label === 'Omzet Bulanan' ? stat.value : formatNumber(stat.value)}</h3>
                    <p class="text-gray-600">${stat.label}</p>
                </div>
            `).join('');
        }
        
        renderDefaultStats() {
            const container = document.getElementById('umkm-stats');
            const statsData = [
                { icon: 'fas fa-store', label: 'Total UMKM', value: 0, color: 'blue' },
                { icon: 'fas fa-chart-line', label: 'UMKM Aktif', value: 0, color: 'green' },
                { icon: 'fas fa-users', label: 'Total Pekerja', value: 0, color: 'purple' },
                { icon: 'fas fa-money-bill-wave', label: 'Omzet Bulanan', value: 'Rp 0', color: 'orange' }
            ];
            
            container.innerHTML = statsData.map(stat => `
                <div class="bg-white rounded-lg shadow-lg p-6 text-center card-hover">
                    <div class="w-16 h-16 bg-${stat.color}-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="${stat.icon} text-${stat.color}-600 text-2xl"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-900 mb-2">${stat.value}</h3>
                    <p class="text-gray-600">${stat.label}</p>
                </div>
            `).join('');
        }
        
        async loadUMKM() {
            try {
                let url = `/pulosarok/business/api/businesses/?page=${this.currentPage}&page_size=${this.pageSize}&ordering=${this.filters.sort}`;
                
                if (this.filters.search) {
                    url += `&search=${encodeURIComponent(this.filters.search)}`;
                }
                if (this.filters.category) {
                    url += `&kategori=${this.filters.category}`;
                }
                if (this.filters.status) {
                    url += `&status=${this.filters.status}`;
                }
                
                const data = await apiCall(url);
                this.umkmList = data.results || [];
                
                if (this.currentView === 'grid') {
                    this.renderUMKMGrid();
                    this.renderPagination(data, 'grid-pagination');
                } else {
                    this.renderUMKMList();
                    this.renderPagination(data, 'list-pagination');
                }
            } catch (error) {
                console.error('Error loading UMKM:', error);
                const container = this.currentView === 'grid' ? 
                    document.getElementById('umkm-grid') : 
                    document.getElementById('umkm-list');
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Gagal memuat data UMKM</div>';
            }
        }
        
        renderUMKMGrid() {
            const container = document.getElementById('umkm-grid');
            
            if (this.umkmList.length === 0) {
                container.innerHTML = '<div class="col-span-3 text-center text-gray-500 py-8">Tidak ada UMKM ditemukan</div>';
                return;
            }
            
            container.innerHTML = this.umkmList.map(umkm => `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden card-hover cursor-pointer" onclick="showUMKMDetail(${umkm.id})">
                    <div class="aspect-video bg-gray-200 relative">
                        ${umkm.foto_produk && umkm.foto_produk.length > 0 ? `
                            <img src="${umkm.foto_produk[0]}" alt="${umkm.nama_usaha}" class="w-full h-full object-cover">
                        ` : `
                            <div class="w-full h-full flex items-center justify-center text-gray-400">
                                <i class="fas fa-store text-4xl"></i>
                            </div>
                        `}
                        <div class="absolute top-4 left-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
                                ${this.getCategoryLabel(umkm.kategori)}
                            </span>
                        </div>
                        <div class="absolute top-4 right-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getStatusColor(umkm.status)}">
                                ${this.getStatusLabel(umkm.status)}
                            </span>
                        </div>
                    </div>
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2 line-clamp-1">${umkm.nama_usaha}</h3>
                        <p class="text-gray-600 text-sm mb-3 line-clamp-1">${umkm.nama_pemilik}</p>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">${umkm.deskripsi || 'Deskripsi tidak tersedia'}</p>
                        
                        <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                            <div class="flex items-center">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                <span>${umkm.alamat || 'Alamat tidak tersedia'}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-users mr-2"></i>
                                <span>${umkm.jumlah_karyawan || 0} pekerja</span>
                            </div>
                        </div>
                        
                        ${umkm.produk_unggulan && umkm.produk_unggulan.length > 0 ? `
                            <div class="flex flex-wrap gap-1 mb-4">
                                ${umkm.produk_unggulan.slice(0, 2).map(product => `
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-700">
                                        ${product}
                                    </span>
                                `).join('')}
                                ${umkm.produk_unggulan.length > 2 ? `
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-700">
                                        +${umkm.produk_unggulan.length - 2} lainnya
                                    </span>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-500">
                                ${umkm.omzet_bulanan ? `
                                    <span class="font-medium text-green-600">Rp ${formatNumber(umkm.omzet_bulanan)}/bulan</span>
                                ` : 'Omzet tidak tersedia'}
                            </div>
                            <button class="text-primary-600 hover:text-primary-800 font-medium text-sm">
                                Lihat Detail <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        renderUMKMList() {
            const container = document.getElementById('umkm-list');
            
            if (this.umkmList.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Tidak ada UMKM ditemukan</div>';
                return;
            }
            
            container.innerHTML = this.umkmList.map(umkm => `
                <div class="flex gap-6 p-6 border border-gray-200 rounded-lg hover:shadow-md transition-shadow cursor-pointer" onclick="showUMKMDetail(${umkm.id})">
                    <div class="w-48 h-32 bg-gray-200 rounded-lg overflow-hidden flex-shrink-0">
                        ${umkm.foto_produk && umkm.foto_produk.length > 0 ? `
                            <img src="${umkm.foto_produk[0]}" alt="${umkm.nama_usaha}" class="w-full h-full object-cover">
                        ` : `
                            <div class="w-full h-full flex items-center justify-center text-gray-400">
                                <i class="fas fa-store text-2xl"></i>
                            </div>
                        `}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
                                    ${this.getCategoryLabel(umkm.kategori)}
                                </span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getStatusColor(umkm.status)}">
                                    ${this.getStatusLabel(umkm.status)}
                                </span>
                            </div>
                            <span class="text-sm text-gray-500">${formatDate(umkm.tanggal_daftar)}</span>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">${umkm.nama_usaha}</h3>
                        <p class="text-gray-600 mb-1">Pemilik: ${umkm.nama_pemilik}</p>
                        <p class="text-gray-600 mb-4 line-clamp-2">${umkm.deskripsi || 'Deskripsi tidak tersedia'}</p>
                        <div class="flex items-center justify-between text-sm text-gray-500">
                            <div class="flex items-center gap-4">
                                <div class="flex items-center">
                                    <i class="fas fa-map-marker-alt mr-2"></i>
                                    <span>${umkm.alamat || 'Alamat tidak tersedia'}</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-users mr-2"></i>
                                    <span>${umkm.jumlah_karyawan || 0} pekerja</span>
                                </div>
                                ${umkm.omzet_bulanan ? `
                                    <div class="flex items-center">
                                        <i class="fas fa-money-bill-wave mr-2"></i>
                                        <span class="font-medium text-green-600">Rp ${formatNumber(umkm.omzet_bulanan)}/bulan</span>
                                    </div>
                                ` : ''}
                            </div>
                            <button class="text-primary-600 hover:text-primary-800 font-medium">
                                Lihat Detail <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        renderPagination(data, containerId) {
            const container = document.getElementById(containerId);
            const totalPages = Math.ceil((data.count || 0) / this.pageSize);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            const isListView = containerId === 'list-pagination';
            
            if (isListView) {
                container.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-700">
                            Menampilkan ${((this.currentPage - 1) * this.pageSize) + 1} - ${Math.min(this.currentPage * this.pageSize, data.count)} dari ${data.count} UMKM
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="umkmPage.changePage(${this.currentPage - 1})" 
                                    ${this.currentPage === 1 ? 'disabled' : ''} 
                                    class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Sebelumnya
                            </button>
                            <span class="px-3 py-2 text-sm font-medium text-gray-700">
                                Halaman ${this.currentPage} dari ${totalPages}
                            </span>
                            <button onclick="umkmPage.changePage(${this.currentPage + 1})" 
                                    ${this.currentPage === totalPages ? 'disabled' : ''} 
                                    class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Selanjutnya
                            </button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="flex justify-center space-x-2">
                        <button onclick="umkmPage.changePage(${this.currentPage - 1})" 
                                ${this.currentPage === 1 ? 'disabled' : ''} 
                                class="px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-chevron-left mr-2"></i>Sebelumnya
                        </button>
                        <span class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md">
                            ${this.currentPage} / ${totalPages}
                        </span>
                        <button onclick="umkmPage.changePage(${this.currentPage + 1})" 
                                ${this.currentPage === totalPages ? 'disabled' : ''} 
                                class="px-4 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            Selanjutnya<i class="fas fa-chevron-right ml-2"></i>
                        </button>
                    </div>
                `;
            }
        }
        
        changePage(page) {
            if (page < 1) return;
            this.currentPage = page;
            this.loadUMKM();
        }
        
        async loadFeaturedUMKM() {
            try {
                const data = await apiCall('/pulosarok/business/api/businesses/?featured=true&page_size=2');
                this.renderFeaturedUMKM(data.results || []);
            } catch (error) {
                console.error('Error loading featured UMKM:', error);
            }
        }
        
        renderFeaturedUMKM(umkmList) {
            const container = document.getElementById('featured-umkm');
            
            if (umkmList.length === 0) {
                container.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-8">Belum ada UMKM unggulan</div>';
                return;
            }
            
            container.innerHTML = umkmList.map((umkm, index) => `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden card-hover cursor-pointer" onclick="showUMKMDetail(${umkm.id})">
                    <div class="${index === 0 ? 'lg:flex' : ''}">
                        <div class="${index === 0 ? 'lg:w-1/2' : ''} aspect-video bg-gray-200">
                            ${umkm.foto_produk && umkm.foto_produk.length > 0 ? `
                                <img src="${umkm.foto_produk[0]}" alt="${umkm.nama_usaha}" class="w-full h-full object-cover">
                            ` : `
                                <div class="w-full h-full flex items-center justify-center text-gray-400">
                                    <i class="fas fa-store text-4xl"></i>
                                </div>
                            `}
                        </div>
                        <div class="${index === 0 ? 'lg:w-1/2' : ''} p-6">
                            <div class="flex items-center justify-between mb-3">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-100 text-primary-800">
                                    ${this.getCategoryLabel(umkm.kategori)}
                                </span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${this.getStatusColor(umkm.status)}">
                                    ${this.getStatusLabel(umkm.status)}
                                </span>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-2">${umkm.nama_usaha}</h3>
                            <p class="text-gray-600 mb-1">Pemilik: ${umkm.nama_pemilik}</p>
                            <p class="text-gray-600 mb-4 line-clamp-3">${umkm.deskripsi || 'Deskripsi tidak tersedia'}</p>
                            <div class="flex items-center text-sm text-gray-500 mb-4">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                <span>${umkm.alamat || 'Alamat tidak tersedia'}</span>
                                <span class="mx-2">â€¢</span>
                                <i class="fas fa-users mr-2"></i>
                                <span>${umkm.jumlah_karyawan || 0} pekerja</span>
                            </div>
                            ${umkm.produk_unggulan && umkm.produk_unggulan.length > 0 ? `
                                <div class="flex flex-wrap gap-1">
                                    ${umkm.produk_unggulan.slice(0, 3).map(product => `
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-700">
                                            ${product}
                                        </span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        renderCategoryChart(data) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const categories = data.categories || {};
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories).map(key => this.getCategoryLabel(key)),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: [
                            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4', '#84CC16', '#F97316'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        renderGrowthChart(data) {
            const ctx = document.getElementById('growthChart').getContext('2d');
            const growth = data.growth || {};
            
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            const growthData = months.map((month, index) => growth[index + 1] || 0);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Jumlah UMKM Baru',
                        data: growthData,
                        borderColor: '#0EA5E9',
                        backgroundColor: 'rgba(14, 165, 233, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        getCategoryLabel(category) {
            const categories = {
                'kuliner': 'Kuliner',
                'kerajinan': 'Kerajinan',
                'pertanian': 'Pertanian',
                'peternakan': 'Peternakan',
                'perdagangan': 'Perdagangan',
                'jasa': 'Jasa',
                'teknologi': 'Teknologi',
                'fashion': 'Fashion'
            };
            return categories[category] || 'Lainnya';
        }
        
        getStatusLabel(status) {
            const statuses = {
                'aktif': 'Aktif',
                'berkembang': 'Berkembang',
                'baru': 'Baru',
                'nonaktif': 'Non-aktif'
            };
            return statuses[status] || 'Tidak Diketahui';
        }
        
        getStatusColor(status) {
            const colors = {
                'aktif': 'bg-green-100 text-green-800',
                'berkembang': 'bg-blue-100 text-blue-800',
                'baru': 'bg-yellow-100 text-yellow-800',
                'nonaktif': 'bg-red-100 text-red-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }
    }
    
    function toggleView(view) {
        const gridView = document.getElementById('grid-view');
        const listView = document.getElementById('list-view');
        const gridBtn = document.getElementById('grid-btn');
        const listBtn = document.getElementById('list-btn');
        
        if (view === 'grid') {
            gridView.classList.remove('hidden');
            listView.classList.add('hidden');
            gridBtn.classList.add('bg-primary-600', 'text-white');
            gridBtn.classList.remove('bg-gray-200', 'text-gray-700');
            listBtn.classList.add('bg-gray-200', 'text-gray-700');
            listBtn.classList.remove('bg-primary-600', 'text-white');
        } else {
            gridView.classList.add('hidden');
            listView.classList.remove('hidden');
            listBtn.classList.add('bg-primary-600', 'text-white');
            listBtn.classList.remove('bg-gray-200', 'text-gray-700');
            gridBtn.classList.add('bg-gray-200', 'text-gray-700');
            gridBtn.classList.remove('bg-primary-600', 'text-white');
        }
        
        umkmPage.currentView = view;
        umkmPage.loadUMKM();
    }
    
    async function showUMKMDetail(umkmId) {
        try {
            const umkm = await apiCall(`/pulosarok/business/api/businesses/${umkmId}/`);
            
            document.getElementById('umkm-modal-title').textContent = umkm.nama_usaha;
            document.getElementById('umkm-modal-content').innerHTML = `
                <div class="space-y-6">
                    ${umkm.foto_produk && umkm.foto_produk.length > 0 ? `
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${umkm.foto_produk.slice(0, 4).map((photo, index) => `
                                <div class="aspect-square bg-gray-200 rounded-lg overflow-hidden cursor-pointer hover:opacity-90 transition-opacity" 
                                     onclick="showProductGallery('${photo}', '${umkm.nama_usaha}')">
                                    <img src="${photo}" alt="${umkm.nama_usaha}" class="w-full h-full object-cover">
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-2">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary-100 text-primary-800">
                                        ${umkmPage.getCategoryLabel(umkm.kategori)}
                                    </span>
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${umkmPage.getStatusColor(umkm.status)}">
                                        ${umkmPage.getStatusLabel(umkm.status)}
                                    </span>
                                </div>
                                <span class="text-sm text-gray-500">Terdaftar: ${formatDate(umkm.tanggal_daftar)}</span>
                            </div>
                            
                            <div class="prose max-w-none mb-6">
                                <p class="text-gray-700">${umkm.deskripsi || 'Deskripsi tidak tersedia.'}</p>
                            </div>
                            
                            ${umkm.produk_unggulan && umkm.produk_unggulan.length > 0 ? `
                                <div class="mb-6">
                                    <h4 class="font-semibold text-gray-900 mb-3">Produk Unggulan</h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${umkm.produk_unggulan.map(product => `
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">
                                                ${product}
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${umkm.sertifikat && umkm.sertifikat.length > 0 ? `
                                <div class="mb-6">
                                    <h4 class="font-semibold text-gray-900 mb-3">Sertifikat</h4>
                                    <div class="space-y-2">
                                        ${umkm.sertifikat.map(cert => `
                                            <div class="flex items-center text-sm text-gray-700">
                                                <i class="fas fa-certificate text-yellow-500 mr-2"></i>
                                                <span>${cert}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="lg:col-span-1">
                            <div class="bg-gray-50 rounded-lg p-4 space-y-4">
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-2">Informasi Pemilik</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex items-start">
                                            <i class="fas fa-user text-gray-400 mr-2 mt-1"></i>
                                            <span class="text-gray-700">${umkm.nama_pemilik}</span>
                                        </div>
                                        <div class="flex items-start">
                                            <i class="fas fa-map-marker-alt text-gray-400 mr-2 mt-1"></i>
                                            <span class="text-gray-700">${umkm.alamat || 'Alamat tidak tersedia'}</span>
                                        </div>
                                        ${umkm.kontak ? `
                                            ${umkm.kontak.telepon ? `
                                                <div class="flex items-center">
                                                    <i class="fas fa-phone text-gray-400 mr-2"></i>
                                                    <span class="text-gray-700">${umkm.kontak.telepon}</span>
                                                </div>
                                            ` : ''}
                                            ${umkm.kontak.whatsapp ? `
                                                <div class="flex items-center">
                                                    <i class="fab fa-whatsapp text-gray-400 mr-2"></i>
                                                    <span class="text-gray-700">${umkm.kontak.whatsapp}</span>
                                                </div>
                                            ` : ''}
                                            ${umkm.kontak.email ? `
                                                <div class="flex items-center">
                                                    <i class="fas fa-envelope text-gray-400 mr-2"></i>
                                                    <span class="text-gray-700">${umkm.kontak.email}</span>
                                                </div>
                                            ` : ''}
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 class="font-semibold text-gray-900 mb-2">Statistik Usaha</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex items-center justify-between">
                                            <span class="text-gray-600">Jumlah Karyawan</span>
                                            <span class="font-medium">${umkm.jumlah_karyawan || 0} orang</span>
                                        </div>
                                        ${umkm.omzet_bulanan ? `
                                            <div class="flex items-center justify-between">
                                                <span class="text-gray-600">Omzet Bulanan</span>
                                                <span class="font-medium text-green-600">Rp ${formatNumber(umkm.omzet_bulanan)}</span>
                                            </div>
                                        ` : ''}
                                        ${umkm.modal_awal ? `
                                            <div class="flex items-center justify-between">
                                                <span class="text-gray-600">Modal Awal</span>
                                                <span class="font-medium">Rp ${formatNumber(umkm.modal_awal)}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <div class="pt-4 border-t">
                                    <button onclick="shareUMKM('${umkm.nama_usaha}', window.location.href)" 
                                            class="w-full bg-primary-600 text-white py-2 px-4 rounded-lg hover:bg-primary-700 transition-colors mb-2">
                                        <i class="fas fa-share-alt mr-2"></i>Bagikan
                                    </button>
                                    ${umkm.kontak && umkm.kontak.whatsapp ? `
                                        <button onclick="contactUMKM('${umkm.kontak.whatsapp}', '${umkm.nama_usaha}')" 
                                                class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                                            <i class="fab fa-whatsapp mr-2"></i>Hubungi via WhatsApp
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            openModal('umkm-modal');
        } catch (error) {
            console.error('Error loading UMKM detail:', error);
        }
    }
    
    function showProductGallery(imageUrl, title) {
        document.getElementById('product-gallery-content').innerHTML = `
            <div class="space-y-4">
                <img src="${imageUrl}" alt="${title}" class="max-w-full max-h-96 mx-auto rounded-lg">
                <div class="text-white text-center">
                    <h3 class="text-xl font-semibold">${title}</h3>
                </div>
            </div>
        `;
        openModal('product-gallery-modal');
    }
    
    function shareUMKM(name, url) {
        if (navigator.share) {
            navigator.share({
                title: `UMKM ${name} - Desa Pulosarok`,
                url: url
            }).catch(console.error);
        } else {
            navigator.clipboard.writeText(url).then(() => {
                alert('Link berhasil disalin!');
            }).catch(() => {
                alert('Gagal menyalin link');
            });
        }
    }
    
    function contactUMKM(whatsapp, name) {
        const message = encodeURIComponent(`Halo, saya tertarik dengan produk dari UMKM ${name}. Bisa minta informasi lebih lanjut?`);
        window.open(`https://wa.me/${whatsapp}?text=${message}`, '_blank');
    }
    
    // Initialize UMKM page
    let umkmPage;
    document.addEventListener('DOMContentLoaded', function() {
        umkmPage = new UMKMPage();
    });
</script>
{% endblock %}
