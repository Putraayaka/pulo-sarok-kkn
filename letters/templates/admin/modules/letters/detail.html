{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Letter Detail - {{ letter.subject }} - {{ block.super }}{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <style>
        .letter-detail-container {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .letter-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px 10px 0 0;
            position: relative;
            overflow: hidden;
        }
        
        .letter-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.1);
            transform: rotate(45deg);
        }
        
        .letter-header h1 {
            margin: 0;
            font-size: 1.8em;
            position: relative;
            z-index: 1;
        }
        
        .letter-meta {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            position: relative;
            z-index: 1;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .letter-content {
            padding: 30px;
        }
        
        .info-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .info-section h4 {
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #6c757d;
        }
        
        .info-value {
            color: #495057;
        }
        
        .status-badge {
            padding: 6px 15px;
            border-radius: 25px;
            font-size: 0.85em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-draft {
            background: #6c757d;
            color: white;
        }
        
        .status-submitted {
            background: #007bff;
            color: white;
        }
        
        .status-approved {
            background: #28a745;
            color: white;
        }
        
        .status-rejected {
            background: #dc3545;
            color: white;
        }
        
        .status-completed {
            background: #17a2b8;
            color: white;
        }
        
        .priority-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .priority-low {
            background: #d4edda;
            color: #155724;
        }
        
        .priority-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .priority-high {
            background: #f8d7da;
            color: #721c24;
        }
        
        .letter-preview {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
        }
        
        .letterhead {
            text-align: center;
            border-bottom: 3px solid #007bff;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .letterhead h2 {
            margin: 0;
            color: #007bff;
            font-size: 1.5em;
        }
        
        .letterhead p {
            margin: 5px 0;
            color: #6c757d;
        }
        
        .letter-number {
            text-align: right;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .letter-subject {
            text-align: center;
            font-weight: bold;
            margin: 20px 0;
            text-decoration: underline;
        }
        
        .letter-body {
            text-align: justify;
            margin: 20px 0;
        }
        
        .signature-section {
            margin-top: 40px;
            text-align: right;
        }
        
        .signature-info {
            margin-bottom: 60px;
        }
        
        .signature-name {
            font-weight: bold;
            border-bottom: 1px solid #000;
            display: inline-block;
            min-width: 200px;
            text-align: center;
        }
        
        .action-buttons {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 0 0 10px 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .action-buttons .btn {
            min-width: 120px;
        }
        
        .tracking-timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .tracking-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #007bff;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #007bff;
        }
        
        .timeline-item.completed::before {
            background: #28a745;
            box-shadow: 0 0 0 2px #28a745;
        }
        
        .timeline-item.rejected::before {
            background: #dc3545;
            box-shadow: 0 0 0 2px #dc3545;
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .timeline-title {
            font-weight: bold;
            color: #495057;
        }
        
        .timeline-time {
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .timeline-description {
            color: #6c757d;
            margin-bottom: 8px;
        }
        
        .timeline-user {
            font-size: 0.85em;
            color: #007bff;
        }
        
        .attachments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .attachment-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .attachment-card:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0,123,255,0.2);
        }
        
        .attachment-icon {
            font-size: 2em;
            margin-bottom: 10px;
            color: #007bff;
        }
        
        .attachment-name {
            font-weight: bold;
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .attachment-size {
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .ai-validation-result {
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .ai-validation-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .ai-validation-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .ai-validation-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .ai-suggestions {
            margin-top: 15px;
        }
        
        .ai-suggestion {
            background: rgba(255,255,255,0.8);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 4px solid #007bff;
        }
        
        .digital-signature {
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 15px;
            background: #d4edda;
            text-align: center;
            margin: 20px 0;
        }
        
        .signature-valid {
            color: #155724;
        }
        
        .signature-invalid {
            border-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        
        .qr-code {
            text-align: center;
            margin: 20px 0;
        }
        
        .qr-code img {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .print-only {
            display: none;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block;
            }
            
            .letter-detail-container {
                box-shadow: none;
                border: none;
            }
            
            .letter-header {
                background: white !important;
                color: black !important;
                border-bottom: 2px solid #000;
            }
            
            .letter-preview {
                border: none;
                box-shadow: none;
                padding: 0;
            }
        }
        
        .tabs-container {
            margin-top: 20px;
        }
        
        .nav-tabs .nav-link {
            border-radius: 8px 8px 0 0;
            border: none;
            background: #f8f9fa;
            color: #6c757d;
            margin-right: 5px;
        }
        
        .nav-tabs .nav-link.active {
            background: #007bff;
            color: white;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 8px 8px 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="letter-detail-container">
        <!-- Letter Header -->
        <div class="letter-header no-print">
            <h1>{{ letter.subject }}</h1>
            <div class="letter-meta">
                <div class="meta-item">
                    <i class="fas fa-file-alt"></i>
                    <span>{{ letter.letter_number|default:"Auto-generated" }}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-user"></i>
                    <span>{{ letter.applicant.full_name }}</span>
                </div>
                <div class="meta-item">
                    <i class="fas fa-calendar"></i>
                    <span>{{ letter.created_at|date:"d M Y" }}</span>
                </div>
                <div class="meta-item">
                    <span class="status-badge status-{{ letter.status }}">{{ letter.get_status_display }}</span>
                </div>
                <div class="meta-item">
                    <span class="priority-badge priority-{{ letter.priority }}">{{ letter.get_priority_display }}</span>
                </div>
            </div>
        </div>
        
        <!-- Letter Content -->
        <div class="letter-content">
            <!-- Tabs Navigation -->
            <div class="tabs-container no-print">
                <ul class="nav nav-tabs" id="letterTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tracking-tab" data-bs-toggle="tab" data-bs-target="#tracking" type="button" role="tab">
                            <i class="fas fa-route"></i> Tracking
                        </button>
                    </li>
                    {% if letter.attachments.exists %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="attachments-tab" data-bs-toggle="tab" data-bs-target="#attachments" type="button" role="tab">
                            <i class="fas fa-paperclip"></i> Attachments ({{ letter.attachments.count }})
                        </button>
                    </li>
                    {% endif %}
                    {% if letter.ai_validations.exists %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-validation" type="button" role="tab">
                            <i class="fas fa-robot"></i> AI Validation
                        </button>
                    </li>
                    {% endif %}
                </ul>
                
                <div class="tab-content" id="letterTabContent">
                    <!-- Preview Tab -->
                    <div class="tab-pane fade show active" id="preview" role="tabpanel">
                        <div class="letter-preview">
                            <!-- Letterhead -->
                            <div class="letterhead">
                                <h2>PEMERINTAH DESA PULOSAROK</h2>
                                <p>Kecamatan Cibadak, Kabupaten Sukabumi, Jawa Barat</p>
                                <p>Kode Pos: 43351 | Telp: (0266) 123456</p>
                                <p>Email: info@pulosarok.desa.id | Website: www.pulosarok.desa.id</p>
                            </div>
                            
                            <!-- Letter Number -->
                            <div class="letter-number">
                                Nomor: {{ letter.letter_number|default:"[Auto-generated]" }}
                            </div>
                            
                            <!-- Subject -->
                            <div class="letter-subject">
                                {{ letter.subject }}
                            </div>
                            
                            <!-- Content -->
                            <div class="letter-body">
                                {{ letter.content|safe }}
                            </div>
                            
                            <!-- Signature Section -->
                            <div class="signature-section">
                                <div class="signature-info">
                                    <p>Pulosarok, {{ letter.created_at|date:"d F Y" }}</p>
                                    <p>Kepala Desa Pulosarok</p>
                                </div>
                                
                                {% if letter.digital_signatures.exists %}
                                    {% for signature in letter.digital_signatures.all %}
                                        <div class="digital-signature {% if signature.is_valid %}signature-valid{% else %}signature-invalid{% endif %}">
                                            <i class="fas fa-certificate fa-2x mb-2"></i>
                                            <p><strong>Digitally Signed</strong></p>
                                            <p>{{ signature.signer_name }}</p>
                                            <p><small>Signed on: {{ signature.signed_at|date:"d M Y H:i" }}</small></p>
                                            {% if signature.is_valid %}
                                                <p><small class="text-success"><i class="fas fa-check-circle"></i> Signature Valid</small></p>
                                            {% else %}
                                                <p><small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Signature Invalid</small></p>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="signature-name">
                                        {{ letter.settings.village_head_name|default:"[Kepala Desa]" }}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- QR Code for Verification -->
                            {% if letter.verification_qr_code %}
                            <div class="qr-code">
                                <p><strong>Verification QR Code:</strong></p>
                                <img src="{{ letter.verification_qr_code.url }}" alt="QR Code" width="100">
                                <p><small>Scan to verify letter authenticity</small></p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Details Tab -->
                    <div class="tab-pane fade" id="details" role="tabpanel">
                        <!-- Basic Information -->
                        <div class="info-section">
                            <h4><i class="fas fa-info-circle"></i> Basic Information</h4>
                            <div class="info-grid">
                                <div>
                                    <div class="info-item">
                                        <span class="info-label">Letter Number:</span>
                                        <span class="info-value">{{ letter.letter_number|default:"Auto-generated" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Subject:</span>
                                        <span class="info-value">{{ letter.subject }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Letter Type:</span>
                                        <span class="info-value">{{ letter.letter_type.name }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Status:</span>
                                        <span class="info-value">
                                            <span class="status-badge status-{{ letter.status }}">{{ letter.get_status_display }}</span>
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Priority:</span>
                                        <span class="info-value">
                                            <span class="priority-badge priority-{{ letter.priority }}">{{ letter.get_priority_display }}</span>
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <div class="info-item">
                                        <span class="info-label">Created:</span>
                                        <span class="info-value">{{ letter.created_at|date:"d M Y H:i" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Updated:</span>
                                        <span class="info-value">{{ letter.updated_at|date:"d M Y H:i" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Created By:</span>
                                        <span class="info-value">{{ letter.created_by.get_full_name|default:letter.created_by.username }}</span>
                                    </div>
                                    {% if letter.notes %}
                                    <div class="info-item">
                                        <span class="info-label">Notes:</span>
                                        <span class="info-value">{{ letter.notes }}</span>
                                    </div>
                                    {% endif %}
                                    {% if letter.tags %}
                                    <div class="info-item">
                                        <span class="info-label">Tags:</span>
                                        <span class="info-value">{{ letter.tags }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Applicant Information -->
                        <div class="info-section">
                            <h4><i class="fas fa-user"></i> Applicant Information</h4>
                            <div class="info-grid">
                                <div>
                                    <div class="info-item">
                                        <span class="info-label">Full Name:</span>
                                        <span class="info-value">{{ letter.applicant.full_name }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">NIK:</span>
                                        <span class="info-value">{{ letter.applicant.nik }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Birth Date:</span>
                                        <span class="info-value">{{ letter.applicant.birth_date|date:"d M Y" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Gender:</span>
                                        <span class="info-value">{{ letter.applicant.get_gender_display }}</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="info-item">
                                        <span class="info-label">Address:</span>
                                        <span class="info-value">{{ letter.applicant.address }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Phone:</span>
                                        <span class="info-value">{{ letter.applicant.phone|default:"-" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Email:</span>
                                        <span class="info-value">{{ letter.applicant.email|default:"-" }}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Occupation:</span>
                                        <span class="info-value">{{ letter.applicant.occupation|default:"-" }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recipients Information -->
                        {% if letter.recipients.exists %}
                        <div class="info-section">
                            <h4><i class="fas fa-users"></i> Recipients</h4>
                            {% for recipient in letter.recipients.all %}
                            <div class="info-item">
                                <span class="info-label">{{ recipient.recipient_type|title }}:</span>
                                <span class="info-value">
                                    {{ recipient.name }}<br>
                                    <small class="text-muted">{{ recipient.address }}</small>
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Tracking Tab -->
                    <div class="tab-pane fade" id="tracking" role="tabpanel">
                        <div class="tracking-timeline">
                            {% for track in letter.tracking.all %}
                            <div class="timeline-item {{ track.status }}">
                                <div class="timeline-header">
                                    <span class="timeline-title">{{ track.action }}</span>
                                    <span class="timeline-time">{{ track.timestamp|date:"d M Y H:i" }}</span>
                                </div>
                                <div class="timeline-description">{{ track.description }}</div>
                                <div class="timeline-user">
                                    <i class="fas fa-user"></i> {{ track.user.get_full_name|default:track.user.username }}
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center text-muted">
                                <i class="fas fa-info-circle fa-2x mb-3"></i>
                                <p>No tracking information available yet.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Attachments Tab -->
                    {% if letter.attachments.exists %}
                    <div class="tab-pane fade" id="attachments" role="tabpanel">
                        <div class="attachments-grid">
                            {% for attachment in letter.attachments.all %}
                            <div class="attachment-card">
                                <div class="attachment-icon">
                                    {% if attachment.file_type == 'pdf' %}
                                        <i class="fas fa-file-pdf text-danger"></i>
                                    {% elif attachment.file_type == 'doc' or attachment.file_type == 'docx' %}
                                        <i class="fas fa-file-word text-primary"></i>
                                    {% elif attachment.file_type == 'jpg' or attachment.file_type == 'jpeg' or attachment.file_type == 'png' %}
                                        <i class="fas fa-file-image text-success"></i>
                                    {% else %}
                                        <i class="fas fa-file text-secondary"></i>
                                    {% endif %}
                                </div>
                                <div class="attachment-name">{{ attachment.filename }}</div>
                                <div class="attachment-size">{{ attachment.file_size|filesizeformat }}</div>
                                <div class="mt-2">
                                    <a href="{{ attachment.file.url }}" class="btn btn-sm btn-outline-primary" download>
                                        <i class="fas fa-download"></i> Download
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- AI Validation Tab -->
                    {% if letter.ai_validations.exists %}
                    <div class="tab-pane fade" id="ai-validation" role="tabpanel">
                        {% for validation in letter.ai_validations.all %}
                        <div class="ai-validation-result ai-validation-{% if validation.is_valid %}success{% elif validation.confidence_score < 0.7 %}warning{% else %}error{% endif %}">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5>
                                    <i class="fas fa-robot"></i> AI Validation Result
                                    {% if validation.is_valid %}
                                        <i class="fas fa-check-circle text-success"></i>
                                    {% else %}
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                    {% endif %}
                                </h5>
                                <span class="badge bg-primary">Confidence: {{ validation.confidence_score|floatformat:1 }}%</span>
                            </div>
                            
                            <p><strong>Summary:</strong> {{ validation.validation_summary }}</p>
                            
                            {% if validation.suggestions %}
                            <div class="ai-suggestions">
                                <h6>AI Suggestions:</h6>
                                {% for suggestion in validation.suggestions_list %}
                                <div class="ai-suggestion">
                                    <i class="fas fa-lightbulb"></i> {{ suggestion }}
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <div class="mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> Validated on {{ validation.validated_at|date:"d M Y H:i" }}
                                    by {{ validation.validated_by.get_full_name|default:validation.validated_by.username }}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons no-print">
            <a href="{% url 'letters:admin_edit' letter.id %}" class="btn btn-primary">
                <i class="fas fa-edit"></i> Edit Letter
            </a>
            <button class="btn btn-success" onclick="downloadPDF()">
                <i class="fas fa-file-pdf"></i> Download PDF
            </button>
            <button class="btn btn-info" onclick="downloadDOCX()">
                <i class="fas fa-file-word"></i> Download DOCX
            </button>
            <button class="btn btn-warning" onclick="validateWithAI()">
                <i class="fas fa-robot"></i> AI Validate
            </button>
            {% if not letter.digital_signatures.exists %}
            <button class="btn btn-secondary" onclick="signDigitally()">
                <i class="fas fa-signature"></i> Digital Sign
            </button>
            {% endif %}
            <button class="btn btn-outline-primary" onclick="printLetter()">
                <i class="fas fa-print"></i> Print
            </button>
            <button class="btn btn-outline-secondary" onclick="shareLetter()">
                <i class="fas fa-share"></i> Share
            </button>
            <a href="{% url 'letters:admin_list' %}" class="btn btn-outline-dark">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share Letter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Share Link:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="share-link" value="{{ request.build_absolute_uri }}" readonly>
                        <button class="btn btn-outline-secondary" onclick="copyShareLink()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">QR Code:</label>
                    <div class="text-center">
                        <div id="qr-code-container"></div>
                    </div>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="shareViaEmail()">
                        <i class="fas fa-envelope"></i> Share via Email
                    </button>
                    <button class="btn btn-success" onclick="shareViaWhatsApp()">
                        <i class="fab fa-whatsapp"></i> Share via WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
    // Download functions
    function downloadPDF() {
        window.open('{% url "letters:letter_pdf" letter.id %}', '_blank');
    }
    
    function downloadDOCX() {
        window.open('{% url "letters:letter_docx" letter.id %}', '_blank');
    }
    
    // AI Validation
    function validateWithAI() {
        if (confirm('Validate this letter with AI? This may take a few moments.')) {
            fetch('{% url "letters:letter_ai_validate_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ letter_id: {{ letter.id }} })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('AI validation completed successfully!');
                    location.reload();
                } else {
                    alert('AI validation failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('AI validation error:', error);
                alert('An error occurred during AI validation.');
            });
        }
    }
    
    // Digital Signature
    function signDigitally() {
        if (confirm('Sign this letter digitally? This action cannot be undone.')) {
            fetch('{% url "letters:letter_digital_sign_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ letter_id: {{ letter.id }} })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Letter signed successfully!');
                    location.reload();
                } else {
                    alert('Digital signing failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Digital signing error:', error);
                alert('An error occurred during digital signing.');
            });
        }
    }
    
    // Print function
    function printLetter() {
        window.print();
    }
    
    // Share functions
    function shareLetter() {
        generateQRCode();
        new bootstrap.Modal(document.getElementById('shareModal')).show();
    }
    
    function generateQRCode() {
        const url = document.getElementById('share-link').value;
        const qrContainer = document.getElementById('qr-code-container');
        
        // Simple QR code generation (you might want to use a proper QR code library)
        qrContainer.innerHTML = `
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}" 
                 alt="QR Code" class="img-fluid">
        `;
    }
    
    function copyShareLink() {
        const shareLink = document.getElementById('share-link');
        shareLink.select();
        shareLink.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        // Show feedback
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
        button.classList.add('btn-success');
        button.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    }
    
    function shareViaEmail() {
        const subject = encodeURIComponent('Letter: {{ letter.subject }}');
        const body = encodeURIComponent(`Please find the letter details at: ${document.getElementById('share-link').value}`);
        window.open(`mailto:?subject=${subject}&body=${body}`);
    }
    
    function shareViaWhatsApp() {
        const text = encodeURIComponent(`Letter: {{ letter.subject }}\n${document.getElementById('share-link').value}`);
        window.open(`https://wa.me/?text=${text}`);
    }
    
    // Initialize tooltips
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}