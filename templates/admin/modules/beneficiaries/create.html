{% extends 'admin/base.html' %}

{% block title %}Tambah Penerima Bantuan{% endblock title %}
{% block page_title %}Tambah Penerima Bantuan{% endblock page_title %}

{% block content %}
<div class="p-6">
    <!-- Header Section -->
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Tambah Penerima Bantuan</h1>
                <p class="text-gray-600 mt-1">Tambahkan data penerima bantuan sosial baru</p>
            </div>
            <div>
                <a href="{% url 'beneficiaries:index' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>Kembali
                </a>
            </div>
        </div>
    </div>

    <!-- Form Section -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <form id="formTambahData" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Pencarian Data Penduduk -->
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cari Data Penduduk</label>
                    <div class="flex space-x-2">
                        <div class="flex-grow">
                            <input type="text" id="searchPenduduk" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50" placeholder="Cari berdasarkan nama atau NIK...">
                        </div>
                        <button type="button" id="btnSearchPenduduk" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-search mr-2"></i>Cari
                        </button>
                    </div>
                    <div id="pendudukSearchResults" class="mt-2 hidden">
                        <div class="bg-white rounded-lg border border-gray-200 shadow-sm max-h-60 overflow-y-auto">
                            <ul id="pendudukList" class="divide-y divide-gray-200"></ul>
                        </div>
                    </div>
                </div>

                <!-- Data Penduduk Terpilih -->
                <div id="selectedPendudukContainer" class="col-span-2 bg-gray-50 p-4 rounded-lg border border-gray-200 hidden">
                    <h4 class="font-medium text-gray-900 mb-2">Data Penduduk Terpilih</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-500">Nama Lengkap</p>
                            <p id="selectedNama" class="font-medium">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">NIK</p>
                            <p id="selectedNIK" class="font-medium">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Tempat, Tanggal Lahir</p>
                            <p id="selectedTTL" class="font-medium">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Jenis Kelamin</p>
                            <p id="selectedGender" class="font-medium">-</p>
                        </div>
                    </div>
                    <input type="hidden" id="selectedPendudukId" name="person_id">
                </div>

                <!-- Kategori Bantuan -->
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Kategori Bantuan <span class="text-red-500">*</span></label>
                    <select id="category" name="category" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50" required>
                        <option value="">Pilih Kategori</option>
                        <!-- Options will be loaded via JavaScript -->
                    </select>
                </div>

                <!-- Tanggal Registrasi -->
                <div>
                    <label for="registration_date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Registrasi <span class="text-red-500">*</span></label>
                    <input type="date" id="registration_date" name="registration_date" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50" required>
                </div>

                <!-- Status -->
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status <span class="text-red-500">*</span></label>
                    <select id="status" name="status" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50" required>
                        <option value="aktif">Aktif</option>
                        <option value="tidak_aktif">Tidak Aktif</option>
                        <option value="lulus">Lulus</option>
                        <option value="meninggal">Meninggal</option>
                        <option value="pindah">Pindah</option>
                    </select>
                </div>

                <!-- Status Ekonomi -->
                <div>
                    <label for="economic_status" class="block text-sm font-medium text-gray-700 mb-1">Status Ekonomi <span class="text-red-500">*</span></label>
                    <select id="economic_status" name="economic_status" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50" required>
                        <option value="">Pilih Status Ekonomi</option>
                        <option value="sangat_miskin">Sangat Miskin</option>
                        <option value="miskin">Miskin</option>
                        <option value="rentan_miskin">Rentan Miskin</option>
                        <option value="tidak_miskin">Tidak Miskin</option>
                    </select>
                </div>

                <!-- Pendapatan Bulanan -->
                <div>
                    <label for="monthly_income" class="block text-sm font-medium text-gray-700 mb-1">Pendapatan Bulanan (Rp)</label>
                    <input type="number" id="monthly_income" name="monthly_income" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50" placeholder="Contoh: 1500000">
                </div>

                <!-- Jumlah Anggota Keluarga -->
                <div>
                    <label for="family_members_count" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Anggota Keluarga</label>
                    <input type="number" id="family_members_count" name="family_members_count" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50" value="1" min="1">
                </div>

                <!-- Kondisi Rumah -->
                <div class="col-span-2">
                    <label for="house_condition" class="block text-sm font-medium text-gray-700 mb-1">Kondisi Rumah</label>
                    <textarea id="house_condition" name="house_condition" rows="3" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50" placeholder="Deskripsi kondisi rumah..."></textarea>
                </div>

                <!-- Kebutuhan Khusus -->
                <div class="col-span-2">
                    <label for="special_needs" class="block text-sm font-medium text-gray-700 mb-1">Kebutuhan Khusus</label>
                    <textarea id="special_needs" name="special_needs" rows="3" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50" placeholder="Kebutuhan khusus jika ada..."></textarea>
                </div>

                <!-- Tanggal Verifikasi -->
                <div>
                    <label for="verification_date" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Verifikasi</label>
                    <input type="date" id="verification_date" name="verification_date" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50">
                </div>

                <!-- Verifikator -->
                <div>
                    <label for="verifier" class="block text-sm font-medium text-gray-700 mb-1">Verifikator</label>
                    <input type="text" id="verifier" name="verifier" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50" placeholder="Nama verifikator...">
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <a href="{% url 'beneficiaries:index' %}" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Batal
                </a>
                <button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg">
                    Simpan Data
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Fungsi untuk mendapatkan CSRF token dari cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Fungsi untuk memuat data kategori bantuan
    function loadCategories() {
        const csrftoken = getCookie('csrftoken');
        
        fetch('/pulosarok/api/beneficiaries/categories/dropdown/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(response => {
            try {
                let data;
                // Handle different response formats
                if (Array.isArray(response)) {
                    data = response;
                } else if (response.hasOwnProperty('data') && Array.isArray(response.data)) {
                    data = response.data;
                } else if (response.hasOwnProperty('success') && response.success && Array.isArray(response.data)) {
                    data = response.data;
                } else {
                    console.error('Unexpected data format:', response);
                    throw new Error('Invalid data format for categories');
                }
                
                const categorySelect = document.getElementById('category');
                
                // Clear existing options except the first one
                while (categorySelect.options.length > 1) {
                    categorySelect.remove(1);
                }
                
                // Add new options
                data.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            } catch (err) {
                console.error('Error processing category data:', err);
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal memproses data',
                    text: 'Error processing category data: ' + err.message
                });
            }
        })
        .catch(error => {
            console.error('Error loading categories:', error);
            Swal.fire({
                icon: 'error',
                title: 'Gagal memuat data',
                text: 'Error loading categories: ' + error.message
            });
        });
    }

    // Fungsi untuk mencari data penduduk
    function searchPenduduk() {
        const searchQuery = document.getElementById('searchPenduduk').value;
        
        if (searchQuery.length < 3) {
            Swal.fire({
                icon: 'warning',
                title: 'Masukkan minimal 3 karakter',
                text: 'Silakan masukkan minimal 3 karakter untuk mencari data penduduk.'
            });
            return;
        }
        
        fetch(`/pulosarok/api/core/people/?search=${searchQuery}`)
            .then(response => response.json())
            .then(data => {
                const pendudukList = document.getElementById('pendudukList');
                pendudukList.innerHTML = '';
                
                if (data.results.length === 0) {
                    pendudukList.innerHTML = `
                        <li class="p-3 text-center text-gray-500">
                            <i class="fas fa-info-circle mr-2"></i>Tidak ada data yang ditemukan
                        </li>
                    `;
                } else {
                    data.results.forEach(person => {
                        const li = document.createElement('li');
                        li.className = 'p-3 hover:bg-gray-50 cursor-pointer';
                        li.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-medium text-gray-900">${person.full_name}</p>
                                    <p class="text-sm text-gray-500">NIK: ${person.nik}</p>
                                </div>
                                <button class="select-person-btn px-3 py-1 bg-primary-100 text-primary-700 rounded-lg text-sm hover:bg-primary-200" data-id="${person.id}" data-name="${person.full_name}" data-nik="${person.nik}" data-birth="${person.birth_place}, ${new Date(person.birth_date).toLocaleDateString('id-ID')}" data-gender="${person.gender === 'L' ? 'Laki-laki' : 'Perempuan'}">
                                    Pilih
                                </button>
                            </div>
                        `;
                        pendudukList.appendChild(li);
                    });
                    
                    // Add event listeners to select buttons
                    document.querySelectorAll('.select-person-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            selectPerson({
                                id: this.dataset.id,
                                name: this.dataset.name,
                                nik: this.dataset.nik,
                                birth: this.dataset.birth,
                                gender: this.dataset.gender
                            });
                        });
                    });
                }
                
                document.getElementById('pendudukSearchResults').classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error searching people:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal mencari data',
                    text: 'Terjadi kesalahan saat mencari data penduduk.'
                });
            });
    }

    // Fungsi untuk memilih penduduk
    function selectPerson(person) {
        document.getElementById('selectedNama').textContent = person.name;
        document.getElementById('selectedNIK').textContent = person.nik;
        document.getElementById('selectedTTL').textContent = person.birth;
        document.getElementById('selectedGender').textContent = person.gender;
        document.getElementById('selectedPendudukId').value = person.id;
        
        document.getElementById('pendudukSearchResults').classList.add('hidden');
        document.getElementById('selectedPendudukContainer').classList.remove('hidden');
    }

    // Submit form
    document.getElementById('formTambahData').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validasi form
        if (!document.getElementById('selectedPendudukId').value) {
            Swal.fire({
                icon: 'warning',
                title: 'Data Tidak Lengkap',
                text: 'Silakan pilih data penduduk terlebih dahulu.'
            });
            return;
        }
        
        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => {
            data[key] = value;
        });
        
        // Kirim data ke API
        fetch('/pulosarok/api/beneficiaries/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(JSON.stringify(err));
                });
            }
            return response.json();
        })
        .then(data => {
            Swal.fire({
                icon: 'success',
                title: 'Berhasil',
                text: 'Data penerima bantuan berhasil disimpan.',
                confirmButtonText: 'OK'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '{% url "beneficiaries:index" %}';
                }
            });
        })
        .catch(error => {
            console.error('Error saving data:', error);
            let errorMessage = 'Terjadi kesalahan saat menyimpan data.';
            try {
                const errorData = JSON.parse(error.message);
                if (errorData.message) {
                    errorMessage = errorData.message;
                } else if (errorData.detail) {
                    errorMessage = errorData.detail;
                } else {
                    // Cek error untuk setiap field
                    const errorFields = Object.keys(errorData);
                    if (errorFields.length > 0) {
                        errorMessage = errorFields.map(field => `${field}: ${errorData[field]}`).join('\n');
                    }
                }
            } catch (e) {
                errorMessage = error.message;
            }
            
            Swal.fire({
                icon: 'error',
                title: 'Gagal',
                text: errorMessage
            });
        });
    });

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Set tanggal registrasi ke hari ini
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('registration_date').value = today;
        
        // Load kategori bantuan
        loadCategories();
        
        // Event listener untuk tombol cari penduduk
        document.getElementById('btnSearchPenduduk').addEventListener('click', searchPenduduk);
        
        // Event listener untuk input pencarian dengan tombol Enter
        document.getElementById('searchPenduduk').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchPenduduk();
            }
        });
    });
</script>
{% endblock extra_js %}