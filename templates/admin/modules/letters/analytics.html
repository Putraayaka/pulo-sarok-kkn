{% extends 'admin/base.html' %}

{% block title %}Analytics & Insights{% endblock %}

{% block page_title %}Analytics & Insights{% endblock %}

{% block extra_css %}
<style>
    .analytics-card {
        transition: all 0.3s ease;
        border: 1px solid #e5e7eb;
    }
    
    // Processing Time Chart
    function initProcessingTimeChart() {
        const ctx = document.getElementById('processing-time-chart').getContext('2d');
        
        charts.processingTime = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: analyticsData.processingTime.map(p => p.range),
                datasets: [{
                    label: 'Jumlah Surat',
                    data: analyticsData.processingTime.map(p => p.count),
                    backgroundColor: '#10b981',
                    borderColor: '#059669',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Monthly Comparison Chart
    function initMonthlyComparisonChart() {
        const ctx = document.getElementById('monthly-comparison-chart').getContext('2d');
        
        charts.monthlyComparison = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: analyticsData.monthlyComparison.map(m => m.month),
                datasets: [{
                    label: '2024',
                    data: analyticsData.monthlyComparison.map(m => m.thisYear),
                    backgroundColor: '#3b82f6',
                    borderColor: '#2563eb',
                    borderWidth: 1
                }, {
                    label: '2023',
                    data: analyticsData.monthlyComparison.map(m => m.lastYear),
                    backgroundColor: '#94a3b8',
                    borderColor: '#64748b',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Status Distribution Chart
    function initStatusDistributionChart() {
        const ctx = document.getElementById('status-distribution-chart').getContext('2d');
        
        const statusData = [
            { status: 'Disetujui', count: 1174, color: '#10b981' },
            { status: 'Pending', count: 45, color: '#f59e0b' },
            { status: 'Ditolak', count: 28, color: '#ef4444' }
        ];
        
        charts.statusDistribution = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: statusData.map(s => s.status),
                datasets: [{
                    data: statusData.map(s => s.count),
                    backgroundColor: statusData.map(s => s.color),
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Render Activity Heatmap
    function renderHeatmap() {
        const heatmapContainer = document.getElementById('activity-heatmap');
        const days = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];
        const hours = Array.from({length: 24}, (_, i) => i);
        
        let heatmapHTML = '<div class="text-xs text-gray-600 mb-2">Aktivitas per Jam (7 hari terakhir)</div>';
        
        days.forEach(day => {
            heatmapHTML += `<div class="flex items-center space-x-1 mb-1">`;
            heatmapHTML += `<div class="w-8 text-xs text-gray-600">${day}</div>`;
            
            hours.forEach(hour => {
                const intensity = Math.random();
                let bgColor = 'bg-gray-100';
                
                if (intensity > 0.8) bgColor = 'bg-green-500';
                else if (intensity > 0.6) bgColor = 'bg-green-400';
                else if (intensity > 0.4) bgColor = 'bg-green-300';
                else if (intensity > 0.2) bgColor = 'bg-green-200';
                
                heatmapHTML += `<div class="heatmap-cell w-3 h-3 ${bgColor} rounded-sm cursor-pointer" title="${day} ${hour}:00 - ${Math.floor(intensity * 20)} surat"></div>`;
            });
            
            heatmapHTML += '</div>';
        });
        
        heatmapContainer.innerHTML = heatmapHTML;
    }
    
    // Render Top Templates
    function renderTopTemplates() {
        const container = document.getElementById('top-templates');
        const templates = [
            { name: 'Surat Keterangan Domisili', usage: 342, trend: 'up', percentage: 12 },
            { name: 'Surat Keterangan Usaha', usage: 298, trend: 'up', percentage: 8 },
            { name: 'Surat Keterangan Tidak Mampu', usage: 187, trend: 'down', percentage: -3 },
            { name: 'Surat Pengantar', usage: 156, trend: 'up', percentage: 15 },
            { name: 'Surat Keterangan Kelahiran', usage: 134, trend: 'neutral', percentage: 0 }
        ];
        
        let templatesHTML = '';
        templates.forEach((template, index) => {
            const trendIcon = template.trend === 'up' ? 'fa-arrow-up trend-up' : 
                            template.trend === 'down' ? 'fa-arrow-down trend-down' : 
                            'fa-minus trend-neutral';
            
            templatesHTML += `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                            <span class="text-sm font-bold text-blue-600">${index + 1}</span>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${template.name}</p>
                            <p class="text-xs text-gray-600">${template.usage} penggunaan</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas ${trendIcon} text-xs"></i>
                        <span class="text-xs ${template.trend === 'up' ? 'text-green-600' : template.trend === 'down' ? 'text-red-600' : 'text-gray-600'}">
                            ${template.percentage > 0 ? '+' : ''}${template.percentage}%
                        </span>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = templatesHTML;
    }
    
    // Render Activity Timeline
    function renderActivityTimeline() {
        const container = document.getElementById('activity-timeline');
        const activities = [
            {
                time: '2 menit yang lalu',
                user: 'Admin Desa',
                action: 'menyetujui',
                target: 'Surat Keterangan Domisili',
                icon: 'fa-check',
                color: 'text-green-600'
            },
            {
                time: '15 menit yang lalu',
                user: 'Sekretaris',
                action: 'membuat',
                target: 'Surat Keterangan Usaha',
                icon: 'fa-plus',
                color: 'text-blue-600'
            },
            {
                time: '1 jam yang lalu',
                user: 'Staff RT',
                action: 'mengajukan',
                target: 'Surat Pengantar',
                icon: 'fa-paper-plane',
                color: 'text-purple-600'
            },
            {
                time: '2 jam yang lalu',
                user: 'Admin Desa',
                action: 'menolak',
                target: 'Surat Keterangan Tidak Mampu',
                icon: 'fa-times',
                color: 'text-red-600'
            },
            {
                time: '3 jam yang lalu',
                user: 'Sekretaris',
                action: 'memperbarui template',
                target: 'Surat Keterangan Domisili',
                icon: 'fa-edit',
                color: 'text-orange-600'
            }
        ];
        
        let timelineHTML = '';
        activities.forEach((activity, index) => {
            timelineHTML += `
                <div class="flex items-start space-x-4 ${index !== activities.length - 1 ? 'pb-4 border-b border-gray-100' : ''}">
                    <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas ${activity.icon} ${activity.color} text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-900">
                            <span class="font-medium">${activity.user}</span>
                            <span class="text-gray-600">${activity.action}</span>
                            <span class="font-medium">${activity.target}</span>
                        </p>
                        <p class="text-xs text-gray-500 mt-1">${activity.time}</p>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = timelineHTML;
    }
    
    // Chart type switching
    function switchChartType(type) {
        document.querySelectorAll('.filter-chip').forEach(btn => btn.classList.remove('active'));
        document.getElementById(type + '-btn').classList.add('active');
        
        charts.trends.destroy();
        
        const ctx = document.getElementById('trends-chart').getContext('2d');
        charts.trends = new Chart(ctx, {
            type: type,
            data: {
                labels: analyticsData.daily.map(d => {
                    const date = new Date(d.date);
                    return date.toLocaleDateString('id-ID', { month: 'short', day: 'numeric' });
                }),
                datasets: [{
                    label: 'Total Surat',
                    data: analyticsData.daily.map(d => d.letters),
                    borderColor: '#3b82f6',
                    backgroundColor: type === 'line' ? 'rgba(59, 130, 246, 0.1)' : '#3b82f6',
                    tension: type === 'line' ? 0.4 : 0,
                    fill: type === 'line'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Time range update
    function updateTimeRange() {
        const timeRange = document.getElementById('time-range').value;
        
        if (timeRange === 'custom') {
            openDateRangeModal();
            return;
        }
        
        currentTimeRange = timeRange;
        generateAnalyticsData();
        
        // Update all charts
        Object.keys(charts).forEach(chartKey => {
            charts[chartKey].destroy();
        });
        
        initializeCharts();
        updateMetrics();
    }
    
    // Update key metrics
    function updateMetrics() {
        const totalLetters = analyticsData.daily.reduce((sum, day) => sum + day.letters, 0);
        const dailyAverage = Math.round(totalLetters / analyticsData.daily.length);
        
        document.getElementById('total-letters').textContent = totalLetters.toLocaleString();
        document.getElementById('daily-average').textContent = dailyAverage;
        document.getElementById('avg-processing-time').textContent = '2.4h';
        document.getElementById('approval-rate').textContent = '94.2%';
    }
    
    // Date range modal functions
    function openDateRangeModal() {
        document.getElementById('date-range-modal').classList.remove('hidden');
        
        // Set default dates
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);
        
        document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
        document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
    }
    
    function closeDateRangeModal() {
        document.getElementById('date-range-modal').classList.add('hidden');
        document.getElementById('time-range').value = currentTimeRange;
    }
    
    function applyDateRange() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (!startDate || !endDate) {
            showNotification('Silakan pilih tanggal mulai dan akhir', 'error');
            return;
        }
        
        if (new Date(startDate) > new Date(endDate)) {
            showNotification('Tanggal mulai tidak boleh lebih besar dari tanggal akhir', 'error');
            return;
        }
        
        currentTimeRange = 'custom';
        generateAnalyticsData();
        
        // Update all charts
        Object.keys(charts).forEach(chartKey => {
            charts[chartKey].destroy();
        });
        
        initializeCharts();
        updateMetrics();
        
        closeDateRangeModal();
        showNotification('Data berhasil diperbarui untuk rentang tanggal yang dipilih', 'success');
    }
    
    // Export report
    function exportReport() {
        showNotification('Mempersiapkan laporan...', 'info');
        
        setTimeout(() => {
            // Simulate export process
            const link = document.createElement('a');
            link.href = '#';
            link.download = `analytics-report-${new Date().toISOString().split('T')[0]}.pdf`;
            link.click();
            
            showNotification('Laporan berhasil diekspor', 'success');
        }, 2000);
    }
    
    // Refresh data
    function refreshData() {
        showNotification('Memperbarui data...', 'info');
        
        setTimeout(() => {
            generateAnalyticsData();
            
            // Update all charts
            Object.keys(charts).forEach(chartKey => {
                charts[chartKey].destroy();
            });
            
            initializeCharts();
            renderHeatmap();
            renderTopTemplates();
            renderActivityTimeline();
            updateMetrics();
            
            showNotification('Data berhasil diperbarui', 'success');
        }, 1500);
    }
    
    // Utility function for notifications
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
        
        const colors = {
            success: 'bg-green-500 text-white',
            error: 'bg-red-500 text-white',
            warning: 'bg-yellow-500 text-white',
            info: 'bg-blue-500 text-white'
        };
        
        notification.className += ` ${colors[type] || colors.info}`;
        notification.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fas ${
                    type === 'success' ? 'fa-check-circle' :
                    type === 'error' ? 'fa-exclamation-circle' :
                    type === 'warning' ? 'fa-exclamation-triangle' :
                    'fa-info-circle'
                }"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);
        
        // Auto remove
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
</script>
{% endblock %}
    .analytics-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border-color: #3b82f6;
    }
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .growth-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    .efficiency-card {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }
    .satisfaction-card {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
    }
    .chart-container {
        position: relative;
        height: 400px;
    }
    .chart-container canvas {
        max-height: 100%;
    }
    .insight-item {
        transition: all 0.2s ease;
    }
    .insight-item:hover {
        background-color: #f9fafb;
    }
    .trend-up {
        color: #10b981;
    }
    .trend-down {
        color: #ef4444;
    }
    .trend-neutral {
        color: #6b7280;
    }
    .filter-chip {
        transition: all 0.2s ease;
    }
    .filter-chip.active {
        background-color: #3b82f6;
        color: white;
    }
    .heatmap-cell {
        transition: all 0.2s ease;
    }
    .heatmap-cell:hover {
        transform: scale(1.1);
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="p-6">
    <!-- Header Section -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-chart-line mr-3 text-blue-600"></i>
                Analytics & Insights
            </h1>
            <p class="text-gray-600">Analisis mendalam penggunaan sistem surat desa</p>
        </div>
        <div class="flex space-x-3 mt-4 lg:mt-0">
            <select id="time-range" onchange="updateTimeRange()" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="7d">7 Hari Terakhir</option>
                <option value="30d" selected>30 Hari Terakhir</option>
                <option value="90d">90 Hari Terakhir</option>
                <option value="1y">1 Tahun Terakhir</option>
                <option value="custom">Custom Range</option>
            </select>
            <button onclick="exportReport()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors duration-200">
                <i class="fas fa-download mr-2"></i>
                Export Report
            </button>
            <button onclick="refreshData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                <i class="fas fa-sync-alt mr-2"></i>
                Refresh
            </button>
        </div>
    </div>
    
    <!-- Key Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="metric-card rounded-lg p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-sm font-medium">Total Surat</p>
                    <p class="text-3xl font-bold text-white" id="total-letters">1,247</p>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-file-alt text-white text-xl"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-white/80 text-sm">
                <i class="fas fa-arrow-up mr-1 trend-up"></i>
                <span>+12.5% dari bulan lalu</span>
            </div>
        </div>
        
        <div class="growth-card rounded-lg p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-sm font-medium">Rata-rata Harian</p>
                    <p class="text-3xl font-bold text-white" id="daily-average">42</p>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-calendar-day text-white text-xl"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-white/80 text-sm">
                <i class="fas fa-arrow-up mr-1 trend-up"></i>
                <span>+8.3% dari minggu lalu</span>
            </div>
        </div>
        
        <div class="efficiency-card rounded-lg p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-sm font-medium">Waktu Proses</p>
                    <p class="text-3xl font-bold text-white" id="avg-processing-time">2.4h</p>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-clock text-white text-xl"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-white/80 text-sm">
                <i class="fas fa-arrow-down mr-1 trend-up"></i>
                <span>-15.2% lebih cepat</span>
            </div>
        </div>
        
        <div class="satisfaction-card rounded-lg p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-sm font-medium">Tingkat Approval</p>
                    <p class="text-3xl font-bold text-white" id="approval-rate">94.2%</p>
                </div>
                <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-thumbs-up text-white text-xl"></i>
                </div>
            </div>
            <div class="mt-4 flex items-center text-white/80 text-sm">
                <i class="fas fa-arrow-up mr-1 trend-up"></i>
                <span>+2.1% dari target</span>
            </div>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Letter Trends Chart -->
        <div class="analytics-card bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-chart-line mr-2 text-blue-600"></i>
                    Tren Penggunaan Surat
                </h2>
                <div class="flex space-x-2">
                    <button onclick="switchChartType('line')" id="line-btn" class="filter-chip active px-3 py-1 text-xs rounded-full border">
                        Line
                    </button>
                    <button onclick="switchChartType('bar')" id="bar-btn" class="filter-chip px-3 py-1 text-xs rounded-full border">
                        Bar
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="trends-chart"></canvas>
            </div>
        </div>
        
        <!-- Letter Types Distribution -->
        <div class="analytics-card bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-chart-pie mr-2 text-purple-600"></i>
                    Distribusi Jenis Surat
                </h2>
                <button onclick="toggleChartView('doughnut')" class="text-sm text-blue-600 hover:text-blue-800">
                    <i class="fas fa-expand-arrows-alt"></i>
                </button>
            </div>
            <div class="chart-container">
                <canvas id="distribution-chart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Performance Analysis -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <!-- Processing Time Analysis -->
        <div class="analytics-card bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-stopwatch mr-2 text-green-600"></i>
                Analisis Waktu Proses
            </h3>
            <div class="chart-container" style="height: 300px;">
                <canvas id="processing-time-chart"></canvas>
            </div>
        </div>
        
        <!-- User Activity Heatmap -->
        <div class="analytics-card bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-fire mr-2 text-red-600"></i>
                Heatmap Aktivitas
            </h3>
            <div id="activity-heatmap" class="space-y-2">
                <!-- Heatmap will be generated dynamically -->
            </div>
        </div>
        
        <!-- Top Templates -->
        <div class="analytics-card bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-star mr-2 text-yellow-600"></i>
                Template Terpopuler
            </h3>
            <div id="top-templates" class="space-y-3">
                <!-- Top templates will be generated dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Detailed Analytics -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Monthly Comparison -->
        <div class="analytics-card bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-calendar-alt mr-2 text-indigo-600"></i>
                Perbandingan Bulanan
            </h3>
            <div class="chart-container">
                <canvas id="monthly-comparison-chart"></canvas>
            </div>
        </div>
        
        <!-- Status Distribution -->
        <div class="analytics-card bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-tasks mr-2 text-teal-600"></i>
                Distribusi Status
            </h3>
            <div class="chart-container">
                <canvas id="status-distribution-chart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- AI Insights -->
    <div class="analytics-card bg-white rounded-lg shadow p-6 mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-brain mr-2 text-pink-600"></i>
            AI Insights & Recommendations
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="insight-item bg-blue-50 rounded-lg p-4">
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-lightbulb text-blue-600"></i>
                    </div>
                    <div>
                        <h4 class="text-sm font-semibold text-gray-900">Optimasi Template</h4>
                        <p class="text-xs text-gray-600 mt-1">Template "Surat Keterangan Domisili" dapat dioptimalkan untuk mengurangi waktu proses 23%</p>
                    </div>
                </div>
            </div>
            
            <div class="insight-item bg-green-50 rounded-lg p-4">
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-green-600"></i>
                    </div>
                    <div>
                        <h4 class="text-sm font-semibold text-gray-900">Tren Positif</h4>
                        <p class="text-xs text-gray-600 mt-1">Penggunaan surat digital meningkat 45% dalam 3 bulan terakhir</p>
                    </div>
                </div>
            </div>
            
            <div class="insight-item bg-yellow-50 rounded-lg p-4">
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                    </div>
                    <div>
                        <h4 class="text-sm font-semibold text-gray-900">Perhatian Khusus</h4>
                        <p class="text-xs text-gray-600 mt-1">Lonjakan permintaan surat pada hari Senin, pertimbangkan penambahan staff</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity Timeline -->
    <div class="analytics-card bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-history mr-2 text-gray-600"></i>
            Timeline Aktivitas Terkini
        </h3>
        <div id="activity-timeline" class="space-y-4">
            <!-- Timeline items will be generated dynamically -->
        </div>
    </div>
</div>

<!-- Custom Date Range Modal -->
<div id="date-range-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-calendar-alt mr-2 text-blue-600"></i>
                        Custom Date Range
                    </h3>
                    <button onclick="closeDateRangeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label>
                        <input type="date" id="start-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Akhir</label>
                        <input type="date" id="end-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button onclick="closeDateRangeModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                        Batal
                    </button>
                    <button onclick="applyDateRange()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        <i class="fas fa-check mr-2"></i>
                        Terapkan
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let charts = {};
    let currentTimeRange = '30d';
    let analyticsData = {};
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        generateAnalyticsData();
        initializeCharts();
        renderHeatmap();
        renderTopTemplates();
        renderActivityTimeline();
    });
    
    // Generate sample analytics data
    function generateAnalyticsData() {
        const now = new Date();
        const days = currentTimeRange === '7d' ? 7 : currentTimeRange === '30d' ? 30 : currentTimeRange === '90d' ? 90 : 365;
        
        // Generate daily data
        analyticsData.daily = [];
        for (let i = days - 1; i >= 0; i--) {
            const date = new Date(now);
            date.setDate(date.getDate() - i);
            
            analyticsData.daily.push({
                date: date.toISOString().split('T')[0],
                letters: Math.floor(Math.random() * 50) + 20,
                approved: Math.floor(Math.random() * 40) + 15,
                rejected: Math.floor(Math.random() * 5) + 1,
                pending: Math.floor(Math.random() * 10) + 2
            });
        }
        
        // Generate letter types data
        analyticsData.letterTypes = [
            { name: 'Surat Keterangan Domisili', count: 342, percentage: 27.4 },
            { name: 'Surat Keterangan Usaha', count: 298, percentage: 23.9 },
            { name: 'Surat Keterangan Tidak Mampu', count: 187, percentage: 15.0 },
            { name: 'Surat Pengantar', count: 156, percentage: 12.5 },
            { name: 'Surat Keterangan Kelahiran', count: 134, percentage: 10.7 },
            { name: 'Lainnya', count: 130, percentage: 10.4 }
        ];
        
        // Generate processing time data
        analyticsData.processingTime = [
            { range: '< 1 jam', count: 423, percentage: 33.9 },
            { range: '1-2 jam', count: 387, percentage: 31.0 },
            { range: '2-4 jam', count: 298, percentage: 23.9 },
            { range: '4-8 jam', count: 89, percentage: 7.1 },
            { range: '> 8 jam', count: 50, percentage: 4.0 }
        ];
        
        // Generate monthly comparison data
        analyticsData.monthlyComparison = [];
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
        months.forEach(month => {
            analyticsData.monthlyComparison.push({
                month: month,
                thisYear: Math.floor(Math.random() * 500) + 300,
                lastYear: Math.floor(Math.random() * 400) + 250
            });
        });
    }
    
    // Initialize all charts
    function initializeCharts() {
        initTrendsChart();
        initDistributionChart();
        initProcessingTimeChart();
        initMonthlyComparisonChart();
        initStatusDistributionChart();
    }
    
    // Trends Chart
    function initTrendsChart() {
        const ctx = document.getElementById('trends-chart').getContext('2d');
        
        charts.trends = new Chart(ctx, {
            type: 'line',
            data: {
                labels: analyticsData.daily.map(d => {
                    const date = new Date(d.date);
                    return date.toLocaleDateString('id-ID', { month: 'short', day: 'numeric' });
                }),
                datasets: [{
                    label: 'Total Surat',
                    data: analyticsData.daily.map(d => d.letters),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Disetujui',
                    data: analyticsData.daily.map(d => d.approved),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Ditolak',
                    data: analyticsData.daily.map(d => d.rejected),
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Distribution Chart
    function initDistributionChart() {
        const ctx = document.getElementById('distribution-chart').getContext('2d');
        
        charts.distribution = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: analyticsData.letterTypes.map(t => t.name),
                datasets: [{
                    data: analyticsData.letterTypes.map(t => t.count),
                    backgroundColor: [
                        '#3b82f6',
                        '#10b981',
                        '#f59e0b',
                        '#ef4444',
                        '#8b5cf6',
                        '#6b7280'
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }