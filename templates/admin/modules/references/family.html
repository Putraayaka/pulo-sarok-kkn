{% extends 'admin/base.html' %}

{% block title %}Data Keluarga{% endblock %}

{% block page_title %}Data Keluarga{% endblock %}

{% block content %}
<div class="p-4 sm:p-6 space-y-6">
    <!-- Header Actions -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
        <div>
            <h2 class="text-lg font-semibold text-gray-900">Data Keluarga</h2>
            <p class="text-sm text-gray-500">Kelola data kartu keluarga dan informasi keluarga</p>
        </div>
        
        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
            <button onclick="exportData()" 
                    class="flex-1 sm:flex-none px-3 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700">
                <i class="fas fa-download mr-1"></i>Export
            </button>
            <button onclick="openCreateModal()" 
                    class="w-full sm:w-auto px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700">
                <i class="fas fa-plus mr-2"></i>Tambah Keluarga
            </button>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="bg-white rounded-lg shadow p-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="md:col-span-2">
                <input type="text" id="search" placeholder="Cari nomor KK, nama kepala keluarga..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
            </div>
            <div>
                <select id="dusun-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Semua Dusun</option>
                </select>
            </div>
            <div class="flex space-x-2">
                <button onclick="clearSearch()" class="px-3 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                    <i class="fas fa-times"></i>
                </button>
                <button onclick="refreshData()" class="px-3 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Cards (Hidden on Desktop) -->
    <div id="mobile-cards" class="block sm:hidden space-y-3">
        <!-- Dynamic mobile cards will be inserted here -->
    </div>

    <!-- Data Table (Hidden on Mobile) -->
    <div class="hidden sm:block bg-white rounded-lg shadow overflow-hidden table-compact">
        <div class="overflow-x-auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>No. KK</th>
                        <th>Kepala Keluarga</th>
                        <th>Status</th>
                        <th>Jumlah Anggota</th>
                        <th>Dusun</th>
                        <th>Kontak</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="pagination-container pagination-compact">
        <div class="pagination-info">
            <span id="pagination-info">Menampilkan 0 dari 0 data</span>
            <span id="total-info" class="text-primary-600 font-medium">Total Keluarga: 0 (Tahun 2025)</span>
        </div>
        <div class="pagination-controls">
            <div class="pagination-nav">
                <button id="prev-btn" onclick="previousPage()" class="pagination-btn nav-btn" disabled>
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="page-numbers" class="flex items-center gap-1"></div>
                <button id="next-btn" onclick="nextPage()" class="pagination-btn nav-btn" disabled>
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="crud-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 xl:w-2/3 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-lg font-medium text-gray-900">Tambah Keluarga</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="crud-form" class="space-y-6">
                <!-- Family Information -->
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-medium text-gray-900 mb-3">Informasi Kartu Keluarga</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nomor KK *</label>
                            <input type="text" name="kk_number" maxlength="16" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kepala Keluarga *</label>
                            <select name="head" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                <option value="">Pilih Kepala Keluarga</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status Keluarga</label>
                            <select name="family_status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                <option value="">Pilih Status</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Anggota</label>
                            <input type="number" name="total_members" min="1" value="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Total Pendapatan per Bulan (Rp)</label>
                            <input type="number" name="total_income" min="0" step="1000" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nomor Telepon</label>
                            <input type="text" name="phone_number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        </div>
                    </div>
                </div>

                <!-- Address Information -->
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h4 class="font-medium text-gray-900 mb-3">Alamat Keluarga</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dusun *</label>
                            <select name="dusun" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                <option value="">Pilih Dusun</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Lorong</label>
                            <select name="lorong" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                <option value="">Pilih Lorong</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">RT</label>
                            <input type="text" name="rt_number" maxlength="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">RW</label>
                            <input type="text" name="rw_number" maxlength="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nomor Rumah</label>
                            <input type="text" name="house_number" maxlength="10" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kode Pos</label>
                            <input type="text" name="postal_code" maxlength="5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Alamat Lengkap *</label>
                        <textarea name="address" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"></textarea>
                    </div>
                </div>

                <!-- Status -->
                <div class="bg-green-50 p-4 rounded-lg">
                    <h4 class="font-medium text-gray-900 mb-3">Status</h4>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="is_active" checked class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                            <span class="ml-2 text-sm text-gray-700">Aktif</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeModal()" 
                            class="w-full sm:w-auto px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Batal
                    </button>
                    <button type="submit" 
                            class="w-full sm:w-auto px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700">
                        <i class="fas fa-save mr-2"></i>Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Global variables
let currentPage = 1;
let currentEditId = null;
let choices = {};

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadChoices();
    loadData();
    setupEventListeners();
});

function setupEventListeners() {
    // Search
    document.getElementById('search').addEventListener('input', debounce(() => {
        currentPage = 1;
        loadData();
    }, 300));
    
    // Form submission
    document.getElementById('crud-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveData();
    });
}

function loadChoices() {
    fetch('{% url "references:family_create" %}')
        .then(response => response.json())
        .then(data => {
            choices = data;
            populateChoiceFields();
        });
}

function populateChoiceFields() {
    populateSelectField('head', choices.head_choices);
    populateSelectField('family_status', choices.family_status_choices);
    populateSelectField('dusun', choices.dusun_choices);
    populateSelectField('lorong', choices.lorong_choices);
}

function populateSelectField(fieldName, choices) {
    const field = document.querySelector(`[name="${fieldName}"]`);
    if (field && choices) {
        field.innerHTML = `<option value="">Pilih ${fieldName.replace('_', ' ')}</option>`;
        choices.forEach(choice => {
            const value = choice.value || choice.id;
            const label = choice.label || choice.name;
            field.innerHTML += `<option value="${value}">${label}</option>`;
        });
    }
}

function loadData() {
    const search = document.getElementById('search').value;
    const url = `{% url "references:family_list" %}?page=${currentPage}&search=${encodeURIComponent(search)}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            renderData(data.results);
            updatePagination(data.pagination || {});
        })
        .catch(error => {
            console.error('Error loading data:', error);
        });
}

function renderData(data) {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';
    
    data.forEach(family => {
        const row = `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${family.kk_number}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${family.head_name}</div>
                    <div class="text-sm text-gray-500">${family.head_nik}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                        ${family.family_status}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${family.total_members} orang</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${family.dusun}</div>
                    <div class="text-sm text-gray-500">${family.lorong || '-'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${family.phone_number || '-'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex space-x-2">
                        <button onclick="editItem(${family.id})" class="text-primary-600 hover:text-primary-900">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteItem(${family.id})" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
}

function openCreateModal() {
    currentEditId = null;
    document.getElementById('modal-title').textContent = 'Tambah Keluarga';
    document.getElementById('crud-form').reset();
    document.getElementById('crud-modal').classList.remove('hidden');
}

function editItem(id) {
    currentEditId = id;
    document.getElementById('modal-title').textContent = 'Edit Keluarga';
    
    fetch(`{% url "references:family_detail" 0 %}`.replace('0', id))
        .then(response => response.json())
        .then(data => {
            populateForm(data);
            document.getElementById('crud-modal').classList.remove('hidden');
        });
}

function populateForm(data) {
    Object.keys(data).forEach(key => {
        const field = document.querySelector(`[name="${key}"]`);
        if (field) {
            if (field.type === 'checkbox') {
                field.checked = data[key];
            } else {
                field.value = data[key] || '';
            }
        }
    });
}

function saveData() {
    const formData = new FormData(document.getElementById('crud-form'));
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // Handle checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        if (!data.hasOwnProperty(checkbox.name)) {
            data[checkbox.name] = false;
        } else {
            data[checkbox.name] = true;
        }
    });
    
    const url = currentEditId 
        ? `{% url "references:family_detail" 0 %}`.replace('0', currentEditId)
        : `{% url "references:family_create" %}`;
    
    const method = currentEditId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal();
            loadData();
            showToast(data.message, 'success');
        } else {
            showToast('Terjadi kesalahan saat menyimpan data', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving data:', error);
        showToast('Terjadi kesalahan sistem', 'error');
    });
}

function closeModal() {
    document.getElementById('crud-modal').classList.add('hidden');
    document.getElementById('crud-form').reset();
    currentEditId = null;
}

function clearSearch() {
    document.getElementById('search').value = '';
    document.getElementById('dusun-filter').value = '';
    currentPage = 1;
    loadData();
}

function refreshData() {
    loadData();
    showToast('Data berhasil dimuat ulang', 'success');
}

function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        loadData();
    }
}

function nextPage() {
    currentPage++;
    loadData();
}

function updatePagination(pagination) {
    const info = document.getElementById('pagination-info');
    const totalInfo = document.getElementById('total-info');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageNumbers = document.getElementById('page-numbers');
    
    const itemsPerPage = 10;
    const totalItems = pagination.total_items || 0;
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    
    if (pagination.total_items) {
        const start = ((pagination.current_page - 1) * itemsPerPage) + 1;
        const end = Math.min(pagination.current_page * itemsPerPage, pagination.total_items);
        info.textContent = `Menampilkan ${start}-${end} dari ${pagination.total_items} data`;
        totalInfo.textContent = `Total Keluarga: ${pagination.total_items} (Tahun 2025)`;
    } else {
        info.textContent = 'Menampilkan 0 dari 0 data';
        totalInfo.textContent = 'Total Keluarga: 0 (Tahun 2025)';
    }
    
    prevBtn.disabled = !pagination.has_previous;
    nextBtn.disabled = !pagination.has_next;
    
    // Generate page numbers
    pageNumbers.innerHTML = '';
    
    if (totalPages > 1) {
        const maxVisiblePages = window.innerWidth <= 640 ? 3 : 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        // Add first page if not visible
        if (startPage > 1) {
            const firstBtn = document.createElement('button');
            firstBtn.textContent = '1';
            firstBtn.className = 'pagination-btn page-number';
            firstBtn.onclick = () => goToPage(1);
            pageNumbers.appendChild(firstBtn);
            
            if (startPage > 2) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'px-2 text-gray-500 text-sm';
                pageNumbers.appendChild(ellipsis);
            }
        }
        
        // Add visible page numbers
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = i;
            pageBtn.className = `pagination-btn page-number ${
                i === currentPage ? 'active' : ''
            }`;
            pageBtn.onclick = () => goToPage(i);
            pageNumbers.appendChild(pageBtn);
        }
        
        // Add last page if not visible
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'px-2 text-gray-500 text-sm';
                pageNumbers.appendChild(ellipsis);
            }
            
            const lastBtn = document.createElement('button');
            lastBtn.textContent = totalPages;
            lastBtn.className = 'pagination-btn page-number';
            lastBtn.onclick = () => goToPage(totalPages);
            pageNumbers.appendChild(lastBtn);
        }
    }
}

function goToPage(page) {
    currentPage = page;
    loadData();
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-md shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}
