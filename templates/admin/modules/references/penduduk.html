{% extends 'admin/base.html' %}

{% block title %}Input Data Penduduk{% endblock %}

{% block page_title %}Input Data Penduduk{% endblock %}

{% block content %}
<div class="p-4 sm:p-6 space-y-6">
    <!-- Header Actions -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
        <div>
            <h2 class="text-lg font-semibold text-gray-900">Data Penduduk</h2>
            <p class="text-sm text-gray-500">Kelola data penduduk Gampong</p>
        </div>
        
        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
            <!-- Export/Import Buttons -->
            <div class="flex space-x-2">
                <button onclick="exportData()" 
                        class="flex-1 sm:flex-none px-3 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 focus:ring-2 focus:ring-green-500">
                    <i class="fas fa-download mr-1"></i>Export
                </button>
                <button onclick="importData()" 
                        class="flex-1 sm:flex-none px-3 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-upload mr-1"></i>Import
                </button>
            </div>
            
            <!-- Add Button -->
            <button onclick="openCreateModal()" 
                    class="w-full sm:w-auto px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:ring-2 focus:ring-primary-500">
                <i class="fas fa-plus mr-2"></i>Tambah Penduduk
            </button>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="bg-white rounded-lg shadow p-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="lg:col-span-2">
                <input type="text" id="search" placeholder="Cari nama, NIK, atau tempat lahir..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
            </div>
            <div>
                <select id="dusun-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                    <option value="">Semua Dusun</option>
                </select>
            </div>
            <div class="flex space-x-2">
                <button onclick="clearSearch()" 
                        class="flex-1 px-3 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                    <i class="fas fa-times"></i>
                </button>
                <button onclick="refreshData()" 
                        class="flex-1 px-3 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <!-- Bulk Actions -->
        <div id="bulk-actions" class="hidden bg-blue-50 px-4 py-3 border-b">
            <div class="flex items-center justify-between">
                <span class="text-sm text-blue-700">
                    <span id="selected-count">0</span> item dipilih
                </span>
                <div class="flex space-x-2">
                    <button onclick="bulkDelete()" 
                            class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                        <i class="fas fa-trash mr-1"></i>Hapus
                    </button>
                    <button onclick="clearSelection()" 
                            class="px-3 py-1 bg-gray-600 text-white text-sm rounded hover:bg-gray-700">
                        Batal
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Card View -->
        <div id="mobile-view" class="block sm:hidden">
            <div id="mobile-cards-container" class="divide-y divide-gray-200">
                <!-- Dynamic content for mobile -->
            </div>
        </div>

        <!-- Desktop Table View -->
        <div id="desktop-view" class="hidden sm:block overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left">
                            <input type="checkbox" id="select-all" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIK</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Kelamin</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Umur</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dusun</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Dynamic content -->
                </tbody>
            </table>
        </div>

        <!-- Loading State -->
        <div id="loading" class="hidden p-8 text-center">
            <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
            <p class="mt-2 text-gray-500">Memuat data...</p>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden p-8 text-center">
            <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Belum ada data penduduk</h3>
            <p class="text-gray-500 mb-4">Mulai dengan menambahkan data penduduk pertama</p>
            <button onclick="openCreateModal()" 
                    class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700">
                <i class="fas fa-plus mr-2"></i>Tambah Penduduk
            </button>
        </div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex items-center justify-between">
        <div class="flex items-center text-sm text-gray-700">
            <span id="pagination-info">Menampilkan 0 dari 0 data</span>
        </div>
        <div class="flex space-x-2">
            <button id="prev-btn" onclick="previousPage()" 
                    class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50" disabled>
                <i class="fas fa-chevron-left"></i>
            </button>
            <button id="next-btn" onclick="nextPage()" 
                    class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50" disabled>
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="crud-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 xl:w-2/3 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-lg font-medium text-gray-900">Tambah Penduduk</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="crud-form" class="space-y-6">
                <!-- Personal Information -->
                <div>
                    <h4 class="text-md font-medium text-gray-900 mb-3">Informasi Personal</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap *</label>
                            <input type="text" name="name" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">NIK *</label>
                            <input type="text" name="nik" required maxlength="16" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin *</label>
                            <select name="gender" required id="gender-select"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                <option value="">Pilih Jenis Kelamin</option>
                                <option value="L">Laki-laki</option>
                                <option value="P">Perempuan</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tempat Lahir *</label>
                            <input type="text" name="birth_place" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Lahir *</label>
                            <input type="date" name="birth_date" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Agama *</label>
                            <input type="text" name="religion" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pendidikan</label>
                            <input type="text" name="education" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Pekerjaan</label>
                            <input type="text" name="occupation" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status Perkawinan *</label>
                            <select name="marital_status" required id="marital-status-select"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                <option value="">Pilih Status</option>
                                <option value="BELUM_KAWIN">Belum Kawin</option>
                                <option value="KAWIN">Kawin</option>
                                <option value="CERAI_HIDUP">Cerai Hidup</option>
                                <option value="CERAI_MATI">Cerai Mati</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Address Information -->
                <div>
                    <h4 class="text-md font-medium text-gray-900 mb-3">Informasi Alamat</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dusun *</label>
                            <select name="dusun" required id="dusun-select"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                <option value="">Pilih Dusun</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Lorong</label>
                            <select name="lorong" id="lorong-select"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                <option value="">Pilih Lorong</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Alamat Lengkap *</label>
                        <textarea name="address" required rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"></textarea>
                    </div>
                </div>

                <div>
                    <label class="flex items-center">
                        <input type="checkbox" name="is_active" checked 
                               class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        <span class="ml-2 text-sm text-gray-700">Aktif</span>
                    </label>
                </div>
                
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeModal()" 
                            class="w-full sm:w-auto px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Batal
                    </button>
                    <button type="submit" 
                            class="w-full sm:w-auto px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700">
                        <i class="fas fa-save mr-2"></i>Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Konfirmasi Hapus</h3>
            <p class="text-sm text-gray-500 mb-6">Apakah Anda yakin ingin menghapus data ini? Tindakan ini tidak dapat dibatalkan.</p>
            
            <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-3">
                <button onclick="closeDeleteModal()" 
                        class="w-full sm:w-auto px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                    Batal
                </button>
                <button id="confirm-delete-btn" 
                        class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                    <i class="fas fa-trash mr-2"></i>Hapus
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="import-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Import Data Penduduk</h3>
                <button onclick="closeImportModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="import-form" enctype="multipart/form-data">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">File Excel/CSV</label>
                        <input type="file" name="file" accept=".xlsx,.xls,.csv" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        <p class="mt-1 text-sm text-gray-500">Format yang didukung: .xlsx, .xls, .csv</p>
                    </div>
                    
                    <div class="bg-yellow-50 p-4 rounded-md">
                        <h4 class="text-sm font-medium text-yellow-800 mb-2">Format File:</h4>
                        <p class="text-sm text-yellow-700">Kolom yang diperlukan: nik, name, gender, birth_place, birth_date, religion, education, occupation, marital_status, dusun__name, lorong__name, address</p>
                        <button type="button" onclick="downloadTemplate()" class="mt-2 text-sm text-primary-600 hover:text-primary-800">
                            <i class="fas fa-download mr-1"></i>Download Template
                        </button>
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 pt-4 border-t mt-6">
                    <button type="button" onclick="closeImportModal()" 
                            class="w-full sm:w-auto px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Batal
                    </button>
                    <button type="submit" 
                            class="w-full sm:w-auto px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700">
                        <i class="fas fa-upload mr-2"></i>Import
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Global variables
let currentPage = 1;
let currentEditId = null;
let currentDeleteId = null;
let selectedItems = new Set();
let dusunList = [];
let lorongList = [];

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadDusunList();
    loadData();
    setupEventListeners();
});

function setupEventListeners() {
    // Search
    document.getElementById('search').addEventListener('input', debounce(() => {
        currentPage = 1;
        loadData();
    }, 300));
    
    // Dusun filter
    document.getElementById('dusun-filter').addEventListener('change', () => {
        currentPage = 1;
        loadData();
    });
    
    // Dusun select change
    document.getElementById('dusun-select').addEventListener('change', function() {
        loadLorongByDusun(this.value);
    });
    
    // Select all checkbox
    document.getElementById('select-all').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.item-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = this.checked;
            if (this.checked) {
                selectedItems.add(cb.value);
            } else {
                selectedItems.delete(cb.value);
            }
        });
        updateBulkActions();
    });
    
    // Form submission
    document.getElementById('crud-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveData();
    });
    
    // Import form
    document.getElementById('import-form').addEventListener('submit', function(e) {
        e.preventDefault();
        handleImport();
    });
}

function loadDusunList() {
    fetch(`{% url "references:dusun_list" %}`)
        .then(response => response.json())
        .then(data => {
            dusunList = data.results;
            
            // Populate filter dropdown
            const filterSelect = document.getElementById('dusun-filter');
            filterSelect.innerHTML = '<option value="">Semua Dusun</option>';
            data.results.forEach(dusun => {
                filterSelect.innerHTML += `<option value="${dusun.id}">${dusun.name}</option>`;
            });
            
            // Populate modal dropdown
            const modalSelect = document.getElementById('dusun-select');
            modalSelect.innerHTML = '<option value="">Pilih Dusun</option>';
            data.results.forEach(dusun => {
                modalSelect.innerHTML += `<option value="${dusun.id}">${dusun.name}</option>`;
            });
        })
        .catch(error => console.error('Error loading dusun list:', error));
}

function loadLorongByDusun(dusunId) {
    const lorongSelect = document.getElementById('lorong-select');
    lorongSelect.innerHTML = '<option value="">Pilih Lorong</option>';
    
    if (!dusunId) return;
    
    fetch(`{% url "references:lorong_list" %}?dusun_id=${dusunId}`)
        .then(response => response.json())
        .then(data => {
            data.results.forEach(lorong => {
                lorongSelect.innerHTML += `<option value="${lorong.id}">${lorong.name}</option>`;
            });
        })
        .catch(error => console.error('Error loading lorong list:', error));
}

function loadData() {
    showLoading();
    const search = document.getElementById('search').value;
    const dusunId = document.getElementById('dusun-filter').value;
    let url = `{% url "references:penduduk_list" %}?page=${currentPage}&search=${encodeURIComponent(search)}`;
    if (dusunId) {
        url += `&dusun_id=${dusunId}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.results && data.results.length > 0) {
                renderData(data.results);
                updatePagination(data.pagination || {});
                hideEmptyState();
            } else {
                showEmptyState();
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error loading data:', error);
            showToast('Terjadi kesalahan saat memuat data', 'error');
        });
}

function renderData(data) {
    renderDesktopView(data);
    renderMobileView(data);
}

function renderDesktopView(data) {
    const tbody = document.getElementById('table-body');
    tbody.innerHTML = '';
    
    data.forEach(item => {
        const row = `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                    <input type="checkbox" class="item-checkbox rounded border-gray-300 text-primary-600 focus:ring-primary-500" 
                           value="${item.id}" onchange="toggleSelection(this)">
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${item.name}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${item.nik}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${item.gender}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${item.age} tahun</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${item.dusun}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${item.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${item.is_active ? 'Aktif' : 'Tidak Aktif'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex space-x-2">
                        <button onclick="editItem(${item.id})" class="text-primary-600 hover:text-primary-900" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-900" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
}

function renderMobileView(data) {
    const container = document.getElementById('mobile-cards-container');
    container.innerHTML = '';
    
    data.forEach(item => {
        const card = `
            <div class="p-4 hover:bg-gray-50">
                <div class="flex items-start justify-between">
                    <div class="flex items-start space-x-3">
                        <input type="checkbox" class="item-checkbox mt-1 rounded border-gray-300 text-primary-600 focus:ring-primary-500" 
                               value="${item.id}" onchange="toggleSelection(this)">
                        <div class="flex-1">
                            <h3 class="text-sm font-medium text-gray-900">${item.name}</h3>
                            <p class="text-sm text-gray-500">NIK: ${item.nik}</p>
                            <p class="text-sm text-gray-500">${item.gender}, ${item.age} tahun</p>
                            <p class="text-sm text-gray-500">Dusun: ${item.dusun}</p>
                            <div class="mt-2">
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${item.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${item.is_active ? 'Aktif' : 'Tidak Aktif'}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editItem(${item.id})" class="text-primary-600 hover:text-primary-900 p-2" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-900 p-2" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', card);
    });
}

function toggleSelection(checkbox) {
    if (checkbox.checked) {
        selectedItems.add(checkbox.value);
    } else {
        selectedItems.delete(checkbox.value);
    }
    updateBulkActions();
}

function updateBulkActions() {
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');
    
    if (selectedItems.size > 0) {
        bulkActions.classList.remove('hidden');
        selectedCount.textContent = selectedItems.size;
    } else {
        bulkActions.classList.add('hidden');
    }
}

function clearSelection() {
    selectedItems.clear();
    document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
    updateBulkActions();
}

// CRUD Operations
function openCreateModal() {
    currentEditId = null;
    document.getElementById('modal-title').textContent = 'Tambah Penduduk';
    document.getElementById('crud-form').reset();
    document.getElementById('lorong-select').innerHTML = '<option value="">Pilih Lorong</option>';
    document.getElementById('crud-modal').classList.remove('hidden');
}

function editItem(id) {
    currentEditId = id;
    document.getElementById('modal-title').textContent = 'Edit Penduduk';
    
    fetch(`{% url "references:penduduk_detail" 0 %}`.replace('0', id))
        .then(response => response.json())
        .then(data => {
            populateForm(data);
            document.getElementById('crud-modal').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error loading item:', error);
            showToast('Terjadi kesalahan saat memuat data', 'error');
        });
}

function populateForm(data) {
    Object.keys(data).forEach(key => {
        const field = document.querySelector(`[name="${key}"]`);
        if (field) {
            if (field.type === 'checkbox') {
                field.checked = data[key];
            } else if (key === 'dusun_id') {
                document.querySelector('[name="dusun"]').value = data[key] || '';
                if (data[key]) {
                    loadLorongByDusun(data[key]);
                    setTimeout(() => {
                        document.querySelector('[name="lorong"]').value = data['lorong_id'] || '';
                    }, 500);
                }
            } else if (key === 'lorong_id') {
                // Will be handled after dusun is set
            } else {
                field.value = data[key] || '';
            }
        }
    });
}

function saveData() {
    const formData = new FormData(document.getElementById('crud-form'));
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // Handle checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        if (!data.hasOwnProperty(checkbox.name)) {
            data[checkbox.name] = false;
        } else {
            data[checkbox.name] = true;
        }
    });
    
    const url = currentEditId 
        ? `{% url "references:penduduk_detail" 0 %}`.replace('0', currentEditId)
        : `{% url "references:penduduk_create" %}`;
    
    const method = currentEditId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal();
            loadData();
            showToast(data.message, 'success');
        } else {
            showToast('Terjadi kesalahan saat menyimpan data', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving data:', error);
        showToast('Terjadi kesalahan sistem', 'error');
    });
}

function deleteItem(id) {
    currentDeleteId = id;
    document.getElementById('delete-modal').classList.remove('hidden');
}

function confirmDelete() {
    if (!currentDeleteId) return;
    
    fetch(`{% url "references:penduduk_detail" 0 %}`.replace('0', currentDeleteId), {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        closeDeleteModal();
        if (data.success) {
            loadData();
            showToast(data.message, 'success');
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting item:', error);
        showToast('Terjadi kesalahan sistem', 'error');
    });
}

function bulkDelete() {
    if (selectedItems.size === 0) return;
    
    if (confirm(`Apakah Anda yakin ingin menghapus ${selectedItems.size} item?`)) {
        const promises = Array.from(selectedItems).map(id => 
            fetch(`{% url "references:penduduk_detail" 0 %}`.replace('0', id), {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
        );
        
        Promise.all(promises)
            .then(() => {
                clearSelection();
                loadData();
                showToast('Data berhasil dihapus', 'success');
            })
            .catch(error => {
                console.error('Error in bulk delete:', error);
                showToast('Terjadi kesalahan saat menghapus data', 'error');
            });
    }
}

// Export/Import Functions
function exportData() {
    window.location.href = `{% url "references:export_data" "penduduk" %}`;
    showToast('Export dimulai, file akan diunduh segera', 'success');
}

function importData() {
    document.getElementById('import-modal').classList.remove('hidden');
}

function handleImport() {
    const formData = new FormData(document.getElementById('import-form'));
    
    fetch(`{% url "references:import_data" "penduduk" %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        closeImportModal();
        if (data.success) {
            loadData();
            showToast(data.message, 'success');
        } else {
            showToast(data.message || 'Terjadi kesalahan saat import', 'error');
        }
    })
    .catch(error => {
        console.error('Error importing data:', error);
        showToast('Terjadi kesalahan sistem', 'error');
    });
}

function downloadTemplate() {
    window.location.href = `{% url "references:export_data" "penduduk" %}?template=true`;
}

// Utility Functions
function closeModal() {
    document.getElementById('crud-modal').classList.add('hidden');
    document.getElementById('crud-form').reset();
    currentEditId = null;
}

function closeDeleteModal() {
    document.getElementById('delete-modal').classList.add('hidden');
    currentDeleteId = null;
}

function closeImportModal() {
    document.getElementById('import-modal').classList.add('hidden');
    document.getElementById('import-form').reset();
}

function showLoading() {
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('desktop-view').classList.add('hidden');
    document.getElementById('mobile-view').classList.add('hidden');
}

function hideLoading() {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('desktop-view').classList.remove('hidden', 'sm:block');
    document.getElementById('desktop-view').classList.add('hidden', 'sm:block');
    document.getElementById('mobile-view').classList.remove('hidden', 'block');
    document.getElementById('mobile-view').classList.add('block', 'sm:hidden');
}

function showEmptyState() {
    document.getElementById('empty-state').classList.remove('hidden');
    document.getElementById('desktop-view').classList.add('hidden');
    document.getElementById('mobile-view').classList.add('hidden');
}

function hideEmptyState() {
    document.getElementById('empty-state').classList.add('hidden');
}

function clearSearch() {
    document.getElementById('search').value = '';
    document.getElementById('dusun-filter').value = '';
    currentPage = 1;
    loadData();
}

function refreshData() {
    loadData();
    showToast('Data berhasil dimuat ulang', 'success');
}

function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        loadData();
    }
}

function nextPage() {
    currentPage++;
    loadData();
}

function updatePagination(pagination) {
    const info = document.getElementById('pagination-info');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    if (pagination.total_items) {
        const start = ((pagination.current_page - 1) * 10) + 1;
        const end = Math.min(pagination.current_page * 10, pagination.total_items);
        info.textContent = `Menampilkan ${start}-${end} dari ${pagination.total_items} data`;
    }
    
    prevBtn.disabled = !pagination.has_previous;
    nextBtn.disabled = !pagination.has_next;
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-md shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Set up delete confirmation
document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete);
</script>
{% endblock %}
