{% extends 'admin/base.html' %}

{% block title %}Dashboard Data Referensi{% endblock %}

{% block page_title %}Dashboard Data Referensi{% endblock %}

{% block content %}
<div class="p-4 sm:p-6 space-y-6">
    <!-- Quick Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-users text-3xl opacity-80"></i>
                </div>
                <div class="ml-4">
                    <p class="text-blue-100 text-sm font-medium">Total Penduduk</p>
                    <p class="text-3xl font-bold" id="total-penduduk">-</p>
                    <p class="text-blue-100 text-xs" id="penduduk-growth">+0 bulan ini</p>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-map-marker-alt text-3xl opacity-80"></i>
                </div>
                <div class="ml-4">
                    <p class="text-green-100 text-sm font-medium">Total Dusun</p>
                    <p class="text-3xl font-bold" id="total-dusun">-</p>
                    <p class="text-green-100 text-xs" id="avg-population">Rata-rata 0 penduduk</p>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-r from-yellow-500 to-orange-500 rounded-lg shadow-lg p-6 text-white">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-road text-3xl opacity-80"></i>
                </div>
                <div class="ml-4">
                    <p class="text-yellow-100 text-sm font-medium">Total Lorong</p>
                    <p class="text-3xl font-bold" id="total-lorong">-</p>
                    <p class="text-yellow-100 text-xs" id="avg-houses">Rata-rata 0 rumah</p>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg shadow-lg p-6 text-white">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-wheelchair text-3xl opacity-80"></i>
                </div>
                <div class="ml-4">
                    <p class="text-purple-100 text-sm font-medium">Data Disabilitas</p>
                    <p class="text-3xl font-bold" id="total-disabilitas">-</p>
                    <p class="text-purple-100 text-xs" id="disability-percentage">0% dari populasi</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Demographics & Quick Actions -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Demographics Chart -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Demografi Penduduk</h3>
                <div class="flex space-x-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <i class="fas fa-male mr-1"></i><span id="male-percentage">0%</span> Laki-laki
                    </span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-pink-100 text-pink-800">
                        <i class="fas fa-female mr-1"></i><span id="female-percentage">0%</span> Perempuan
                    </span>
                </div>
            </div>
            
            <!-- Age Groups Chart -->
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">Anak (0-17 tahun)</span>
                        <span id="anak-count" class="font-medium">0 orang</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" id="anak-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">Dewasa (18-59 tahun)</span>
                        <span id="dewasa-count" class="font-medium">0 orang</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full" id="dewasa-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">Lansia (60+ tahun)</span>
                        <span id="lansia-count" class="font-medium">0 orang</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-orange-500 h-2 rounded-full" id="lansia-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Average Age -->
            <div class="mt-6 text-center">
                <span class="text-2xl font-bold text-gray-700" id="average-age">0</span>
                <span class="text-gray-500 ml-1">tahun rata-rata usia</span>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Aksi Cepat</h3>
            <div class="space-y-3">
                <a href="{% url 'references:penduduk_admin' %}" 
                   class="w-full flex items-center justify-between p-3 text-left border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex items-center">
                        <i class="fas fa-user-plus text-blue-600 mr-3"></i>
                        <span class="font-medium text-gray-900">Tambah Penduduk</span>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </a>
                
                <a href="{% url 'references:dusun_admin' %}" 
                   class="w-full flex items-center justify-between p-3 text-left border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex items-center">
                        <i class="fas fa-map-marker-alt text-green-600 mr-3"></i>
                        <span class="font-medium text-gray-900">Kelola Dusun</span>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </a>
                
                <a href="{% url 'references:lorong_admin' %}" 
                   class="w-full flex items-center justify-between p-3 text-left border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex items-center">
                        <i class="fas fa-road text-yellow-600 mr-3"></i>
                        <span class="font-medium text-gray-900">Kelola Lorong</span>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </a>
                
                <a href="{% url 'references:disabilitas_admin' %}" 
                   class="w-full flex items-center justify-between p-3 text-left border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex items-center">
                        <i class="fas fa-wheelchair text-purple-600 mr-3"></i>
                        <span class="font-medium text-gray-900">Data Disabilitas</span>
                    </div>
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </a>
                
                <div class="border-t pt-3 mt-4">
                    <button onclick="generateDummyData()" 
                            class="w-full flex items-center justify-center p-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                        <i class="fas fa-database mr-2"></i>
                        <span class="font-medium">Generate Data Dummy</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Population by Dusun -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Populasi per Dusun</h3>
            <div class="space-y-3" id="dusun-population-chart">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>

        <!-- Disability Statistics -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Statistik Disabilitas</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Total Penyandang Disabilitas</span>
                    <span class="font-bold text-lg" id="total-disability-count">0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Memerlukan Bantuan</span>
                    <span class="font-bold text-lg text-red-600" id="needs-assistance-count">0</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Persentase dari Populasi</span>
                    <span class="font-bold text-lg text-blue-600" id="disability-population-percentage">0%</span>
                </div>
                
                <!-- Disability Types Chart -->
                <div class="mt-6">
                    <h4 class="font-medium text-gray-900 mb-3">Jenis Disabilitas</h4>
                    <div id="disability-types-chart" class="space-y-2">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Religion & Education Distribution -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Religion Distribution -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Distribusi Agama</h3>
            <div class="space-y-3" id="religion-chart">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>

        <!-- Education Distribution -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Distribusi Pendidikan</h3>
            <div class="space-y-3" id="education-chart">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Aktivitas Terbaru (30 Hari Terakhir)</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center">
                <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-user-plus text-2xl text-blue-600"></i>
                </div>
                <div class="text-2xl font-bold text-gray-900" id="recent-residents">0</div>
                <div class="text-sm text-gray-500">Penduduk Baru</div>
            </div>
            <div class="text-center">
                <div class="bg-purple-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-wheelchair text-2xl text-purple-600"></i>
                </div>
                <div class="text-2xl font-bold text-gray-900" id="recent-disabilities">0</div>
                <div class="text-sm text-gray-500">Data Disabilitas Baru</div>
            </div>
            <div class="text-center">
                <div class="bg-green-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-chart-line text-2xl text-green-600"></i>
                </div>
                <div class="text-2xl font-bold text-gray-900" id="growth-rate">0%</div>
                <div class="text-sm text-gray-500">Tingkat Pertumbuhan</div>
            </div>
        </div>
    </div>

    <!-- Data Management Tabs -->
    <div class="bg-white rounded-lg shadow">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-button active" data-tab="penduduk">
                    <i class="fas fa-users mr-2"></i>Data Penduduk
                </button>
                <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-button" data-tab="dusun">
                    <i class="fas fa-map-marker-alt mr-2"></i>Data Dusun
                </button>
                <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-button" data-tab="lorong">
                    <i class="fas fa-road mr-2"></i>Data Lorong
                </button>
                <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-button" data-tab="disabilitas">
                    <i class="fas fa-wheelchair mr-2"></i>Data Disabilitas
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="p-6">
            <!-- Penduduk Tab -->
            <div id="penduduk-tab" class="tab-content">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                    <h3 class="text-lg font-medium text-gray-900">Data Penduduk</h3>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                        <input type="text" id="penduduk-search" placeholder="Cari penduduk..." 
                               class="w-full sm:w-64 px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        <button onclick="openCreateModal('penduduk')" 
                                class="w-full sm:w-auto px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:ring-2 focus:ring-primary-500">
                            <i class="fas fa-plus mr-2"></i>Tambah Penduduk
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIK</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Kelamin</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Umur</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dusun</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="penduduk-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div id="penduduk-pagination" class="flex items-center justify-between mt-6">
                    <div class="flex items-center text-sm text-gray-700">
                        <span id="penduduk-info">Menampilkan 0 dari 0 data</span>
                    </div>
                    <div class="flex space-x-2">
                        <button id="penduduk-prev" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button id="penduduk-next" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dusun Tab -->
            <div id="dusun-tab" class="tab-content hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                    <h3 class="text-lg font-medium text-gray-900">Data Dusun</h3>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                        <input type="text" id="dusun-search" placeholder="Cari dusun..." 
                               class="w-full sm:w-64 px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        <button onclick="openCreateModal('dusun')" 
                                class="w-full sm:w-auto px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:ring-2 focus:ring-primary-500">
                            <i class="fas fa-plus mr-2"></i>Tambah Dusun
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Luas Area (Ha)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah Penduduk</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="dusun-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Lorong Tab -->
            <div id="lorong-tab" class="tab-content hidden">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                    <h3 class="text-lg font-medium text-gray-900">Data Lorong</h3>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                        <input type="text" id="lorong-search" placeholder="Cari lorong..." 
                               class="w-full sm:w-64 px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                        <button onclick="openCreateModal('lorong')" 
                                class="w-full sm:w-auto px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:ring-2 focus:ring-primary-500">
                            <i class="fas fa-plus mr-2"></i>Tambah Lorong
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dusun</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Panjang (m)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah Rumah</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="lorong-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Disabilitas Tab -->
            <div id="disabilitas-tab" class="tab-content hidden">
                <div class="space-y-6">
                    <!-- Sub-tabs for Disabilitas -->
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8" aria-label="Sub-tabs">
                            <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm sub-tab-button active" data-subtab="disabilitas-type">
                                Jenis Disabilitas
                            </button>
                            <button class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm sub-tab-button" data-subtab="disabilitas-data">
                                Data Disabilitas
                            </button>
                        </nav>
                    </div>

                    <!-- Disabilitas Type Sub-tab -->
                    <div id="disabilitas-type-subtab" class="sub-tab-content">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                            <h4 class="text-md font-medium text-gray-900">Jenis Disabilitas</h4>
                            <button onclick="openCreateModal('disabilitas-type')" 
                                    class="w-full sm:w-auto px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:ring-2 focus:ring-primary-500">
                                <i class="fas fa-plus mr-2"></i>Tambah Jenis
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Kasus</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="disabilitas-type-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Dynamic content will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Disabilitas Data Sub-tab -->
                    <div id="disabilitas-data-subtab" class="sub-tab-content hidden">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                            <h4 class="text-md font-medium text-gray-900">Data Disabilitas</h4>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                                <input type="text" id="disabilitas-data-search" placeholder="Cari data disabilitas..." 
                                       class="w-full sm:w-64 px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                <button onclick="openCreateModal('disabilitas-data')" 
                                        class="w-full sm:w-auto px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:ring-2 focus:ring-primary-500">
                                    <i class="fas fa-plus mr-2"></i>Tambah Data
                                </button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Penduduk</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIK</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Disabilitas</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tingkat</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Perlu Bantuan</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="disabilitas-data-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Dynamic content will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination for Disabilitas Data -->
                        <div id="disabilitas-data-pagination" class="flex items-center justify-between mt-6">
                            <div class="flex items-center text-sm text-gray-700">
                                <span id="disabilitas-data-info">Menampilkan 0 dari 0 data</span>
                            </div>
                            <div class="flex space-x-2">
                                <button id="disabilitas-data-prev" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50" disabled>
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button id="disabilitas-data-next" class="px-3 py-2 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50" disabled>
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="crud-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 xl:w-1/3 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-lg font-medium text-gray-900">Tambah Data</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="crud-form" class="space-y-4">
                <div id="form-fields">
                    <!-- Dynamic form fields will be loaded here -->
                </div>
                
                <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeModal()" 
                            class="w-full sm:w-auto px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Batal
                    </button>
                    <button type="submit" 
                            class="w-full sm:w-auto px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700">
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Konfirmasi Hapus</h3>
            <p class="text-sm text-gray-500 mb-6">Apakah Anda yakin ingin menghapus data ini? Tindakan ini tidak dapat dibatalkan.</p>
            
            <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-3">
                <button onclick="closeDeleteModal()" 
                        class="w-full sm:w-auto px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                    Batal
                </button>
                <button id="confirm-delete-btn" 
                        class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                    Hapus
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let currentTab = 'penduduk';
let currentSubTab = 'disabilitas-type';
let currentPage = 1;
let currentEditId = null;
let currentDeleteId = null;
let currentDeleteType = null;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    loadTabData(currentTab);
    
    // Setup tab switching
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            switchTab(this.getAttribute('data-tab'));
        });
    });
    
    // Setup sub-tab switching
    document.querySelectorAll('.sub-tab-button').forEach(button => {
        button.addEventListener('click', function() {
            switchSubTab(this.getAttribute('data-subtab'));
        });
    });
    
    // Setup search functionality
    setupSearchHandlers();
    
    // Setup pagination
    setupPaginationHandlers();
});

// Load dashboard statistics
function loadStatistics() {
    // Load basic stats
    fetch('{% url "references:references_stats" %}')
        .then(response => response.json())
        .then(data => {
            // Update basic counts
            document.getElementById('total-penduduk').textContent = data.basic_stats.total_penduduk;
            document.getElementById('total-dusun').textContent = data.basic_stats.total_dusun;
            document.getElementById('total-lorong').textContent = data.basic_stats.total_lorong;
            document.getElementById('total-disabilitas').textContent = data.basic_stats.total_disabilitas;
            
            // Update demographics
            const totalPenduduk = data.basic_stats.total_penduduk;
            if (totalPenduduk > 0) {
                const malePercentage = Math.round((data.demographics.male_count / totalPenduduk) * 100);
                const femalePercentage = Math.round((data.demographics.female_count / totalPenduduk) * 100);
                
                document.getElementById('male-percentage').textContent = malePercentage + '%';
                document.getElementById('female-percentage').textContent = femalePercentage + '%';
                
                // Update age groups
                const ageGroups = data.demographics.age_groups;
                const totalAgeGroup = ageGroups.anak + ageGroups.dewasa + ageGroups.lansia;
                
                document.getElementById('anak-count').textContent = ageGroups.anak + ' orang';
                document.getElementById('dewasa-count').textContent = ageGroups.dewasa + ' orang';
                document.getElementById('lansia-count').textContent = ageGroups.lansia + ' orang';
                
                if (totalAgeGroup > 0) {
                    document.getElementById('anak-bar').style.width = Math.round((ageGroups.anak / totalAgeGroup) * 100) + '%';
                    document.getElementById('dewasa-bar').style.width = Math.round((ageGroups.dewasa / totalAgeGroup) * 100) + '%';
                    document.getElementById('lansia-bar').style.width = Math.round((ageGroups.lansia / totalAgeGroup) * 100) + '%';
                }
            }
            
            // Update recent activity
            document.getElementById('recent-residents').textContent = data.recent_activity.new_penduduk;
            document.getElementById('recent-disabilities').textContent = data.recent_activity.new_disabilitas;
            
            // Update disability statistics
            document.getElementById('total-disability-count').textContent = data.basic_stats.total_disabilitas;
            const disabilityPercentage = totalPenduduk > 0 ? Math.round((data.basic_stats.total_disabilitas / totalPenduduk) * 100) : 0;
            document.getElementById('disability-population-percentage').textContent = disabilityPercentage + '%';
            document.getElementById('disability-percentage').textContent = disabilityPercentage + '% dari populasi';
            
            // Update population by dusun chart
            renderDusunPopulationChart(data.population_by_dusun);
            
            // Update disability types chart
            renderDisabilityTypesChart(data.disability.by_type);
            
            // Update religion chart
            renderReligionChart(data.distributions.religion);
            
            // Update education chart
            renderEducationChart(data.distributions.education);
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
            showToast('Gagal memuat statistik dashboard', 'error');
        });
    
    // Load enhanced stats
    fetch('{% url "references:dashboard_summary" %}')
        .then(response => response.json())
        .then(data => {
            // Update enhanced statistics
            document.getElementById('avg-population').textContent = `Rata-rata ${data.avg_population_per_dusun} penduduk`;
            document.getElementById('avg-houses').textContent = `Rata-rata ${data.avg_houses_per_lorong} rumah`;
            document.getElementById('average-age').textContent = data.average_age;
            document.getElementById('penduduk-growth').textContent = `+${data.new_residents_month} bulan ini`;
            document.getElementById('needs-assistance-count').textContent = data.needs_assistance_count;
            
            // Calculate growth rate
            const totalPenduduk = data.total_penduduk;
            const growthRate = totalPenduduk > 0 ? Math.round((data.new_residents_month / totalPenduduk) * 100 * 12) : 0; // Annualized
            document.getElementById('growth-rate').textContent = growthRate + '%';
        })
        .catch(error => {
            console.error('Error loading enhanced statistics:', error);
        });
}

// Render dusun population chart
function renderDusunPopulationChart(data) {
    const container = document.getElementById('dusun-population-chart');
    container.innerHTML = '';
    
    if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center">Tidak ada data</p>';
        return;
    }
    
    const maxCount = Math.max(...data.map(item => item.count));
    
    data.slice(0, 8).forEach(item => {
        const percentage = maxCount > 0 ? (item.count / maxCount) * 100 : 0;
        const bar = `
            <div class="flex items-center space-x-3">
                <div class="w-20 text-sm text-gray-600 truncate">${item.dusun__name}</div>
                <div class="flex-1 bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                </div>
                <div class="w-12 text-sm font-medium text-gray-900">${item.count}</div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', bar);
    });
}

// Render disability types chart
function renderDisabilityTypesChart(data) {
    const container = document.getElementById('disability-types-chart');
    container.innerHTML = '';
    
    if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center text-sm">Tidak ada data</p>';
        return;
    }
    
    const maxCount = Math.max(...data.map(item => item.count));
    const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500', 'bg-blue-500', 'bg-purple-500'];
    
    data.slice(0, 6).forEach((item, index) => {
        const percentage = maxCount > 0 ? (item.count / maxCount) * 100 : 0;
        const colorClass = colors[index % colors.length];
        const bar = `
            <div class="flex items-center space-x-2">
                <div class="w-24 text-xs text-gray-600 truncate">${item.disability_type__name}</div>
                <div class="flex-1 bg-gray-200 rounded-full h-1.5">
                    <div class="${colorClass} h-1.5 rounded-full" style="width: ${percentage}%"></div>
                </div>
                <div class="w-8 text-xs font-medium text-gray-900">${item.count}</div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', bar);
    });
}

// Render religion chart
function renderReligionChart(data) {
    const container = document.getElementById('religion-chart');
    container.innerHTML = '';
    
    if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center">Tidak ada data</p>';
        return;
    }
    
    const maxCount = Math.max(...data.map(item => item.count));
    const colors = ['bg-green-500', 'bg-blue-500', 'bg-purple-500', 'bg-orange-500', 'bg-red-500', 'bg-indigo-500'];
    
    data.slice(0, 6).forEach((item, index) => {
        const percentage = maxCount > 0 ? (item.count / maxCount) * 100 : 0;
        const colorClass = colors[index % colors.length];
        const bar = `
            <div class="flex items-center space-x-3">
                <div class="w-20 text-sm text-gray-600 truncate">${item.religion}</div>
                <div class="flex-1 bg-gray-200 rounded-full h-2">
                    <div class="${colorClass} h-2 rounded-full" style="width: ${percentage}%"></div>
                </div>
                <div class="w-12 text-sm font-medium text-gray-900">${item.count}</div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', bar);
    });
}

// Render education chart
function renderEducationChart(data) {
    const container = document.getElementById('education-chart');
    container.innerHTML = '';
    
    if (!data || data.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center">Tidak ada data</p>';
        return;
    }
    
    const maxCount = Math.max(...data.map(item => item.count));
    const colors = ['bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-red-500', 'bg-purple-500', 'bg-indigo-500'];
    
    data.slice(0, 6).forEach((item, index) => {
        const percentage = maxCount > 0 ? (item.count / maxCount) * 100 : 0;
        const colorClass = colors[index % colors.length];
        const bar = `
            <div class="flex items-center space-x-3">
                <div class="w-16 text-sm text-gray-600 truncate">${item.education}</div>
                <div class="flex-1 bg-gray-200 rounded-full h-2">
                    <div class="${colorClass} h-2 rounded-full" style="width: ${percentage}%"></div>
                </div>
                <div class="w-12 text-sm font-medium text-gray-900">${item.count}</div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', bar);
    });
}

// Generate dummy data function
function generateDummyData() {
    if (confirm('Apakah Anda yakin ingin generate data dummy? Ini akan membuat data contoh untuk testing.')) {
        showToast('Sedang generate data dummy...', 'info');
        
        // Note: This would call a Django management command
        // For now, we'll show a message
        setTimeout(() => {
            showToast('Fitur generate data dummy sedang dalam pengembangan. Silakan jalankan: python manage.py create_dummy_references', 'info');
        }, 1000);
    }
}

// Tab switching functionality
function switchTab(tabName) {
    currentTab = tabName;
    currentPage = 1;
    
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('border-primary-500', 'text-primary-600', 'active');
        button.classList.add('border-transparent', 'text-gray-500');
    });
    
    document.querySelector(`[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-500');
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-primary-500', 'text-primary-600', 'active');
    
    // Show/hide tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    document.getElementById(`${tabName}-tab`).classList.remove('hidden');
    
    // Load tab data
    loadTabData(tabName);
}

// Sub-tab switching functionality
function switchSubTab(subTabName) {
    currentSubTab = subTabName;
    
    // Update sub-tab buttons
    document.querySelectorAll('.sub-tab-button').forEach(button => {
        button.classList.remove('border-primary-500', 'text-primary-600', 'active');
        button.classList.add('border-transparent', 'text-gray-500');
    });
    
    document.querySelector(`[data-subtab="${subTabName}"]`).classList.remove('border-transparent', 'text-gray-500');
    document.querySelector(`[data-subtab="${subTabName}"]`).classList.add('border-primary-500', 'text-primary-600', 'active');
    
    // Show/hide sub-tab content
    document.querySelectorAll('.sub-tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    document.getElementById(`${subTabName}-subtab`).classList.remove('hidden');
    
    // Load sub-tab data
    if (subTabName === 'disabilitas-type') {
        loadDisabilitasTypeData();
    } else if (subTabName === 'disabilitas-data') {
        loadDisabilitasData();
    }
}

// Load data for current tab
function loadTabData(tabName) {
    switch(tabName) {
        case 'penduduk':
            loadPendudukData();
            break;
        case 'dusun':
            loadDusunData();
            break;
        case 'lorong':
            loadLorongData();
            break;
        case 'disabilitas':
            // Load based on current sub-tab
            if (currentSubTab === 'disabilitas-type') {
                loadDisabilitasTypeData();
            } else {
                loadDisabilitasData();
            }
            break;
    }
}

// Load Penduduk data
function loadPendudukData() {
    const search = document.getElementById('penduduk-search').value;
    const url = `{% url "references:penduduk_list" %}?page=${currentPage}&search=${encodeURIComponent(search)}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('penduduk-table-body');
            tbody.innerHTML = '';
            
            data.results.forEach(penduduk => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${penduduk.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${penduduk.nik}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${penduduk.gender}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${penduduk.age} tahun</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${penduduk.dusun}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editItem('penduduk', ${penduduk.id})" class="text-primary-600 hover:text-primary-900 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteItem('penduduk', ${penduduk.id})" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
            
            updatePagination('penduduk', data.pagination);
        })
        .catch(error => {
            console.error('Error loading penduduk data:', error);
        });
}

// Load Dusun data
function loadDusunData() {
    const search = document.getElementById('dusun-search').value;
    const url = `{% url "references:dusun_list" %}?search=${encodeURIComponent(search)}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('dusun-table-body');
            tbody.innerHTML = '';
            
            data.results.forEach(dusun => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${dusun.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${dusun.code}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${dusun.area_size || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${dusun.total_residents}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editItem('dusun', ${dusun.id})" class="text-primary-600 hover:text-primary-900 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteItem('dusun', ${dusun.id})" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        })
        .catch(error => {
            console.error('Error loading dusun data:', error);
        });
}

// Load Lorong data
function loadLorongData() {
    const search = document.getElementById('lorong-search').value;
    const url = `{% url "references:lorong_list" %}?search=${encodeURIComponent(search)}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('lorong-table-body');
            tbody.innerHTML = '';
            
            data.results.forEach(lorong => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${lorong.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${lorong.code}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${lorong.dusun}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${lorong.length || 0}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${lorong.house_count}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editItem('lorong', ${lorong.id})" class="text-primary-600 hover:text-primary-900 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteItem('lorong', ${lorong.id})" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        })
        .catch(error => {
            console.error('Error loading lorong data:', error);
        });
}

// Load Disabilitas Type data
function loadDisabilitasTypeData() {
    fetch('{% url "references:disabilitas_type_list" %}')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('disabilitas-type-table-body');
            tbody.innerHTML = '';
            
            data.results.forEach(type => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${type.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${type.code}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${type.description || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${type.total_cases}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editItem('disabilitas-type', ${type.id})" class="text-primary-600 hover:text-primary-900 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteItem('disabilitas-type', ${type.id})" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        })
        .catch(error => {
            console.error('Error loading disabilitas type data:', error);
        });
}

// Load Disabilitas Data
function loadDisabilitasData() {
    const search = document.getElementById('disabilitas-data-search').value;
    const url = `{% url "references:disabilitas_data_list" %}?page=${currentPage}&search=${encodeURIComponent(search)}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('disabilitas-data-table-body');
            tbody.innerHTML = '';
            
            data.results.forEach(disability => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${disability.penduduk_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${disability.penduduk_nik}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${disability.disability_type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${disability.severity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${disability.needs_assistance ? '<span class="text-red-600">Ya</span>' : '<span class="text-green-600">Tidak</span>'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editItem('disabilitas-data', ${disability.id})" class="text-primary-600 hover:text-primary-900 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteItem('disabilitas-data', ${disability.id})" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
            
            updatePagination('disabilitas-data', data.pagination);
        })
        .catch(error => {
            console.error('Error loading disabilitas data:', error);
        });
}

// Open create modal
function openCreateModal(type) {
    currentEditId = null;
    document.getElementById('modal-title').textContent = `Tambah ${getTypeName(type)}`;
    loadFormFields(type);
    document.getElementById('crud-modal').classList.remove('hidden');
}

// Edit item
function editItem(type, id) {
    currentEditId = id;
    document.getElementById('modal-title').textContent = `Edit ${getTypeName(type)}`;
    
    // Load form fields first
    loadFormFields(type, () => {
        // Then load data for editing
        loadItemData(type, id);
    });
    
    document.getElementById('crud-modal').classList.remove('hidden');
}

// Delete item
function deleteItem(type, id) {
    currentDeleteType = type;
    currentDeleteId = id;
    document.getElementById('delete-modal').classList.remove('hidden');
}

// Get type display name
function getTypeName(type) {
    const names = {
        'penduduk': 'Penduduk',
        'dusun': 'Dusun',
        'lorong': 'Lorong',
        'disabilitas-type': 'Jenis Disabilitas',
        'disabilitas-data': 'Data Disabilitas'
    };
    return names[type] || type;
}

// Load form fields based on type
function loadFormFields(type, callback) {
    const formFields = document.getElementById('form-fields');
    let fieldsHtml = '';
    
    switch(type) {
        case 'penduduk':
            // Load choices first
            fetch('{% url "references:penduduk_create" %}')
                .then(response => response.json())
                .then(choices => {
                    fieldsHtml = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nama</label>
                                <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">NIK</label>
                                <input type="text" name="nik" required maxlength="16" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin</label>
                                <select name="gender" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Pilih Jenis Kelamin</option>
                                    ${choices.gender_choices.map(choice => `<option value="${choice.value}">${choice.label}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tempat Lahir</label>
                                <input type="text" name="birth_place" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Lahir</label>
                                <input type="date" name="birth_date" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Agama</label>
                                <input type="text" name="religion" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Pendidikan</label>
                                <input type="text" name="education" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Pekerjaan</label>
                                <input type="text" name="occupation" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status Perkawinan</label>
                                <select name="marital_status" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Pilih Status</option>
                                    ${choices.marital_status_choices.map(choice => `<option value="${choice.value}">${choice.label}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Dusun</label>
                                <select name="dusun" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Pilih Dusun</option>
                                    ${choices.dusun_choices.map(choice => `<option value="${choice.id}">${choice.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Lorong</label>
                                <select name="lorong" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Pilih Lorong</option>
                                    ${choices.lorong_choices.map(choice => `<option value="${choice.id}">${choice.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Alamat</label>
                            <textarea name="address" required rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"></textarea>
                        </div>
                    `;
                    formFields.innerHTML = fieldsHtml;
                    if (callback) callback();
                });
            break;
            
        case 'dusun':
            fieldsHtml = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Dusun</label>
                        <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode Dusun</label>
                        <input type="text" name="code" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Luas Area (Hektar)</label>
                        <input type="number" name="area_size" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Penduduk</label>
                        <input type="number" name="population_count" value="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                    <textarea name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"></textarea>
                </div>
            `;
            formFields.innerHTML = fieldsHtml;
            if (callback) callback();
            break;
            
        case 'lorong':
            // Load dusun choices
            fetch('{% url "references:lorong_create" %}')
                .then(response => response.json())
                .then(choices => {
                    fieldsHtml = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lorong</label>
                                <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Kode Lorong</label>
                                <input type="text" name="code" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Dusun</label>
                                <select name="dusun" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Pilih Dusun</option>
                                    ${choices.dusun_choices.map(choice => `<option value="${choice.id}">${choice.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Panjang (Meter)</label>
                                <input type="number" name="length" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Rumah</label>
                                <input type="number" name="house_count" value="0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                            <textarea name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"></textarea>
                        </div>
                    `;
                    formFields.innerHTML = fieldsHtml;
                    if (callback) callback();
                });
            break;
            
        case 'disabilitas-type':
            fieldsHtml = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nama Jenis</label>
                        <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kode</label>
                        <input type="text" name="code" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                    <textarea name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"></textarea>
                </div>
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" name="is_active" checked class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        <span class="ml-2 text-sm text-gray-700">Aktif</span>
                    </label>
                </div>
            `;
            formFields.innerHTML = fieldsHtml;
            if (callback) callback();
            break;
            
        case 'disabilitas-data':
            // Load choices for form
            fetch('{% url "references:disabilitas_data_create" %}')
                .then(response => response.json())
                .then(choices => {
                    fieldsHtml = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Penduduk</label>
                                <select name="penduduk" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Pilih Penduduk</option>
                                    ${choices.penduduk_choices.map(choice => `<option value="${choice.id}">${choice.name} (${choice.nik})</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Disabilitas</label>
                                <select name="disability_type" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Pilih Jenis</option>
                                    ${choices.disability_type_choices.map(choice => `<option value="${choice.id}">${choice.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tingkat Keparahan</label>
                                <select name="severity" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Pilih Tingkat</option>
                                    ${choices.severity_choices.map(choice => `<option value="${choice.value}">${choice.label}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Diagnosis</label>
                                <input type="date" name="diagnosis_date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                            <textarea name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" name="needs_assistance" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                    <span class="ml-2 text-sm text-gray-700">Memerlukan Bantuan</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" name="is_active" checked class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                    <span class="ml-2 text-sm text-gray-700">Aktif</span>
                                </label>
                            </div>
                        </div>
                    `;
                    formFields.innerHTML = fieldsHtml;
                    if (callback) callback();
                });
            break;
    }
}

// Load item data for editing
function loadItemData(type, id) {
    const urls = {
        'penduduk': `{% url "references:penduduk_detail" 0 %}`.replace('0', id),
        'dusun': `{% url "references:dusun_detail" 0 %}`.replace('0', id),
        'lorong': `{% url "references:lorong_detail" 0 %}`.replace('0', id),
        'disabilitas-type': `{% url "references:disabilitas_type_detail" 0 %}`.replace('0', id),
        'disabilitas-data': `{% url "references:disabilitas_data_detail" 0 %}`.replace('0', id)
    };
    
    fetch(urls[type])
        .then(response => response.json())
        .then(data => {
            // Populate form fields with data
            Object.keys(data).forEach(key => {
                const field = document.querySelector(`[name="${key}"]`);
                if (field) {
                    if (field.type === 'checkbox') {
                        field.checked = data[key];
                    } else {
                        field.value = data[key] || '';
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading item data:', error);
        });
}

// Setup search handlers
function setupSearchHandlers() {
    document.getElementById('penduduk-search').addEventListener('input', debounce(() => {
        currentPage = 1;
        loadPendudukData();
    }, 300));
    
    document.getElementById('dusun-search').addEventListener('input', debounce(() => {
        loadDusunData();
    }, 300));
    
    document.getElementById('lorong-search').addEventListener('input', debounce(() => {
        loadLorongData();
    }, 300));
    
    document.getElementById('disabilitas-data-search').addEventListener('input', debounce(() => {
        currentPage = 1;
        loadDisabilitasData();
    }, 300));
}

// Setup pagination handlers
function setupPaginationHandlers() {
    document.getElementById('penduduk-prev').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            loadPendudukData();
        }
    });
    
    document.getElementById('penduduk-next').addEventListener('click', () => {
        currentPage++;
        loadPendudukData();
    });
    
    document.getElementById('disabilitas-data-prev').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            loadDisabilitasData();
        }
    });
    
    document.getElementById('disabilitas-data-next').addEventListener('click', () => {
        currentPage++;
        loadDisabilitasData();
    });
}

// Update pagination controls
function updatePagination(type, pagination) {
    const infoElement = document.getElementById(`${type}-info`);
    const prevButton = document.getElementById(`${type}-prev`);
    const nextButton = document.getElementById(`${type}-next`);
    
    if (infoElement) {
        const start = ((pagination.current_page - 1) * 10) + 1;
        const end = Math.min(pagination.current_page * 10, pagination.total_items);
        infoElement.textContent = `Menampilkan ${start}-${end} dari ${pagination.total_items} data`;
    }
    
    if (prevButton) {
        prevButton.disabled = !pagination.has_previous;
    }
    
    if (nextButton) {
        nextButton.disabled = !pagination.has_next;
    }
}

// Form submission handler
document.getElementById('crud-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    // Convert FormData to regular object
    for (let [key, value] of formData.entries()) {
        if (key.endsWith('[]')) {
            // Handle array fields
            const arrayKey = key.slice(0, -2);
            if (!data[arrayKey]) data[arrayKey] = [];
            data[arrayKey].push(value);
        } else {
            data[key] = value;
        }
    }
    
    // Handle checkboxes that aren't checked
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        if (!checkbox.checked && !data.hasOwnProperty(checkbox.name)) {
            data[checkbox.name] = false;
        }
    });
    
    // Determine the current type and method
    let type, method, url;
    
    if (currentTab === 'disabilitas') {
        type = currentSubTab;
    } else {
        type = currentTab;
    }
    
    if (currentEditId) {
        method = 'PUT';
        const urls = {
            'penduduk': `{% url "references:penduduk_detail" 0 %}`.replace('0', currentEditId),
            'dusun': `{% url "references:dusun_detail" 0 %}`.replace('0', currentEditId),
            'lorong': `{% url "references:lorong_detail" 0 %}`.replace('0', currentEditId),
            'disabilitas-type': `{% url "references:disabilitas_type_detail" 0 %}`.replace('0', currentEditId),
            'disabilitas-data': `{% url "references:disabilitas_data_detail" 0 %}`.replace('0', currentEditId)
        };
        url = urls[type];
    } else {
        method = 'POST';
        const urls = {
            'penduduk': '{% url "references:penduduk_create" %}',
            'dusun': '{% url "references:dusun_create" %}',
            'lorong': '{% url "references:lorong_create" %}',
            'disabilitas-type': '{% url "references:disabilitas_type_create" %}',
            'disabilitas-data': '{% url "references:disabilitas_data_create" %}'
        };
        url = urls[type];
    }
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal();
            // Reload appropriate data
            if (currentTab === 'disabilitas') {
                if (currentSubTab === 'disabilitas-type') {
                    loadDisabilitasTypeData();
                } else {
                    loadDisabilitasData();
                }
            } else {
                loadTabData(currentTab);
            }
            // Reload statistics
            loadStatistics();
            
            // Show success message
            showToast(data.message, 'success');
        } else {
            // Show error messages
            console.error('Form errors:', data.errors);
            showToast('Terjadi kesalahan saat menyimpan data', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Terjadi kesalahan sistem', 'error');
    });
});

// Confirm delete handler
document.getElementById('confirm-delete-btn').addEventListener('click', function() {
    const urls = {
        'penduduk': `{% url "references:penduduk_detail" 0 %}`.replace('0', currentDeleteId),
        'dusun': `{% url "references:dusun_detail" 0 %}`.replace('0', currentDeleteId),
        'lorong': `{% url "references:lorong_detail" 0 %}`.replace('0', currentDeleteId),
        'disabilitas-type': `{% url "references:disabilitas_type_detail" 0 %}`.replace('0', currentDeleteId),
        'disabilitas-data': `{% url "references:disabilitas_data_detail" 0 %}`.replace('0', currentDeleteId)
    };
    
    fetch(urls[currentDeleteType], {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeDeleteModal();
            // Reload appropriate data
            if (currentTab === 'disabilitas') {
                if (currentSubTab === 'disabilitas-type') {
                    loadDisabilitasTypeData();
                } else {
                    loadDisabilitasData();
                }
            } else {
                loadTabData(currentTab);
            }
            // Reload statistics
            loadStatistics();
            
            showToast(data.message, 'success');
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Terjadi kesalahan sistem', 'error');
    });
});

// Modal controls
function closeModal() {
    document.getElementById('crud-modal').classList.add('hidden');
    document.getElementById('crud-form').reset();
    currentEditId = null;
}

function closeDeleteModal() {
    document.getElementById('delete-modal').classList.add('hidden');
    currentDeleteId = null;
    currentDeleteType = null;
}

// Utility functions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showToast(message, type) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-md shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}

