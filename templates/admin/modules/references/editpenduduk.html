{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Edit Data Penduduk{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 mb-2">{{ page_title }}</h1>
            <nav class="text-sm text-gray-500">
                <a href="{% url 'custom_admin:dashboard' %}" class="hover:text-blue-600">Dashboard</a>
                <span class="mx-2">/</span>
                <a href="{% url 'custom_admin:module_view' 'references' %}" class="hover:text-blue-600">Referensi</a>
                <span class="mx-2">/</span>
                <span class="text-gray-700">Edit Penduduk</span>
            </nav>
        </div>
        <a href="javascript:history.back()" class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>
            Kembali
        </a>
    </div>

    <!-- Form Card -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="p-6">
            <form id="pendudukForm" method="post" class="space-y-6">
                {% csrf_token %}
                <input type="hidden" id="penduduk_id" name="penduduk_id" value="{{ penduduk_id }}">
                
                <!-- Display form errors -->
                <div id="formErrors" class="bg-red-50 border border-red-200 rounded-lg p-4 hidden">
                    <div class="flex">
                        <i class="fas fa-exclamation-circle text-red-400 mt-0.5 mr-3"></i>
                        <div>
                            <h3 class="text-sm font-medium text-red-800">Terjadi kesalahan:</h3>
                            <div id="errorMessages" class="mt-2 text-sm text-red-700">
                                <!-- Error messages will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Sections -->
                <div class="space-y-8">
                    <!-- Identitas Dasar - Required Fields -->
                    <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                        <h3 class="text-lg font-medium text-blue-800 mb-4">Identitas Dasar</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- NIK -->
                            <div>
                                <label for="nik" class="block text-sm font-medium text-gray-700 mb-2">
                                    NIK <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="nik" name="nik" maxlength="16" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Nomor Induk Kependudukan">
                                <p class="mt-1 text-xs text-gray-500">16 digit nomor NIK</p>
                            </div>

                            <!-- Nama Lengkap -->
                            <div>
                                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nama Lengkap <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="name" name="name" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Nama lengkap sesuai KTP">
                            </div>

                            <!-- Jenis Kelamin -->
                            <div>
                                <label for="gender" class="block text-sm font-medium text-gray-700 mb-2">
                                    Jenis Kelamin <span class="text-red-500">*</span>
                                </label>
                                <select id="gender" name="gender" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Jenis Kelamin</option>
                                    <option value="L">Laki-laki</option>
                                    <option value="P">Perempuan</option>
                                </select>
                            </div>

                            <!-- Tempat Lahir -->
                            <div>
                                <label for="birth_place" class="block text-sm font-medium text-gray-700 mb-2">
                                    Tempat Lahir <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="birth_place" name="birth_place" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Kota/Kabupaten tempat lahir">
                            </div>

                            <!-- Tanggal Lahir -->
                            <div>
                                <label for="birth_date" class="block text-sm font-medium text-gray-700 mb-2">
                                    Tanggal Lahir <span class="text-red-500">*</span>
                                </label>
                                <input type="date" id="birth_date" name="birth_date" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>

                            <!-- Agama -->
                            <div>
                                <label for="religion" class="block text-sm font-medium text-gray-700 mb-2">
                                    Agama <span class="text-red-500">*</span>
                                </label>
                                <select id="religion" name="religion" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Agama</option>
                                    <option value="Islam">Islam</option>
                                    <option value="Kristen Protestan">Kristen Protestan</option>
                                    <option value="Kristen Katolik">Kristen Katolik</option>
                                    <option value="Hindu">Hindu</option>
                                    <option value="Buddha">Buddha</option>
                                    <option value="Konghucu">Konghucu</option>
                                    <option value="Kepercayaan">Kepercayaan</option>
                                </select>
                            </div>

                            <!-- Status Perkawinan -->
                            <div>
                                <label for="marital_status" class="block text-sm font-medium text-gray-700 mb-2">
                                    Status Perkawinan <span class="text-red-500">*</span>
                                </label>
                                <select id="marital_status" name="marital_status" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Status</option>
                                    <option value="BELUM_KAWIN">Belum Kawin</option>
                                    <option value="KAWIN">Kawin</option>
                                    <option value="CERAI_HIDUP">Cerai Hidup</option>
                                    <option value="CERAI_MATI">Cerai Mati</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Alamat dan Lokasi -->
                    <div class="p-4 bg-green-50 rounded-lg border border-green-100">
                        <h3 class="text-lg font-medium text-green-800 mb-4">Alamat dan Lokasi</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Dusun -->
                            <div>
                                <label for="dusun" class="block text-sm font-medium text-gray-700 mb-2">
                                    Dusun <span class="text-red-500">*</span>
                                </label>
                                <select id="dusun" name="dusun" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Dusun</option>
                                    <!-- Dusun options will be loaded via JavaScript -->
                                </select>
                            </div>

                            <!-- Lorong -->
                            <div>
                                <label for="lorong" class="block text-sm font-medium text-gray-700 mb-2">
                                    Lorong
                                </label>
                                <select id="lorong" name="lorong"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Lorong</option>
                                    <!-- Lorong options will be loaded via JavaScript -->
                                </select>
                            </div>

                            <!-- RT -->
                            <div>
                                <label for="rt_number" class="block text-sm font-medium text-gray-700 mb-2">
                                    RT
                                </label>
                                <input type="text" id="rt_number" name="rt_number" maxlength="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Nomor RT">
                            </div>

                            <!-- RW -->
                            <div>
                                <label for="rw_number" class="block text-sm font-medium text-gray-700 mb-2">
                                    RW
                                </label>
                                <input type="text" id="rw_number" name="rw_number" maxlength="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Nomor RW">
                            </div>

                            <!-- Nomor Rumah -->
                            <div>
                                <label for="house_number" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nomor Rumah
                                </label>
                                <input type="text" id="house_number" name="house_number" maxlength="10"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Nomor rumah">
                            </div>

                            <!-- Kode Pos -->
                            <div>
                                <label for="postal_code" class="block text-sm font-medium text-gray-700 mb-2">
                                    Kode Pos
                                </label>
                                <input type="text" id="postal_code" name="postal_code" maxlength="5"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Kode pos">
                            </div>

                            <!-- Alamat Lengkap -->
                            <div class="md:col-span-2">
                                <label for="address" class="block text-sm font-medium text-gray-700 mb-2">
                                    Alamat Lengkap <span class="text-red-500">*</span>
                                </label>
                                <textarea id="address" name="address" rows="3" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Alamat lengkap tempat tinggal"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Informasi Keluarga -->
                    <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-100">
                        <h3 class="text-lg font-medium text-yellow-800 mb-4">Informasi Keluarga</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Nomor KK -->
                            <div>
                                <label for="kk_number" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nomor Kartu Keluarga
                                </label>
                                <input type="text" id="kk_number" name="kk_number" maxlength="16"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Nomor Kartu Keluarga">
                                <p class="mt-1 text-xs text-gray-500">16 digit nomor KK</p>
                            </div>

                            <!-- Kepala Keluarga -->
                            <div>
                                <label for="family_head" class="block text-sm font-medium text-gray-700 mb-2">
                                    Kepala Keluarga
                                </label>
                                <select id="family_head" name="family_head"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Kepala Keluarga</option>
                                    <!-- Family head options will be loaded via JavaScript -->
                                </select>
                            </div>

                            <!-- Hubungan dengan Kepala Keluarga -->
                            <div>
                                <label for="relationship_to_head" class="block text-sm font-medium text-gray-700 mb-2">
                                    Hubungan dengan Kepala Keluarga
                                </label>
                                <input type="text" id="relationship_to_head" name="relationship_to_head"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Contoh: Anak, Istri, dll">
                            </div>
                        </div>
                    </div>

                    <!-- Informasi Opsional -->
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-100">
                        <h3 class="text-lg font-medium text-gray-800 mb-4">Informasi Tambahan (Opsional)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Pendidikan -->
                            <div>
                                <label for="education" class="block text-sm font-medium text-gray-700 mb-2">
                                    Pendidikan
                                </label>
                                <select id="education" name="education"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Pendidikan</option>
                                    <option value="TIDAK_BELUM_SEKOLAH">Tidak/Belum Sekolah</option>
                                    <option value="BELUM_TAMAT_SD">Belum Tamat SD/Sederajat</option>
                                    <option value="TAMAT_SD">Tamat SD/Sederajat</option>
                                    <option value="SLTP">SLTP/Sederajat</option>
                                    <option value="SLTA">SLTA/Sederajat</option>
                                    <option value="D1">D1</option>
                                    <option value="D2">D2</option>
                                    <option value="D3">D3</option>
                                    <option value="D4_S1">D4/S1</option>
                                    <option value="S2">S2</option>
                                    <option value="S3">S3</option>
                                </select>
                            </div>

                            <!-- Pekerjaan -->
                            <div>
                                <label for="occupation" class="block text-sm font-medium text-gray-700 mb-2">
                                    Pekerjaan
                                </label>
                                <input type="text" id="occupation" name="occupation"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Pekerjaan">
                            </div>

                            <!-- Golongan Darah -->
                            <div>
                                <label for="blood_type" class="block text-sm font-medium text-gray-700 mb-2">
                                    Golongan Darah
                                </label>
                                <select id="blood_type" name="blood_type"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Pilih Golongan Darah</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="AB">AB</option>
                                    <option value="O">O</option>
                                </select>
                            </div>

                            <!-- Tinggi Badan -->
                            <div>
                                <label for="height" class="block text-sm font-medium text-gray-700 mb-2">
                                    Tinggi Badan (cm)
                                </label>
                                <input type="number" id="height" name="height" min="0" max="300"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Tinggi badan dalam cm">
                            </div>

                            <!-- Berat Badan -->
                            <div>
                                <label for="weight" class="block text-sm font-medium text-gray-700 mb-2">
                                    Berat Badan (kg)
                                </label>
                                <input type="number" id="weight" name="weight" min="0" max="500"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Berat badan dalam kg">
                            </div>

                            <!-- Kewarganegaraan -->
                            <div>
                                <label for="citizenship" class="block text-sm font-medium text-gray-700 mb-2">
                                    Kewarganegaraan
                                </label>
                                <select id="citizenship" name="citizenship"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="WNI">WNI</option>
                                    <option value="WNA">WNA</option>
                                </select>
                            </div>

                            <!-- Nomor Paspor -->
                            <div>
                                <label for="passport_number" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nomor Paspor
                                </label>
                                <input type="text" id="passport_number" name="passport_number"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Nomor paspor (jika ada)">
                            </div>

                            <!-- Berlaku Hingga -->
                            <div>
                                <label for="passport_expiry" class="block text-sm font-medium text-gray-700 mb-2">
                                    Berlaku Hingga
                                </label>
                                <input type="date" id="passport_expiry" name="passport_expiry"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <!-- Kontak -->
                    <div class="p-4 bg-purple-50 rounded-lg border border-purple-100">
                        <h3 class="text-lg font-medium text-purple-800 mb-4">Informasi Kontak</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Nomor Telepon -->
                            <div>
                                <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nomor Telepon
                                </label>
                                <input type="tel" id="phone_number" name="phone_number"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Nomor telepon rumah">
                            </div>

                            <!-- Nomor HP -->
                            <div>
                                <label for="mobile_number" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nomor HP
                                </label>
                                <input type="tel" id="mobile_number" name="mobile_number"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Nomor handphone">
                            </div>

                            <!-- Email -->
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                                    Email
                                </label>
                                <input type="email" id="email" name="email"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Alamat email">
                            </div>
                            
                            <!-- Status Aktif -->
                            <div>
                                <label for="is_active" class="block text-sm font-medium text-gray-700 mb-2">
                                    Status
                                </label>
                                <select id="is_active" name="is_active"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="true">Aktif</option>
                                    <option value="false">Tidak Aktif</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Kontak Darurat -->
                    <div class="p-4 bg-red-50 rounded-lg border border-red-100">
                        <h3 class="text-lg font-medium text-red-800 mb-4">Kontak Darurat</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Kontak Darurat -->
                            <div>
                                <label for="emergency_contact" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nama Kontak Darurat
                                </label>
                                <input type="text" id="emergency_contact" name="emergency_contact"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Nama kontak darurat">
                            </div>

                            <!-- Telepon Darurat -->
                            <div>
                                <label for="emergency_phone" class="block text-sm font-medium text-gray-700 mb-2">
                                    Telepon Darurat
                                </label>
                                <input type="tel" id="emergency_phone" name="emergency_phone"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Nomor telepon kontak darurat">
                            </div>

                            <!-- Hubungan dengan Kontak Darurat -->
                            <div>
                                <label for="emergency_relationship" class="block text-sm font-medium text-gray-700 mb-2">
                                    Hubungan dengan Kontak Darurat
                                </label>
                                <input type="text" id="emergency_relationship" name="emergency_relationship"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Contoh: Anak, Saudara, dll">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end pt-6">
                    <button type="submit" id="submitBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                        <i class="fas fa-save mr-2"></i> Simpan Perubahan
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const pendudukId = document.getElementById('penduduk_id').value;
        
        // Load penduduk data
        fetch(`/pulosarok/references/api/penduduk/${pendudukId}/`)
            .then(response => response.json())
            .then(data => {
                // Populate form fields with existing data
                document.getElementById('nik').value = data.nik || '';
                document.getElementById('name').value = data.name || '';
                document.getElementById('gender').value = data.gender || '';
                document.getElementById('birth_place').value = data.birth_place || '';
                document.getElementById('birth_date').value = data.birth_date || '';
                document.getElementById('religion').value = data.religion || '';
                document.getElementById('marital_status').value = data.marital_status || '';
                document.getElementById('address').value = data.address || '';
                document.getElementById('rt_number').value = data.rt_number || '';
                document.getElementById('rw_number').value = data.rw_number || '';
                document.getElementById('house_number').value = data.house_number || '';
                document.getElementById('postal_code').value = data.postal_code || '';
                document.getElementById('kk_number').value = data.kk_number || '';
                document.getElementById('relationship_to_head').value = data.relationship_to_head || '';
                document.getElementById('education').value = data.education || '';
                document.getElementById('occupation').value = data.occupation || '';
                document.getElementById('blood_type').value = data.blood_type || '';
                document.getElementById('height').value = data.height || '';
                document.getElementById('weight').value = data.weight || '';
                document.getElementById('citizenship').value = data.citizenship || 'WNI';
                document.getElementById('passport_number').value = data.passport_number || '';
                document.getElementById('passport_expiry').value = data.passport_expiry || '';
                document.getElementById('phone_number').value = data.phone_number || '';
                document.getElementById('mobile_number').value = data.mobile_number || '';
                document.getElementById('email').value = data.email || '';
                document.getElementById('emergency_contact').value = data.emergency_contact || '';
                document.getElementById('emergency_phone').value = data.emergency_phone || '';
                document.getElementById('emergency_relationship').value = data.emergency_relationship || '';
                
                // Set is_active status
                if (data.is_active !== undefined) {
                    document.getElementById('is_active').value = data.is_active.toString();
                }
                
                // Load dusun and set selected value
                loadDusunAndSetValue(data.dusun);
                
                // Set family head if available
                if (data.family_head) {
                    loadFamilyHeadsAndSetValue(data.family_head);
                } else {
                    loadFamilyHeads();
                }
            })
            .catch(error => {
                console.error('Error loading penduduk data:', error);
                showNotification('Terjadi kesalahan saat memuat data penduduk.', 'error');
            });
        
        // Function to load dusun options and set selected value
        function loadDusunAndSetValue(selectedDusunId) {
            fetch('/pulosarok/references/api/dusun/list/')
                .then(response => response.json())
                .then(data => {
                    const dusunSelect = document.getElementById('dusun');
                    dusunSelect.innerHTML = '<option value="">Pilih Dusun</option>';
                    
                    if (data.results) {
                        data.results.forEach(dusun => {
                            const option = document.createElement('option');
                            option.value = dusun.id;
                            option.textContent = dusun.name;
                            dusunSelect.appendChild(option);
                        });
                        
                        // Set selected dusun if available
                        if (selectedDusunId) {
                            dusunSelect.value = selectedDusunId;
                            // Load lorong options for this dusun
                            loadLorongForDusun(selectedDusunId);
                        }
                    } else {
                        console.error('Dusun data format is incorrect:', data);
                    }
                })
                .catch(error => console.error('Error loading dusun data:', error));
        }
        
        // Function to load lorong options for a specific dusun and set selected value
        function loadLorongForDusun(dusunId, selectedLorongId) {
            fetch(`/pulosarok/references/api/lorong/list/?dusun=${dusunId}`)
                .then(response => response.json())
                .then(data => {
                    const lorongSelect = document.getElementById('lorong');
                    lorongSelect.innerHTML = '<option value="">Pilih Lorong</option>';
                    
                    if (data.results) {
                        data.results.forEach(lorong => {
                            const option = document.createElement('option');
                            option.value = lorong.id;
                            option.textContent = lorong.name;
                            lorongSelect.appendChild(option);
                        });
                        
                        // Set selected lorong if available
                        if (selectedLorongId) {
                            lorongSelect.value = selectedLorongId;
                        }
                    } else {
                        console.error('Lorong data format is incorrect:', data);
                    }
                })
                .catch(error => console.error('Error loading lorong data:', error));
        }
        
        // Function to load family heads and set selected value
        function loadFamilyHeadsAndSetValue(selectedFamilyHeadId) {
            fetch('/pulosarok/references/api/penduduk/list/?is_family_head=true')
                .then(response => response.json())
                .then(data => {
                    const familyHeadSelect = document.getElementById('family_head');
                    familyHeadSelect.innerHTML = '<option value="">Pilih Kepala Keluarga</option>';
                    
                    if (data.results) {
                        data.results.forEach(penduduk => {
                            const option = document.createElement('option');
                            option.value = penduduk.id;
                            option.textContent = `${penduduk.name} (${penduduk.nik})`;
                            familyHeadSelect.appendChild(option);
                        });
                    }
                    
                    // Set selected family head if available
                    if (selectedFamilyHeadId) {
                        familyHeadSelect.value = selectedFamilyHeadId;
                    }
                })
                .catch(error => console.error('Error loading family head data:', error));
        }
        
        // Function to load family heads without setting a value
        function loadFamilyHeads() {
            fetch('/pulosarok/references/api/penduduk/list/?is_family_head=true')
                .then(response => response.json())
                .then(data => {
                    const familyHeadSelect = document.getElementById('family_head');
                    familyHeadSelect.innerHTML = '<option value="">Pilih Kepala Keluarga</option>';
                    
                    if (data.results) {
                        data.results.forEach(penduduk => {
                            const option = document.createElement('option');
                            option.value = penduduk.id;
                            option.textContent = `${penduduk.name} (${penduduk.nik})`;
                            familyHeadSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error('Error loading family head data:', error));
        }
        
        // Handle dusun change to update lorong options
        document.getElementById('dusun').addEventListener('change', function() {
            const dusunId = this.value;
            if (dusunId) {
                loadLorongForDusun(dusunId);
            } else {
                // Clear lorong options if no dusun selected
                const lorongSelect = document.getElementById('lorong');
                lorongSelect.innerHTML = '<option value="">Pilih Lorong</option>';
            }
        });

        // Form submission
        document.getElementById('pendudukForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const formObject = {};
            
            formData.forEach((value, key) => {
                // Skip penduduk_id as it's not needed in the request body
                if (key !== 'penduduk_id') {
                    // Convert is_active string to boolean for API
                    if (key === 'is_active') {
                        formObject[key] = value === 'true';
                    } else {
                        formObject[key] = value;
                    }
                }
            });
            
            // Log the data being sent for debugging
            console.log('Sending data:', formObject);
            
            fetch(`/pulosarok/references/api/public-penduduk-update/${pendudukId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: JSON.stringify(formObject)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success notification
                    showNotification('Data penduduk berhasil diperbarui!', 'success');
                    
                    // Redirect to penduduk list after 2 seconds
                    setTimeout(() => {
                        window.location.href = '/pulosarok/references/admin/penduduk/';
                    }, 2000);
                } else {
                    // Show error messages
                    const errorDiv = document.getElementById('formErrors');
                    const errorMessages = document.getElementById('errorMessages');
                    errorMessages.innerHTML = '';
                    
                    if (data.errors) {
                        Object.entries(data.errors).forEach(([field, errors]) => {
                            const errorItem = document.createElement('p');
                            errorItem.textContent = `${field}: ${errors.join(', ')}`;
                            errorMessages.appendChild(errorItem);
                            
                            // Highlight error field
                            const fieldElement = document.getElementById(field);
                            if (fieldElement) {
                                fieldElement.classList.add('border-red-500');
                                fieldElement.addEventListener('focus', function() {
                                    this.classList.remove('border-red-500');
                                }, { once: true });
                            }
                        });
                    } else if (data.error) {
                        const errorItem = document.createElement('p');
                        errorItem.textContent = data.error;
                        errorMessages.appendChild(errorItem);
                    }
                    
                    errorDiv.classList.remove('hidden');
                    
                    // Scroll to errors
                    errorDiv.scrollIntoView({ behavior: 'smooth' });
                }
            })
            .catch(error => {
                console.error('Error submitting form:', error);
                showNotification('Terjadi kesalahan saat menyimpan data. Silakan coba lagi.', 'error');
            });
        });
        
        // Function to show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove notification after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
    });
</script>
{% endblock %}