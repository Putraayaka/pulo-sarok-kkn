{% extends 'admin/base.html' %}

{% block title %}API Endpoints Registry{% endblock %}

{% block page_title %}API Endpoints Registry{% endblock %}

{% block content %}
<div class="p-4 sm:p-6">
    <!-- Header Section -->
    <div class="bg-white rounded-lg shadow-sm border p-4 sm:p-6 mb-6">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
            <div>
                <h2 class="text-xl sm:text-2xl font-bold text-gray-900">API Endpoints Registry</h2>
                <p class="text-gray-600 mt-1 text-sm sm:text-base">Kelola dan monitor semua API endpoints yang tersedia</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                <button onclick="refreshEndpoints()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors duration-200 text-sm sm:text-base">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Refresh
                </button>
                <button onclick="exportEndpoints()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors duration-200 text-sm sm:text-base">
                    <i class="fas fa-download mr-2"></i>
                    Export
                </button>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="bg-white rounded-lg shadow-sm border p-4 sm:p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label for="module-filter" class="block text-sm font-medium text-gray-700 mb-2">Filter by Module</label>
                <select id="module-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Modules</option>
                </select>
            </div>
            <div>
                <label for="method-filter" class="block text-sm font-medium text-gray-700 mb-2">Filter by Method</label>
                <select id="method-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Methods</option>
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                    <option value="PATCH">PATCH</option>
                </select>
            </div>
            <div>
                <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-2">Filter by Status</label>
                <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Status</option>
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 sm:gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-sm border p-4 sm:p-6">
            <div class="flex items-center">
                <div class="p-2 sm:p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-plug text-lg sm:text-2xl"></i>
                </div>
                <div class="ml-3 sm:ml-4">
                    <p class="text-xs sm:text-sm font-medium text-gray-600">Total Endpoints</p>
                    <p class="text-lg sm:text-2xl font-semibold text-gray-900" id="total-endpoints">0</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm border p-4 sm:p-6">
            <div class="flex items-center">
                <div class="p-2 sm:p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-check-circle text-lg sm:text-2xl"></i>
                </div>
                <div class="ml-3 sm:ml-4">
                    <p class="text-xs sm:text-sm font-medium text-gray-600">Active</p>
                    <p class="text-lg sm:text-2xl font-semibold text-gray-900" id="active-endpoints">0</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm border p-4 sm:p-6">
            <div class="flex items-center">
                <div class="p-2 sm:p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <i class="fas fa-shield-alt text-lg sm:text-2xl"></i>
                </div>
                <div class="ml-3 sm:ml-4">
                    <p class="text-xs sm:text-sm font-medium text-gray-600">Auth Required</p>
                    <p class="text-lg sm:text-2xl font-semibold text-gray-900" id="auth-endpoints">0</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-sm border p-4 sm:p-6">
            <div class="flex items-center">
                <div class="p-2 sm:p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-cubes text-lg sm:text-2xl"></i>
                </div>
                <div class="ml-3 sm:ml-4">
                    <p class="text-xs sm:text-sm font-medium text-gray-600">Modules</p>
                    <p class="text-lg sm:text-2xl font-semibold text-gray-900" id="total-modules">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Endpoints Table -->
    <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
        <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">API Endpoints</h3>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Module</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">URL Pattern</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Auth</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="endpoints-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Loading State -->
        <div id="loading-state" class="p-8 text-center">
            <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-gray-500 bg-white">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading endpoints...
            </div>
        </div>
        
        <!-- Empty State -->
        <div id="empty-state" class="p-8 text-center hidden">
            <i class="fas fa-plug text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-500">No API endpoints found</p>
        </div>
    </div>
</div>

<!-- Endpoint Detail Modal -->
<div id="endpoint-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="modal-title">Endpoint Details</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="modal-content">
                <!-- Content will be loaded here -->
            </div>
            
            <div class="flex justify-end mt-6">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let endpoints = [];
let filteredEndpoints = [];

// Load endpoints on page load
document.addEventListener('DOMContentLoaded', function() {
    loadEndpoints();
    setupFilters();
});

function loadEndpoints() {
    showLoading();
    
    fetch('/admin/api-endpoints/')
        .then(response => response.json())
        .then(data => {
            endpoints = data.results || [];
            filteredEndpoints = [...endpoints];
            renderEndpoints();
            updateStatistics();
            populateModuleFilter();
            hideLoading();
        })
        .catch(error => {
            console.error('Error loading endpoints:', error);
            showError('Failed to load endpoints');
            hideLoading();
        });
}

function renderEndpoints() {
    const tbody = document.getElementById('endpoints-table-body');
    
    if (filteredEndpoints.length === 0) {
        showEmptyState();
        return;
    }
    
    hideEmptyState();
    
    tbody.innerHTML = filteredEndpoints.map(endpoint => `
        <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        ${endpoint.module_display_name}
                    </span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${endpoint.name}</div>
                <div class="text-sm text-gray-500">${endpoint.description || 'No description'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <code class="text-sm bg-gray-100 px-2 py-1 rounded">${endpoint.url_pattern}</code>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                    endpoint.method === 'GET' ? 'bg-green-100 text-green-800' :
                    endpoint.method === 'POST' ? 'bg-blue-100 text-blue-800' :
                    endpoint.method === 'PUT' ? 'bg-yellow-100 text-yellow-800' :
                    endpoint.method === 'DELETE' ? 'bg-red-100 text-red-800' :
                    'bg-gray-100 text-gray-800'
                }">
                    ${endpoint.method}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                ${endpoint.requires_auth ? 
                    '<i class="fas fa-shield-alt text-green-600" title="Authentication required"></i>' : 
                    '<i class="fas fa-globe text-gray-400" title="Public access"></i>'
                }
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                    endpoint.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                }">
                    ${endpoint.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${endpoint.created_at}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button onclick="viewEndpoint(${endpoint.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                    <i class="fas fa-eye"></i>
                </button>
                <button onclick="testEndpoint('${endpoint.url_pattern}', '${endpoint.method}')" class="text-green-600 hover:text-green-900">
                    <i class="fas fa-play"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function updateStatistics() {
    document.getElementById('total-endpoints').textContent = endpoints.length;
    document.getElementById('active-endpoints').textContent = endpoints.filter(e => e.is_active).length;
    document.getElementById('auth-endpoints').textContent = endpoints.filter(e => e.requires_auth).length;
    
    const uniqueModules = [...new Set(endpoints.map(e => e.module_name))];
    document.getElementById('total-modules').textContent = uniqueModules.length;
}

function populateModuleFilter() {
    const moduleFilter = document.getElementById('module-filter');
    const uniqueModules = [...new Set(endpoints.map(e => e.module_display_name))];
    
    moduleFilter.innerHTML = '<option value="">All Modules</option>' + 
        uniqueModules.map(module => `<option value="${module}">${module}</option>`).join('');
}

function setupFilters() {
    ['module-filter', 'method-filter', 'status-filter'].forEach(filterId => {
        document.getElementById(filterId).addEventListener('change', applyFilters);
    });
}

function applyFilters() {
    const moduleFilter = document.getElementById('module-filter').value;
    const methodFilter = document.getElementById('method-filter').value;
    const statusFilter = document.getElementById('status-filter').value;
    
    filteredEndpoints = endpoints.filter(endpoint => {
        return (!moduleFilter || endpoint.module_display_name === moduleFilter) &&
               (!methodFilter || endpoint.method === methodFilter) &&
               (!statusFilter || endpoint.is_active.toString() === statusFilter);
    });
    
    renderEndpoints();
}

function refreshEndpoints() {
    loadEndpoints();
}

function exportEndpoints() {
    const csvContent = "data:text/csv;charset=utf-8," + 
        "Module,Name,URL Pattern,Method,Auth Required,Status,Created\n" +
        endpoints.map(e => 
            `"${e.module_display_name}","${e.name}","${e.url_pattern}","${e.method}","${e.requires_auth}","${e.is_active}","${e.created_at}"`
        ).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "api_endpoints.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function viewEndpoint(endpointId) {
    const endpoint = endpoints.find(e => e.id === endpointId);
    if (!endpoint) return;
    
    document.getElementById('modal-title').textContent = `Endpoint: ${endpoint.name}`;
    document.getElementById('modal-content').innerHTML = `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Module</label>
                <p class="mt-1 text-sm text-gray-900">${endpoint.module_display_name}</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Name</label>
                <p class="mt-1 text-sm text-gray-900">${endpoint.name}</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <p class="mt-1 text-sm text-gray-900">${endpoint.description || 'No description available'}</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">URL Pattern</label>
                <code class="mt-1 block text-sm bg-gray-100 p-2 rounded">${endpoint.url_pattern}</code>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Method</label>
                    <span class="mt-1 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        ${endpoint.method}
                    </span>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Status</label>
                    <span class="mt-1 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                        endpoint.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }">
                        ${endpoint.is_active ? 'Active' : 'Inactive'}
                    </span>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Authentication Required</label>
                <p class="mt-1 text-sm text-gray-900">${endpoint.requires_auth ? 'Yes' : 'No'}</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Created At</label>
                <p class="mt-1 text-sm text-gray-900">${endpoint.created_at}</p>
            </div>
        </div>
    `;
    
    document.getElementById('endpoint-modal').classList.remove('hidden');
}

function testEndpoint(urlPattern, method) {
    // Simple endpoint testing - you can enhance this
    const testUrl = urlPattern.replace(/\<.*?\>/g, '1'); // Replace parameters with dummy values
    console.log(`Testing ${method} ${testUrl}`);
    alert(`Testing ${method} ${testUrl}\n\nCheck browser console for results.`);
    
    // You can implement actual API testing here
}

function closeModal() {
    document.getElementById('endpoint-modal').classList.add('hidden');
}

function showLoading() {
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('endpoints-table-body').innerHTML = '';
}

function hideLoading() {
    document.getElementById('loading-state').classList.add('hidden');
}

function showEmptyState() {
    document.getElementById('empty-state').classList.remove('hidden');
    document.getElementById('endpoints-table-body').innerHTML = '';
}

function hideEmptyState() {
    document.getElementById('empty-state').classList.add('hidden');
}

function showError(message) {
    // You can implement a proper error notification system here
    alert('Error: ' + message);
}
</script>
{% endblock %}