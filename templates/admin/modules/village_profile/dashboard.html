{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Dashboard Profil Desa{% endblock %}

{% block extra_css %}
<style>
.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 1rem;
    color: white;
    transition: transform 0.3s ease;
}
.stat-card:hover {
    transform: translateY(-5px);
}
.activity-item {
    border-left: 3px solid #e5e7eb;
    transition: border-color 0.3s ease;
}
.activity-item:hover {
    border-left-color: #3b82f6;
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h4 class="text-3xl font-bold text-gray-900 mb-2">Dashboard Profil Desa</h4>
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3">
                    <li class="inline-flex items-center">
                        <a href="{% url 'custom_admin:dashboard' %}" class="text-blue-600 hover:text-blue-800">Dashboard</a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                            <span class="ml-1 text-gray-500 md:ml-2">Profil Desa</span>
                        </div>
                    </li>
                </ol>
            </nav>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm">Total Visi & Misi</p>
                        <p class="text-3xl font-bold">{{ vision_count|default:0 }}</p>
                    </div>
                    <div class="bg-white/20 p-3 rounded-lg">
                        <i class="fas fa-eye text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card p-6" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%)">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm">Sejarah Desa</p>
                        <p class="text-3xl font-bold">{{ history_count|default:0 }}</p>
                    </div>
                    <div class="bg-white/20 p-3 rounded-lg">
                        <i class="fas fa-history text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card p-6" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm">Data Geografis</p>
                        <p class="text-3xl font-bold">{{ geographic_count|default:0 }}</p>
                    </div>
                    <div class="bg-white/20 p-3 rounded-lg">
                        <i class="fas fa-globe text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card p-6" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm">Peta Desa</p>
                        <p class="text-3xl font-bold">{{ map_count|default:0 }}</p>
                    </div>
                    <div class="bg-white/20 p-3 rounded-lg">
                        <i class="fas fa-map text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Quick Actions -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h5 class="text-xl font-semibold text-gray-900">Aksi Cepat</h5>
                        <button type="button" class="text-blue-600 hover:text-blue-800" onclick="openQuickActionModal()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="space-y-4" id="quickActionsList">
                        {% for action in quick_actions %}
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors quick-action-item" data-id="{{ action.id }}">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                    <i class="{{ action.icon }} text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-900">{{ action.title }}</p>
                                    <p class="text-sm text-gray-500">{{ action.description }}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button type="button" class="text-blue-600 hover:text-blue-800" onclick="editQuickAction({{ action.id }}, '{{ action.title|escapejs }}', '{{ action.description|escapejs }}', '{{ action.icon|escapejs }}', '{{ action.url|escapejs }}')">                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="text-red-600 hover:text-red-800" onclick="confirmDeleteQuickAction({{ action.id }}, '{{ action.title|escapejs }}')">                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-8">
                            <i class="fas fa-rocket text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">Belum ada aksi cepat</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h5 class="text-xl font-semibold text-gray-900">Aktivitas Terbaru</h5>
                        <button type="button" class="text-blue-600 hover:text-blue-800" onclick="openActivityModal()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="space-y-4" id="activitiesList">
                        {% for activity in recent_activities %}
                        <div class="activity-item pl-4 py-3 activity-item-card" data-id="{{ activity.id }}">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                            <i class="{{ activity.icon }} text-blue-600 text-sm"></i>
                                        </div>
                                        <h6 class="font-medium text-gray-900">{{ activity.title }}</h6>
                                    </div>
                                    <p class="text-sm text-gray-600 ml-11">{{ activity.description }}</p>
                                    <p class="text-xs text-gray-400 ml-11 mt-1">{{ activity.created_at|timesince }} yang lalu</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button type="button" class="text-blue-600 hover:text-blue-800" onclick="editActivity({{ activity.id }}, '{{ activity.title|escapejs }}', '{{ activity.description|escapejs }}', '{{ activity.icon|escapejs }}')">                                        <i class="fas fa-edit text-sm"></i>
                                    </button>
                                    <button type="button" class="text-red-600 hover:text-red-800" onclick="confirmDeleteActivity({{ activity.id }}, '{{ activity.title|escapejs }}')">                                        <i class="fas fa-trash text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-8">
                            <i class="fas fa-clock text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">Belum ada aktivitas</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Action Modal -->
<div class="modal fade" id="quickActionModal" tabindex="-1" aria-labelledby="quickActionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content rounded-2xl border-0 shadow-2xl">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-t-2xl p-6 relative">
                <h5 class="text-xl font-semibold" id="quickActionModalTitle">Tambah Aksi Cepat</h5>
                <button type="button" class="absolute top-4 right-4 text-white hover:text-gray-200 transition-colors" data-bs-dismiss="modal" aria-label="Close">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <form id="quickActionForm">
                    {% csrf_token %}
                    <input type="hidden" id="quickActionId" name="id">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Judul <span class="text-red-500">*</span></label>
                        <input type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="quickActionTitle" name="title" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label>
                        <textarea class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="quickActionDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Icon (FontAwesome)</label>
                        <input type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="quickActionIcon" name="icon" placeholder="fas fa-plus">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">URL</label>
                        <input type="url" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="quickActionUrl" name="url">
                    </div>
                </form>
            </div>
            <div class="flex justify-end space-x-3 p-6 border-t border-gray-200">
                <button type="button" class="px-6 py-3 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all" onclick="saveQuickAction()">Simpan</button>
            </div>
        </div>
    </div>
</div>

<!-- Activity Modal -->
<div class="modal fade" id="activityModal" tabindex="-1" aria-labelledby="activityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content rounded-2xl border-0 shadow-2xl">
            <div class="bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-t-2xl p-6 relative">
                <h5 class="text-xl font-semibold" id="activityModalTitle">Tambah Aktivitas</h5>
                <button type="button" class="absolute top-4 right-4 text-white hover:text-gray-200 transition-colors" data-bs-dismiss="modal" aria-label="Close">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <form id="activityForm">
                    {% csrf_token %}
                    <input type="hidden" id="activityId" name="id">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Judul <span class="text-red-500">*</span></label>
                        <input type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" id="activityTitle" name="title" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi <span class="text-red-500">*</span></label>
                        <textarea class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" id="activityDescription" name="description" rows="4" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Icon (FontAwesome)</label>
                        <input type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" id="activityIcon" name="icon" placeholder="fas fa-bell">
                    </div>
                </form>
            </div>
            <div class="flex justify-end space-x-3 p-6 border-t border-gray-200">
                <button type="button" class="px-6 py-3 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="px-6 py-3 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-lg hover:from-green-600 hover:to-teal-700 transition-all" onclick="saveActivity()">Simpan</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content rounded-2xl border-0 shadow-2xl">
            <div class="bg-red-500 text-white rounded-t-2xl p-6 relative">
                <h5 class="text-xl font-semibold">Konfirmasi Hapus</h5>
                <button type="button" class="absolute top-4 right-4 text-white hover:text-gray-200 transition-colors" data-bs-dismiss="modal" aria-label="Close">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4">
                        <svg class="h-8 w-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <p class="text-lg font-medium text-gray-900 mb-2">Apakah Anda yakin ingin menghapus item ini?</p>
                    <p class="text-gray-500 text-sm" id="deleteItemName">Tindakan ini tidak dapat dibatalkan.</p>
                </div>
            </div>
            <div class="flex justify-end space-x-3 p-6 border-t border-gray-200">
                <button type="button" class="px-6 py-3 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors" onclick="executeDelete()">Hapus</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Bootstrap Modal instances
let quickActionModal, activityModal, deleteModal;
let currentDeleteId = null;
let currentDeleteType = null;

// Initialize modals when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    quickActionModal = new bootstrap.Modal(document.getElementById('quickActionModal'));
    activityModal = new bootstrap.Modal(document.getElementById('activityModal'));
    deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
});

// Quick Action Functions
function openQuickActionModal() {
    document.getElementById('quickActionModalTitle').textContent = 'Tambah Aksi Cepat';
    document.getElementById('quickActionForm').reset();
    document.getElementById('quickActionId').value = '';
    quickActionModal.show();
}

function editQuickAction(id, title, description, icon, url) {
    document.getElementById('quickActionModalTitle').textContent = 'Edit Aksi Cepat';
    document.getElementById('quickActionId').value = id || '';
    document.getElementById('quickActionTitle').value = title || '';
    document.getElementById('quickActionDescription').value = description || '';
    document.getElementById('quickActionIcon').value = icon || '';
    document.getElementById('quickActionUrl').value = url || '';
    quickActionModal.show();
}

function saveQuickAction() {
    const form = document.getElementById('quickActionForm');
    const formData = new FormData(form);
    const isEdit = document.getElementById('quickActionId').value !== '';
    const url = isEdit ? 
        `/pulosarok/village-profile/api/quick-action/${document.getElementById('quickActionId').value}/update/` : 
        '/pulosarok/village-profile/api/quick-action/create/';
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            quickActionModal.hide();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Terjadi kesalahan'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat menyimpan data');
    });
}

function confirmDeleteQuickAction(id, title) {
    currentDeleteId = id;
    currentDeleteType = 'quick-action';
    const deleteItemName = document.getElementById('deleteItemName');
    if (deleteItemName) {
        deleteItemName.textContent = `Aksi Cepat: ${title}`;
    }
    deleteModal.show();
}

// Activity Functions
function openActivityModal() {
    document.getElementById('activityModalTitle').textContent = 'Tambah Aktivitas';
    document.getElementById('activityForm').reset();
    document.getElementById('activityId').value = '';
    activityModal.show();
}

function editActivity(id, title, description, icon) {
    document.getElementById('activityModalTitle').textContent = 'Edit Aktivitas';
    document.getElementById('activityId').value = id || '';
    document.getElementById('activityTitle').value = title || '';
    document.getElementById('activityDescription').value = description || '';
    document.getElementById('activityIcon').value = icon || '';
    activityModal.show();
}

function saveActivity() {
    const form = document.getElementById('activityForm');
    const formData = new FormData(form);
    const isEdit = document.getElementById('activityId').value !== '';
    const url = isEdit ? 
        `/pulosarok/village-profile/api/activity/${document.getElementById('activityId').value}/update/` : 
        '/pulosarok/village-profile/api/activity/create/';
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            activityModal.hide();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Terjadi kesalahan'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat menyimpan data');
    });
}

function confirmDeleteActivity(id, title) {
    currentDeleteId = id;
    currentDeleteType = 'activity';
    const deleteItemName = document.getElementById('deleteItemName');
    if (deleteItemName) {
        deleteItemName.textContent = `Aktivitas: ${title}`;
    }
    deleteModal.show();
}

// Delete Functions
function executeDelete() {
    if (!currentDeleteId || !currentDeleteType) {
        alert('ID atau tipe tidak valid');
        return;
    }
    
    const url = `/pulosarok/village-profile/api/${currentDeleteType}/${currentDeleteId}/delete/`;
    
    fetch(url, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            deleteModal.hide();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Terjadi kesalahan'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat menghapus data');
    });
}

// Utility Functions
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}