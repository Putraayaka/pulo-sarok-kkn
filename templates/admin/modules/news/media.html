{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Media Berita{% endblock %}

{% block content %}
<div class="p-4 sm:p-6">
    <!-- Header Section -->
    <div class="bg-white rounded-lg shadow-sm border p-4 sm:p-6 mb-6">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
            <div>
                <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Media Berita</h2>
                <p class="text-gray-600 mt-1 text-sm sm:text-base">Kelola gambar dan media untuk berita</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                <button onclick="openUploadModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center justify-center">
                    <i class="fas fa-upload mr-2"></i>Upload Media
                </button>
                <a href="{% url 'news:news_admin' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center justify-center">
                    <i class="fas fa-arrow-left mr-2"></i>Kembali
                </a>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="bg-white rounded-lg shadow-sm border p-4 sm:p-6 mb-6">
        <form method="GET" class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Cari Media</label>
                    <input type="text" name="search" id="search" value="{{ request.GET.search }}" 
                           placeholder="Nama file atau caption..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Tipe Media</label>
                    <select name="type" id="type" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Semua Tipe</option>
                        <option value="image" {% if request.GET.type == 'image' %}selected{% endif %}>Gambar</option>
                        <option value="video" {% if request.GET.type == 'video' %}selected{% endif %}>Video</option>
                        <option value="document" {% if request.GET.type == 'document' %}selected{% endif %}>Dokumen</option>
                    </select>
        </div>
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <select name="category" id="category" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Semua Kategori</option>
                        {% for cat in categories %}
                            <option value="{{ cat.id }}" {% if request.GET.category == cat.id|stringformat:"s" %}selected{% endif %}>
                                {{ cat.name }}
                            </option>
                        {% endfor %}
                    </select>
        </div>
                <div class="flex items-end">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                        <i class="fas fa-search mr-2"></i>Filter
                    </button>
        </div>
        </div>
        </form>
    </div>

    <!-- Media Grid -->
    <div class="bg-white rounded-lg shadow-sm border p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-gray-900">Media Library</h3>
            <div class="flex items-center space-x-2">
                <button onclick="toggleSelectionMode()" id="selectionToggle" class="px-3 py-2 text-sm text-gray-600 hover:text-gray-900 border border-gray-300 rounded-lg transition duration-200">
                    <i class="fas fa-check-square mr-2"></i>Pilih
                </button>
                <div id="bulkActions" class="hidden flex items-center space-x-2">
                    <span class="text-sm text-gray-600" id="selectedCount">0 dipilih</span>
                    <button onclick="deleteSelected()" class="px-3 py-2 text-sm text-red-600 hover:text-red-700 border border-red-300 rounded-lg transition duration-200">
                        <i class="fas fa-trash mr-2"></i>Hapus
            </button>
        </div>
            </div>
        </div>

        {% if media_list %}
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
            {% for media in media_list %}
            <div class="media-item group relative" data-id="{{ media.id }}">
                <div class="relative">
                    {% if media.file_type == 'image' %}
                        <img src="{{ media.file.url }}" alt="{{ media.caption|default:'Media' }}" 
                             class="w-full h-32 object-cover rounded-lg border cursor-pointer hover:shadow-lg transition duration-200"
                             onclick="openMediaModal('{{ media.file.url }}', '{{ media.caption|default:'' }}', '{{ media.file_type }}')">
                    {% elif media.file_type == 'video' %}
                        <div class="w-full h-32 bg-gray-100 rounded-lg border flex items-center justify-center cursor-pointer hover:shadow-lg transition duration-200"
                             onclick="openMediaModal('{{ media.file.url }}', '{{ media.caption|default:'' }}', '{{ media.file_type }}')">
                            <i class="fas fa-play text-2xl text-gray-400"></i>
                        </div>
                    {% else %}
                        <div class="w-full h-32 bg-gray-100 rounded-lg border flex items-center justify-center cursor-pointer hover:shadow-lg transition duration-200"
                             onclick="openMediaModal('{{ media.file.url }}', '{{ media.caption|default:'' }}', '{{ media.file_type }}')">
                            <i class="fas fa-file text-2xl text-gray-400"></i>
                        </div>
                    {% endif %}
                    
                    <!-- Selection Checkbox -->
                    <div class="absolute top-2 left-2 hidden selection-mode">
                        <input type="checkbox" class="media-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                               value="{{ media.id }}" onchange="updateSelection()">
                        </div>
                    
                    <!-- Quick Actions -->
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        <div class="flex space-x-1">
                            <button onclick="editMedia({{ media.id }})" class="p-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 transition duration-200">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteMedia({{ media.id }})" class="p-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition duration-200">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- File Type Badge -->
                    <div class="absolute bottom-2 left-2">
                        <span class="px-2 py-1 text-xs font-medium rounded-full 
                                   {% if media.file_type == 'image' %}bg-green-100 text-green-800
                                   {% elif media.file_type == 'video' %}bg-blue-100 text-blue-800
                                   {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ media.file_type|upper }}
                        </span>
                    </div>
                </div>
                
                <div class="mt-2">
                    <p class="text-sm font-medium text-gray-900 truncate" title="{{ media.caption|default:'Media' }}">
                        {{ media.caption|default:'Media'|truncatechars:20 }}
                    </p>
                    <p class="text-xs text-gray-500">{{ media.file.name|truncatechars:25 }}</p>
                    <p class="text-xs text-gray-400">{{ media.file.size|filesizeformat }}</p>
                </div>
                </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <div class="mt-6 flex items-center justify-between">
            <div class="text-sm text-gray-700">
                Menampilkan {{ page_obj.start_index }} sampai {{ page_obj.end_index }} dari {{ page_obj.paginator.count }} media
            </div>
            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}" 
                       class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-50 text-sm font-medium text-blue-600">
                            {{ num }}
                        </span>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}" 
                           class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                            {{ num }}
                        </a>
                    {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}" 
                       class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
        
        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-images text-4xl text-gray-300 mb-4"></i>
            <p class="text-lg font-medium text-gray-900 mb-2">Belum ada media</p>
            <p class="text-gray-600 mb-4">Mulai dengan mengupload media pertama Anda</p>
            <button onclick="openUploadModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                <i class="fas fa-upload mr-2"></i>Upload Media Pertama
            </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 sm:w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Upload Media</h3>
                <button onclick="closeUploadModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
            </button>
        </div>
        
            <form method="POST" action="{% url 'news:news_media_upload' %}" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}
                <div class="space-y-4">
                    <div>
                        <label for="media_file" class="block text-sm font-medium text-gray-700 mb-2">Pilih File</label>
                        <input type="file" name="media_file" id="media_file" required multiple
                               accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Maksimal 10MB per file. Format: JPG, PNG, GIF, MP4, PDF, DOC</p>
                    </div>
                    
                    <div>
                        <label for="caption" class="block text-sm font-medium text-gray-700 mb-2">Caption (Opsional)</label>
                        <input type="text" name="caption" id="caption" 
                               placeholder="Deskripsi singkat media..."
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                        <select name="category" id="category" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Kategori</option>
                            {% for cat in categories %}
                                <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeUploadModal()" 
                                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-200">
                    Batal
                </button>
                        <button type="submit" id="uploadBtn" 
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition duration-200">
                    <i class="fas fa-upload mr-2"></i>Upload
                </button>
                    </div>
            </div>
        </form>
        </div>
    </div>
</div>

<!-- Media Preview Modal -->
<div id="mediaModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 sm:w-4/5 lg:w-3/4 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900" id="modalTitle">Preview Media</h3>
                <button onclick="closeMediaModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
            </button>
        </div>
        
            <div class="text-center">
                <div id="modalContent" class="mb-4">
                    <!-- Content will be loaded here -->
        </div>
        
                <div class="text-sm text-gray-600" id="modalCaption">
                    <!-- Caption will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 sm:w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mt-4">Konfirmasi Hapus</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">
                    Apakah Anda yakin ingin menghapus media ini? Tindakan ini tidak dapat dibatalkan.
                </p>
            </div>
            <div class="flex justify-center gap-3 mt-4">
                <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 text-sm">
                    Batal
                </button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm">
                        Hapus
                </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let isSelectionMode = false;
let selectedMedia = [];

// Modal functions
function openUploadModal() {
    document.getElementById('uploadModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeUploadModal() {
    document.getElementById('uploadModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    document.getElementById('uploadForm').reset();
}

function openMediaModal(fileUrl, caption, fileType) {
    const modal = document.getElementById('mediaModal');
    const content = document.getElementById('modalContent');
    const title = document.getElementById('modalTitle');
    const captionDiv = document.getElementById('modalCaption');
    
    title.textContent = caption || 'Preview Media';
    captionDiv.textContent = caption || '';
    
    if (fileType === 'image') {
        content.innerHTML = `<img src="${fileUrl}" alt="${caption || 'Media'}" class="max-w-full max-h-96 object-contain mx-auto">`;
    } else if (fileType === 'video') {
        content.innerHTML = `<video controls class="max-w-full max-h-96 mx-auto"><source src="${fileUrl}" type="video/mp4">Your browser does not support the video tag.</video>`;
    } else {
        content.innerHTML = `<div class="text-center"><i class="fas fa-file text-6xl text-gray-400 mb-4"></i><p class="text-gray-600">File: ${caption || 'Media'}</p><a href="${fileUrl}" download class="text-blue-600 hover:text-blue-800">Download File</a></div>`;
    }
    
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeMediaModal() {
    document.getElementById('mediaModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// Selection mode functions
function toggleSelectionMode() {
    isSelectionMode = !isSelectionMode;
    const toggleBtn = document.getElementById('selectionToggle');
    const bulkActions = document.getElementById('bulkActions');
    const checkboxes = document.querySelectorAll('.selection-mode');
    
    if (isSelectionMode) {
        toggleBtn.innerHTML = '<i class="fas fa-times mr-2"></i>Batal';
        toggleBtn.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
        checkboxes.forEach(cb => cb.classList.remove('hidden'));
        bulkActions.classList.remove('hidden');
    } else {
        toggleBtn.innerHTML = '<i class="fas fa-check-square mr-2"></i>Pilih';
        toggleBtn.classList.remove('bg-red-100', 'text-red-700', 'border-red-300');
        checkboxes.forEach(cb => cb.classList.add('hidden'));
        bulkActions.classList.add('hidden');
        selectedMedia = [];
        updateSelection();
    }
}

function updateSelection() {
    const checkboxes = document.querySelectorAll('.media-checkbox:checked');
    selectedMedia = Array.from(checkboxes).map(cb => cb.value);
    document.getElementById('selectedCount').textContent = `${selectedMedia.length} dipilih`;
}

// Media actions
function editMedia(mediaId) {
    // Redirect to edit page or open edit modal
    window.location.href = `/admin/news/media/edit/${mediaId}/`;
}

function deleteMedia(mediaId) {
    // Set the form action to the delete URL
    const deleteForm = document.getElementById('deleteForm');
    deleteForm.action = `/admin/news/media/delete/${mediaId}/`;
    
    // Show the delete confirmation modal
    document.getElementById('deleteModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function deleteSelected() {
    if (selectedMedia.length === 0) {
        alert('Pilih media yang akan dihapus');
        return;
    }
    
    if (!confirm(`Apakah Anda yakin ingin menghapus ${selectedMedia.length} media yang dipilih?`)) {
        return;
    }
    
    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "news:news_media_bulk_delete" %}';
    
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrfmiddlewaretoken';
    csrfToken.value = '{{ csrf_token }}';
    form.appendChild(csrfToken);
    
    selectedMedia.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'media_ids';
        input.value = id;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}

// Form handling
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit form when filters change
    const filterForm = document.querySelector('form[method="GET"]');
    const filterInputs = filterForm.querySelectorAll('select');
    
    filterInputs.forEach(input => {
        input.addEventListener('change', () => filterForm.submit());
    });
    
    // Search with debounce
    let searchTimeout;
    const searchInput = document.getElementById('search');
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            filterForm.submit();
        }, 500);
    });
    
    // Upload form handling
    const uploadForm = document.getElementById('uploadForm');
    uploadForm.addEventListener('submit', function(e) {
        const uploadBtn = document.getElementById('uploadBtn');
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
    });

// Close modals when clicking outside
    const modals = ['uploadModal', 'mediaModal', 'deleteModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
                if (modalId === 'uploadModal') closeUploadModal();
                else if (modalId === 'mediaModal') closeMediaModal();
                else if (modalId === 'deleteModal') closeDeleteModal();
        }
    });
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
            closeUploadModal();
            closeMediaModal();
            closeDeleteModal();
        }
    });
});
</script>
{% endblock %}