{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Tambah Berita Baru{% endblock %}

{% block extra_css %}
<!-- Summernote CSS -->
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
<style>
    .form-control {
        display: block;
        width: 100%;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #495057;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-control:focus {
        color: #495057;
        background-color: #fff;
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .form-check-input {
        width: 1rem;
        height: 1rem;
        margin-top: 0.25em;
        vertical-align: top;
        background-color: #fff;
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
        border: 1px solid #ced4da;
        appearance: none;
        color-adjust: exact;
    }
    
    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .form-check-input:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .image-preview {
        max-width: 200px;
        max-height: 200px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
    }
    .additional-image-item {
        position: relative;
        display: inline-block;
        margin: 10px;
    }
    .remove-image-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .drag-drop-area {
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        background: #f9fafb;
        transition: all 0.3s ease;
    }
    .drag-drop-area.dragover {
        border-color: #3b82f6;
        background: #eff6ff;
    }
    .form-section {
        background: white;
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e5e7eb;
    }
    .form-group {
        margin-bottom: 1rem;
    }
    .form-label {
        display: inline-block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }
    .form-text {
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #6c757d;
    }
    .invalid-feedback {
        display: block;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Tambah Berita Baru</h1>
            <p class="text-gray-600 mt-1">Buat dan publikasikan berita baru untuk website desa</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="history.back()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                <i class="fas fa-arrow-left mr-2"></i>Kembali
            </button>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" id="newsForm">
        {% csrf_token %}
        
        <!-- Informasi Dasar -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                Informasi Dasar
            </h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="form-group">
                    <label for="{{ form.title.id_for_label }}" class="form-label">
                        {{ form.title.label }}
                        <span class="text-red-500">*</span>
                    </label>
                    {{ form.title }}
                    {% if form.title.errors %}
                        <div class="invalid-feedback">
                            {{ form.title.errors.0 }}
                        </div>
                    {% endif %}
                    {% if form.title.help_text %}
                        <div class="form-text">{{ form.title.help_text }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.slug.id_for_label }}" class="form-label">
                        {{ form.slug.label }}
                        <span class="text-gray-400 text-xs">(Otomatis diisi)</span>
                    </label>
                    {{ form.slug }}
                    {% if form.slug.errors %}
                        <div class="invalid-feedback">
                            {{ form.slug.errors.0 }}
                        </div>
                    {% endif %}
                    {% if form.slug.help_text %}
                        <div class="form-text">{{ form.slug.help_text }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-group mt-6">
                <label for="{{ form.excerpt.id_for_label }}" class="form-label">
                    {{ form.excerpt.label }}
                </label>
                {{ form.excerpt }}
                {% if form.excerpt.errors %}
                    <div class="invalid-feedback">
                        {{ form.excerpt.errors.0 }}
                    </div>
                {% endif %}
                {% if form.excerpt.help_text %}
                    <div class="form-text">{{ form.excerpt.help_text }}</div>
                {% endif %}
            </div>
        </div>

        <!-- Konten Berita -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-edit mr-2 text-green-500"></i>
                Konten Berita
            </h2>
            
            <div class="form-group">
                <label for="{{ form.content.id_for_label }}" class="form-label">
                    {{ form.content.label }}
                    <span class="text-red-500">*</span>
                </label>
                {{ form.content }}
                {% if form.content.errors %}
                    <div class="invalid-feedback">
                        {{ form.content.errors.0 }}
                    </div>
                {% endif %}
                {% if form.content.help_text %}
                    <div class="form-text">{{ form.content.help_text }}</div>
                {% endif %}
            </div>
        </div>

        <!-- Kategori dan Tag -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-tags mr-2 text-purple-500"></i>
                Kategori dan Tag
            </h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="form-group">
                    <label for="{{ form.category.id_for_label }}" class="form-label">
                        {{ form.category.label }}
                        <span class="text-red-500">*</span>
                    </label>
                    {{ form.category }}
                    {% if form.category.errors %}
                        <div class="invalid-feedback">
                            {{ form.category.errors.0 }}
                        </div>
                    {% endif %}
                    {% if form.category.help_text %}
                        <div class="form-text">{{ form.category.help_text }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.tags.id_for_label }}" class="form-label">
                        {{ form.tags.label }}
                        <span class="text-gray-400 text-xs">(Pisahkan dengan koma)</span>
                    </label>
                    {{ form.tags }}
                    {% if form.tags.errors %}
                        <div class="invalid-feedback">
                            {{ form.tags.errors.0 }}
                        </div>
                    {% endif %}
                    {% if form.tags.help_text %}
                        <div class="form-text">{{ form.tags.help_text }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Gambar Utama -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-image mr-2 text-indigo-500"></i>
                Gambar Utama
            </h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="form-group">
                    <label for="{{ form.featured_image.id_for_label }}" class="form-label">
                        {{ form.featured_image.label }}
                    </label>
                    <div class="drag-drop-area" id="featuredImageDropArea">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600 mb-2">Drag & drop gambar atau klik untuk pilih</p>
                        {{ form.featured_image }}
                    </div>
                    {% if form.featured_image.errors %}
                        <div class="invalid-feedback">
                            {{ form.featured_image.errors.0 }}
                        </div>
                    {% endif %}
                    {% if form.featured_image.help_text %}
                        <div class="form-text">{{ form.featured_image.help_text }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.featured_image_alt.id_for_label }}" class="form-label">
                        {{ form.featured_image_alt.label }}
                    </label>
                    {{ form.featured_image_alt }}
                    {% if form.featured_image_alt.errors %}
                        <div class="invalid-feedback">
                            {{ form.featured_image_alt.errors.0 }}
                        </div>
                    {% endif %}
                    {% if form.featured_image_alt.help_text %}
                        <div class="form-text">{{ form.featured_image_alt.help_text }}</div>
                    {% endif %}
                    
                    <!-- Preview Gambar Utama -->
                    <div id="featuredImagePreview" class="mt-4" style="display: none;">
                        <img id="featuredImageImg" class="image-preview" src="" alt="Preview">
                        <button type="button" id="removeFeaturedImage" class="remove-image-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gambar Tambahan -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-images mr-2 text-yellow-500"></i>
                Gambar Tambahan
            </h2>
            
            <div class="form-group">
                <label class="form-label">
                    Upload Gambar Tambahan
                    <span class="text-gray-400 text-xs">(Maksimal 5 gambar)</span>
                </label>
                <div class="drag-drop-area" id="additionalImagesDropArea">
                    <i class="fas fa-images text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-2">Drag & drop gambar atau klik untuk pilih</p>
                    <input type="file" id="additionalImages" name="additional_images" multiple accept="image/*" class="hidden">
                    <button type="button" onclick="document.getElementById('additionalImages').click()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        Pilih Gambar
                    </button>
                </div>
                
                <!-- Preview Gambar Tambahan -->
                <div id="additionalImagesPreview" class="mt-4"></div>
            </div>
        </div>

        <!-- Pengaturan Publikasi -->
        <div class="form-section">
            <h2 class="section-title">
                <i class="fas fa-calendar-alt mr-2 text-red-500"></i>
                Pengaturan Publikasi
            </h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="form-group">
                    <label for="{{ form.status.id_for_label }}" class="form-label">
                        {{ form.status.label }}
                        <span class="text-red-500">*</span>
                    </label>
                    {{ form.status }}
                    {% if form.status.errors %}
                        <div class="invalid-feedback">
                            {{ form.status.errors.0 }}
                        </div>
                    {% endif %}
                    {% if form.status.help_text %}
                        <div class="form-text">{{ form.status.help_text }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.priority.id_for_label }}" class="form-label">
                        {{ form.priority.label }}
                        <span class="text-red-500">*</span>
                    </label>
                    {{ form.priority }}
                    {% if form.priority.errors %}
                        <div class="invalid-feedback">
                            {{ form.priority.errors.0 }}
                        </div>
                    {% endif %}
                    {% if form.priority.help_text %}
                        <div class="form-text">{{ form.priority.help_text }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.is_featured.id_for_label }}" class="form-label">
                        {{ form.is_featured.label }}
                    </label>
                    <div class="flex items-center">
                        {{ form.is_featured }}
                        <span class="ml-2 text-sm text-gray-600">Tampilkan di halaman utama</span>
                    </div>
                    {% if form.is_featured.errors %}
                        <div class="invalid-feedback">
                            {{ form.is_featured.errors.0 }}
                        </div>
                    {% endif %}
                    {% if form.is_featured.help_text %}
                        <div class="form-text">{{ form.is_featured.help_text }}</div>
                    {% endif %}
                </div>
                
                <div id="scheduledDateField" style="display: none;">
                    <label for="{{ form.scheduled_date.id_for_label }}" class="form-label">
                        {{ form.scheduled_date.label }}
                    </label>
                    {{ form.scheduled_date }}
                    {% if form.scheduled_date.errors %}
                        <div class="invalid-feedback">
                            {{ form.scheduled_date.errors.0 }}
                        </div>
                    {% endif %}
                    {% if form.scheduled_date.help_text %}
                        <div class="form-text">{{ form.scheduled_date.help_text }}</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tombol Aksi -->
        <div class="flex justify-end space-x-3">
            <a href="{% url 'news:news_admin' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition duration-200">
                <i class="fas fa-times mr-2"></i>Batal
            </a>
            <button type="button" id="saveDraftBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg transition duration-200">
                <i class="fas fa-save mr-2"></i>Simpan Draft
            </button>
            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition duration-200">
                <i class="fas fa-paper-plane mr-2"></i>Publikasikan
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Summernote JS -->
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
<!-- Summernote Indonesian -->
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/lang/summernote-id-ID.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize Summernote
    $('#id_content').summernote({
        height: 400,
        lang: 'id-ID',
        toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'underline', 'clear']],
            ['fontname', ['fontname']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['table', ['table']],
            ['insert', ['link', 'picture', 'video']],
            ['view', ['fullscreen', 'codeview', 'help']]
        ],
        callbacks: {
            onImageUpload: function(files) {
                // Handle image upload
                for (let i = 0; i < files.length; i++) {
                    uploadImage(files[i]);
                }
            }
        }
    });
    
    // Auto-generate slug from title
    $('#id_title').on('input', function() {
        const title = $(this).val();
        const slug = title.toLowerCase()
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .trim('-');
        $('#id_slug').val(slug);
    });
    
    // Show/hide scheduled date field
    $('#id_status').on('change', function() {
        if ($(this).val() === 'scheduled') {
            $('#scheduledDateField').show();
        } else {
            $('#scheduledDateField').hide();
        }
    });
    
    // Featured image upload
    setupFeaturedImageUpload();
    
    // Additional images upload
    setupAdditionalImagesUpload();
    
    // Save Draft button
    $('#saveDraftBtn').on('click', function() {
        console.log('Save Draft clicked');
        alert('Save Draft button clicked');
        $('#id_status').val('draft');
        console.log('Status set to:', $('#id_status').val());
        if (validateForm()) {
            console.log('Validation passed, submitting form');
            alert('Validation passed, submitting form');
            $('#newsForm').submit();
        } else {
            console.log('Validation failed');
            alert('Validation failed');
        }
    });
    
    // Publish button - set status to published when form is submitted via publish button
    $('button[type="submit"]:contains("Publikasikan")').on('click', function(e) {
        console.log('Publish button clicked');
        alert('Publish button clicked');
        $('#id_status').val('published');
        console.log('Status set to:', $('#id_status').val());
    });
    
    // Form validation
    $('#newsForm').on('submit', function(e) {
        console.log('Form submit triggered');
        alert('Form submit triggered - check console for details');
        
        if (!validateForm()) {
            console.log('Form validation failed');
            alert('Form validation failed');
            e.preventDefault();
            return false;
        }
        
        console.log('Form validation passed, submitting...');
        alert('Form validation passed, submitting...');
        
        // Update Summernote content to textarea before submit
        $('#id_content').val($('#id_content').summernote('code'));
        
        // Log form data for debugging
        const formData = new FormData(this);
        console.log('Form data:');
        for (let [key, value] of formData.entries()) {
            console.log(key + ': ' + value);
        }
        
        // Show loading state
        const submitBtn = $(this).find('button[type="submit"]');
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...');
        
        return true;
    });
});

function setupFeaturedImageUpload() {
    const dropArea = $('#featuredImageDropArea');
    const fileInput = $('#id_featured_image');
    const preview = $('#featuredImagePreview');
    const previewImg = $('#featuredImageImg');
    const removeBtn = $('#removeFeaturedImage');
    
    // Click to upload
    dropArea.on('click', function() {
        fileInput.click();
    });
    
    // Drag and drop
    dropArea.on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });
    
    dropArea.on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
    });
    
    dropArea.on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        
        const files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
            fileInput[0].files = files;
            previewFeaturedImage(files[0]);
        }
    });
    
    // File input change
    fileInput.on('change', function() {
        if (this.files && this.files[0]) {
            previewFeaturedImage(this.files[0]);
        }
    });
    
    // Remove image
    removeBtn.on('click', function() {
        fileInput.val('');
        preview.hide();
        dropArea.show();
    });
}

function previewFeaturedImage(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        $('#featuredImageImg').attr('src', e.target.result);
        $('#featuredImagePreview').show();
        $('#featuredImageDropArea').hide();
    };
    reader.readAsDataURL(file);
}

function setupAdditionalImagesUpload() {
    const dropArea = $('#additionalImagesDropArea');
    const fileInput = $('#additionalImages');
    const preview = $('#additionalImagesPreview');
    let additionalImages = [];
    
    // Drag and drop
    dropArea.on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });
    
    dropArea.on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
    });
    
    dropArea.on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        
        const files = e.originalEvent.dataTransfer.files;
        handleAdditionalImages(files);
    });
    
    // File input change
    fileInput.on('change', function() {
        handleAdditionalImages(this.files);
    });
    
    function handleAdditionalImages(files) {
        for (let i = 0; i < files.length && additionalImages.length < 5; i++) {
            const file = files[i];
            if (file.type.startsWith('image/')) {
                additionalImages.push(file);
                previewAdditionalImage(file, additionalImages.length - 1);
            }
        }
    }
    
    function previewAdditionalImage(file, index) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const imageItem = $(`
                <div class="additional-image-item" data-index="${index}">
                    <img src="${e.target.result}" class="image-preview" alt="Preview">
                    <button type="button" class="remove-image-btn" onclick="removeAdditionalImage(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                    <input type="text" placeholder="Caption (opsional)" class="mt-2 w-full px-3 py-1 border border-gray-300 rounded text-sm" name="image_caption_${index}">
                </div>
            `);
            preview.append(imageItem);
        };
        reader.readAsDataURL(file);
    }
    
    window.removeAdditionalImage = function(index) {
        additionalImages.splice(index, 1);
        $(`.additional-image-item[data-index="${index}"]`).remove();
        
        // Re-index remaining images
        $('.additional-image-item').each(function(i) {
            $(this).attr('data-index', i);
            $(this).find('.remove-image-btn').attr('onclick', `removeAdditionalImage(${i})`);
            $(this).find('input').attr('name', `image_caption_${i}`);
        });
    };
}

function uploadImage(file) {
    // Placeholder for image upload to server
    const formData = new FormData();
    formData.append('image', file);
    
    // This would be an AJAX call to upload the image
    // For now, we'll just insert a placeholder
    const reader = new FileReader();
    reader.onload = function(e) {
        $('#id_content').summernote('insertImage', e.target.result);
    };
    reader.readAsDataURL(file);
}

function validateForm() {
    let isValid = true;
    const errors = [];
    
    // Validate title
    const title = $('#id_title').val().trim();
    console.log('Title:', title);
    if (!title) {
        $('#id_title').addClass('border-red-500');
        errors.push('Judul wajib diisi');
        isValid = false;
    } else {
        $('#id_title').removeClass('border-red-500');
    }
    
    // Validate content (Summernote)
    const content = $('#id_content').summernote('code').trim();
    console.log('Content:', content);
    if (!content || content === '<p><br></p>' || content === '<br>') {
        $('#id_content').next('.note-editor').addClass('border-red-500');
        errors.push('Konten wajib diisi');
        isValid = false;
    } else {
        $('#id_content').next('.note-editor').removeClass('border-red-500');
    }
    
    // Validate category
    const category = $('#id_category').val();
    console.log('Category:', category);
    if (!category) {
        $('#id_category').addClass('border-red-500');
        errors.push('Kategori wajib dipilih');
        isValid = false;
    } else {
        $('#id_category').removeClass('border-red-500');
    }
    
    if (!isValid) {
        console.log('Validation errors:', errors);
        alert('Mohon lengkapi semua field yang wajib diisi:\n- ' + errors.join('\n- '));
    } else {
        console.log('All validations passed');
    }
    
    return isValid;
}

// Show notification
function showNotification(message, type = 'success') {
    const notification = $(`
        <div class="fixed top-4 right-4 z-50 p-4 rounded-lg text-white ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        } shadow-lg">
            ${message}
        </div>
    `);
    
    $('body').append(notification);
    
    setTimeout(function() {
        notification.fadeOut(function() {
            $(this).remove();
        });
    }, 3000);
}
</script>
{% endblock %}