{% extends 'admin/base.html' %}

{% block title %}Dashboard Organisasi{% endblock %}

{% block page_title %}Dashboard Organisasi{% endblock %}

{% block content %}
{% csrf_token %}
<div class="p-4 sm:p-6">
    <!-- Header Section -->
    <div class="mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Dashboard Organisasi</h1>
                <p class="mt-1 text-sm text-gray-600">Kelola data organisasi desa Pulosarok</p>
            </div>
            <div class="mt-4 sm:mt-0">
                <span class="text-sm text-gray-500">Terakhir diperbarui: </span>
                <span class="text-sm font-medium text-gray-900" id="last-updated"></span>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
        <!-- Perangkat Desa -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-user-tie text-2xl text-blue-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Perangkat Desa</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ perangkat_count }}</dd>
                            <dd class="text-xs text-green-600">{{ active_perangkat }} aktif</dd>
                        </dl>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-5 py-3">
                <div class="text-sm">
                    <a href="{% url 'organization:perangkat_list' %}" class="font-medium text-blue-700 hover:text-blue-900">
                        Lihat semua
                    </a>
                </div>
            </div>
        </div>

        <!-- Lembaga Adat -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-landmark text-2xl text-purple-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Lembaga Adat</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ lembaga_adat_count }}</dd>
                            <dd class="text-xs text-green-600">{{ active_lembaga }} aktif</dd>
                        </dl>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-5 py-3">
                <div class="text-sm">
                    <a href="{% url 'organization:lembaga_adat_list' %}" class="font-medium text-purple-700 hover:text-purple-900">
                        Lihat semua
                    </a>
                </div>
            </div>
        </div>

        <!-- Penggerak PKK -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-users text-2xl text-pink-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Penggerak PKK</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ penggerak_pkk_count }}</dd>
                            <dd class="text-xs text-green-600">{{ active_pkk }} aktif</dd>
                        </dl>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-5 py-3">
                <div class="text-sm">
                    <a href="{% url 'organization:penggerak_pkk_list' %}" class="font-medium text-pink-700 hover:text-pink-900">
                        Lihat semua
                    </a>
                </div>
            </div>
        </div>

        <!-- Kepemudaan -->
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-graduation-cap text-2xl text-green-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Kepemudaan</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ kepemudaan_count }}</dd>
                            <dd class="text-xs text-green-600">{{ active_kepemudaan }} aktif</dd>
                        </dl>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-5 py-3">
                <div class="text-sm">
                    <a href="{% url 'organization:kepemudaan_list' %}" class="font-medium text-green-700 hover:text-green-900">
                        Lihat semua
                    </a>
                </div>
            </div>
        </div>

        <!-- Karang Taruna -->
        <div class="bg-white overflow-hidden shadow rounded-lg" style="display: none;">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-handshake text-2xl text-orange-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Karang Taruna</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ karang_taruna_count }}</dd>
                            <dd class="text-xs text-green-600">{{ active_karang_taruna }} aktif</dd>
                        </dl>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-5 py-3">
                <div class="text-sm">
                    <a href="{% url 'organization:karang_taruna_list' %}" class="font-medium text-orange-700 hover:text-orange-900">
                        Lihat semua
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Aksi Cepat -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                    <i class="fas fa-bolt mr-2 text-yellow-500"></i>Aksi Cepat
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <a href="{% url 'organization:perangkat_add' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-plus mr-2"></i>Tambah Perangkat
                    </a>
                    <a href="{% url 'organization:lembaga_adat_add' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        <i class="fas fa-plus mr-2"></i>Tambah Lembaga
                    </a>
                    <a href="{% url 'organization:penggerak_pkk_add' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500">
                        <i class="fas fa-plus mr-2"></i>Tambah PKK
                    </a>
                    <a href="{% url 'organization:kepemudaan_add' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <i class="fas fa-plus mr-2"></i>Tambah Kepemudaan
                    </a>
                </div>
            </div>
        </div>

        <!-- Informasi Sistem -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                    <i class="fas fa-info-circle mr-2 text-blue-500"></i>Informasi Sistem
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Total Organisasi:</span>
                        <span class="text-sm font-medium text-gray-900" id="total-organizations">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Total Anggota Aktif:</span>
                        <span class="text-sm font-medium text-gray-900" id="total-active-members">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Organisasi Terbaru:</span>
                        <span class="text-sm font-medium text-gray-900" id="latest-organization">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Aktivasi Terbaru -->
    <div class="bg-white shadow rounded-lg mb-8">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                <i class="fas fa-toggle-on mr-2 text-green-500"></i>Aktivasi Terbaru
            </h3>
            <div class="space-y-4" id="activation-section">
                <div class="text-center py-4 text-gray-500">
                    <i class="fas fa-spinner fa-spin mr-2"></i>Memuat data organisasi...
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activities -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                <i class="fas fa-clock mr-2 text-gray-500"></i>Aktivitas Terbaru
            </h3>
            <div class="flow-root">
                <ul class="-mb-8" id="recent-activities">
                    <li class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Memuat aktivitas...
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Update timestamp
document.getElementById('last-updated').textContent = new Date().toLocaleString('id-ID');

// Calculate totals
function updateTotals() {
    const perangkat = {{ perangkat_count }};
    const lembaga = {{ lembaga_adat_count }};
    const pkk = {{ penggerak_pkk_count }};
    const kepemudaan = {{ kepemudaan_count }};
    const karangTaruna = {{ karang_taruna_count }};
    
    const totalOrganizations = perangkat + lembaga + pkk + kepemudaan + karangTaruna;
    const totalActiveMembers = {{ active_perangkat }} + {{ active_lembaga }} + {{ active_pkk }} + {{ active_kepemudaan }} + {{ active_karang_taruna }};
    
    document.getElementById('total-organizations').textContent = totalOrganizations;
    document.getElementById('total-active-members').textContent = totalActiveMembers;
}

// Load recent activities from API
function loadRecentActivities() {
    const container = document.getElementById('recent-activities');
    
    // Show loading state
    container.innerHTML = `
        <li class="text-center py-8 text-gray-500">
            <i class="fas fa-spinner fa-spin mr-2"></i>Memuat aktivitas...
        </li>
    `;
    
    // Fetch recent activities from API
    fetch('{% url "organization:api_recent_activities" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.activities) {
                displayActivities(data.activities);
            } else {
                showNoActivities();
            }
        })
        .catch(error => {
            console.error('Error loading recent activities:', error);
            showErrorState();
        });
}

// Display activities in the UI
function displayActivities(activities) {
    const container = document.getElementById('recent-activities');
    container.innerHTML = '';
    
    if (activities.length === 0) {
        showNoActivities();
        return;
    }
    
    activities.forEach((activity, index) => {
        const isLast = index === activities.length - 1;
        const li = document.createElement('li');
        li.className = isLast ? '' : 'pb-8';
        
        // Get icon and color based on organization type
        const iconInfo = getIconForOrganizationType(activity.organization_type);
        
        // Format timestamp
        const timeAgo = formatTimeAgo(activity.timestamp);
        
        li.innerHTML = `
            <div class="relative">
                ${!isLast ? '<span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>' : ''}
                <div class="relative flex space-x-3">
                    <div>
                        <span class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center ring-8 ring-white">
                            <i class="fas ${iconInfo.icon} ${iconInfo.color}"></i>
                        </span>
                    </div>
                    <div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4">
                        <div>
                            <p class="text-sm text-gray-900">${activity.description}</p>
                            <p class="text-xs text-gray-500">Status: ${activity.status}</p>
                        </div>
                        <div class="text-right text-sm whitespace-nowrap text-gray-500">
                            <time>${timeAgo}</time>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(li);
    });
}

// Get icon and color for organization type
function getIconForOrganizationType(orgType) {
    const iconMap = {
        'Perangkat Desa': { icon: 'fa-user-tie', color: 'text-blue-600' },
        'Lembaga Adat': { icon: 'fa-landmark', color: 'text-purple-600' },
        'Penggerak PKK': { icon: 'fa-users', color: 'text-pink-600' },
        'Kepemudaan': { icon: 'fa-user-friends', color: 'text-green-600' },
        'Karang Taruna': { icon: 'fa-seedling', color: 'text-orange-600' }
    };
    
    return iconMap[orgType] || { icon: 'fa-building', color: 'text-gray-600' };
}

// Format timestamp to relative time
function formatTimeAgo(timestamp) {
    const now = new Date();
    const activityTime = new Date(timestamp);
    const diffInSeconds = Math.floor((now - activityTime) / 1000);
    
    if (diffInSeconds < 60) {
        return 'Baru saja';
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} menit yang lalu`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} jam yang lalu`;
    } else {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days} hari yang lalu`;
    }
}

// Show no activities state
function showNoActivities() {
    const container = document.getElementById('recent-activities');
    container.innerHTML = `
        <li class="text-center py-8 text-gray-500">
            <i class="fas fa-inbox mr-2"></i>Belum ada aktivitas terbaru
        </li>
    `;
}

// Show error state
function showErrorState() {
    const container = document.getElementById('recent-activities');
    container.innerHTML = `
        <li class="text-center py-8 text-red-500">
            <i class="fas fa-exclamation-triangle mr-2"></i>Gagal memuat aktivitas
        </li>
    `;
}

// Load organizations for activation toggle
function loadActivationSection() {
    const container = document.getElementById('activation-section');
    
    // Show loading state
    container.innerHTML = `
        <div class="text-center py-4 text-gray-500">
            <i class="fas fa-spinner fa-spin mr-2"></i>Memuat data organisasi...
        </div>
    `;
    
    // Fetch organizations from all types
    const orgTypes = [
        { type: 'perangkat_desa', name: 'Perangkat Desa', endpoint: '{% url "organization:api_perangkat_desa_list" %}' },
        { type: 'lembaga_adat', name: 'Lembaga Adat', endpoint: '{% url "organization:api_lembaga_adat_list" %}' },
        { type: 'penggerak_pkk', name: 'Penggerak PKK', endpoint: '{% url "organization:api_penggerak_pkk_list" %}' },
        { type: 'kepemudaan', name: 'Kepemudaan', endpoint: '{% url "organization:api_kepemudaan_list" %}' },
        { type: 'karang_taruna', name: 'Karang Taruna', endpoint: '{% url "organization:api_karang_taruna_list" %}' }
    ];
    
    Promise.all(orgTypes.map(orgType => 
        fetch(orgType.endpoint)
            .then(response => response.json())
            .then(data => ({ ...orgType, data: data.data || [] }))
    ))
    .then(results => {
        displayActivationToggles(results);
    })
    .catch(error => {
        console.error('Error loading organizations:', error);
        container.innerHTML = `
            <div class="text-center py-4 text-red-500">
                <i class="fas fa-exclamation-triangle mr-2"></i>Gagal memuat data organisasi
            </div>
        `;
    });
}

// Display activation toggles
function displayActivationToggles(orgTypes) {
    const container = document.getElementById('activation-section');
    container.innerHTML = '';
    
    orgTypes.forEach(orgType => {
        if (orgType.data && orgType.data.length > 0) {
            // Show only first 3 organizations per type
            const orgsToShow = orgType.data.slice(0, 3);
            
            orgsToShow.forEach(org => {
                const toggleDiv = document.createElement('div');
                toggleDiv.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg';
                
                const statusColor = org.status === 'aktif' ? 'text-green-600' : 
                                  org.status === 'non_aktif' ? 'text-red-600' : 'text-yellow-600';
                
                toggleDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <i class="fas ${getIconForOrganizationType(orgType.name).icon} ${getIconForOrganizationType(orgType.name).color}"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${org.nama}</p>
                            <p class="text-xs text-gray-500">${orgType.name}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="text-sm font-medium ${statusColor}">${org.status}</span>
                        <select class="text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" 
                                onchange="toggleOrganizationStatus('${orgType.type}', ${org.id}, this.value)">
                            <option value="aktif" ${org.status === 'aktif' ? 'selected' : ''}>Aktif</option>
                            <option value="non_aktif" ${org.status === 'non_aktif' ? 'selected' : ''}>Non Aktif</option>
                            <option value="dalam_pembinaan" ${org.status === 'dalam_pembinaan' ? 'selected' : ''}>Dalam Pembinaan</option>
                        </select>
                    </div>
                `;
                
                container.appendChild(toggleDiv);
            });
        }
    });
    
    if (container.children.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4 text-gray-500">
                <i class="fas fa-inbox mr-2"></i>Tidak ada organisasi yang ditemukan
            </div>
        `;
    }
}

// Toggle organization status
function toggleOrganizationStatus(orgType, orgId, newStatus) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "organization:api_toggle_organization_status" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            organization_type: orgType,
            organization_id: orgId,
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showNotification('success', data.message);
            // Reload activation section and recent activities
            loadActivationSection();
            loadRecentActivities();
            // Update totals
            updateTotals();
        } else {
            showNotification('error', data.error || 'Gagal mengubah status organisasi');
            // Reload to reset the select value
            loadActivationSection();
        }
    })
    .catch(error => {
        console.error('Error toggling status:', error);
        showNotification('error', 'Terjadi kesalahan saat mengubah status');
        // Reload to reset the select value
        loadActivationSection();
    });
}

// Show notification
function showNotification(type, message) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-md shadow-lg ${
        type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 
        'bg-red-100 text-red-800 border border-red-200'
    }`;
    
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${
                type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'
            } mr-2"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateTotals();
    loadRecentActivities();
    loadActivationSection();
});
</script>
{% endblock %}