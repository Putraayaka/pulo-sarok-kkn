{% extends 'admin/base.html' %}

{% block title %}Dashboard Organisasi{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-2 sm:p-4 lg:p-6">
    <!-- Header Section -->
    <div class="mb-4 sm:mb-6">
        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 lg:p-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div>
                    <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900">Dashboard Organisasi</h1>
                    <p class="text-sm sm:text-base text-gray-600 mt-1">Kelola data organisasi dan kegiatan</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <button onclick="refreshAllData()" class="bg-primary-600 hover:bg-primary-700 text-white px-3 py-2 sm:px-4 sm:py-2 rounded-lg text-sm sm:text-base font-medium transition-colors duration-200 flex items-center gap-2">
                        <i class="fas fa-sync-alt text-xs sm:text-sm"></i>
                        <span>Refresh Data</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6 mb-4 sm:mb-6">
        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 lg:p-6">
            <div class="flex items-center">
                <div class="p-2 sm:p-3 bg-blue-100 rounded-lg">
                    <i class="fas fa-users text-blue-600 text-lg sm:text-xl lg:text-2xl"></i>
                </div>
                <div class="ml-3 sm:ml-4">
                    <p class="text-xs sm:text-sm font-medium text-gray-600">Total Organisasi</p>
                    <p class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-900" id="totalOrganisasi">0</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 lg:p-6">
            <div class="flex items-center">
                <div class="p-2 sm:p-3 bg-green-100 rounded-lg">
                    <i class="fas fa-user-friends text-green-600 text-lg sm:text-xl lg:text-2xl"></i>
                </div>
                <div class="ml-3 sm:ml-4">
                    <p class="text-xs sm:text-sm font-medium text-gray-600">Total Anggota</p>
                    <p class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-900" id="totalAnggota">0</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 lg:p-6">
            <div class="flex items-center">
                <div class="p-2 sm:p-3 bg-purple-100 rounded-lg">
                    <i class="fas fa-user-tie text-purple-600 text-lg sm:text-xl lg:text-2xl"></i>
                </div>
                <div class="ml-3 sm:ml-4">
                    <p class="text-xs sm:text-sm font-medium text-gray-600">Total Jabatan</p>
                    <p class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-900" id="totalJabatan">0</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 lg:p-6">
            <div class="flex items-center">
                <div class="p-2 sm:p-3 bg-yellow-100 rounded-lg">
                    <i class="fas fa-images text-yellow-600 text-lg sm:text-xl lg:text-2xl"></i>
                </div>
                <div class="ml-3 sm:ml-4">
                    <p class="text-xs sm:text-sm font-medium text-gray-600">Galeri Kegiatan</p>
                    <p class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-900" id="totalGaleri">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 lg:p-6 mb-4 sm:mb-6">
        <h2 class="text-lg sm:text-xl font-semibold text-gray-900 mb-3 sm:mb-4">Aksi Cepat</h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 sm:gap-4">
            <a href="/pulosarok/organization/data-anggota/" class="flex flex-col items-center p-3 sm:p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors duration-200">
                <i class="fas fa-user-friends text-blue-600 text-xl sm:text-2xl mb-2"></i>
                <span class="text-xs sm:text-sm font-medium text-blue-800 text-center">Data Anggota</span>
            </a>
            <a href="/pulosarok/organization/data-jabatan/" class="flex flex-col items-center p-3 sm:p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors duration-200">
                <i class="fas fa-user-tie text-green-600 text-xl sm:text-2xl mb-2"></i>
                <span class="text-xs sm:text-sm font-medium text-green-800 text-center">Data Jabatan</span>
            </a>
            <a href="/pulosarok/organization/galeri-kegiatan/" class="flex flex-col items-center p-3 sm:p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors duration-200">
                <i class="fas fa-images text-purple-600 text-xl sm:text-2xl mb-2"></i>
                <span class="text-xs sm:text-sm font-medium text-purple-800 text-center">Galeri Kegiatan</span>
            </a>
            <a href="/pulosarok/organization/kategori-organisasi/" class="flex flex-col items-center p-3 sm:p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition-colors duration-200">
                <i class="fas fa-tags text-yellow-600 text-xl sm:text-2xl mb-2"></i>
                <span class="text-xs sm:text-sm font-medium text-yellow-800 text-center">Kategori</span>
            </a>
            <a href="/pulosarok/organization/periode-kepengurusan/" class="flex flex-col items-center p-3 sm:p-4 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors duration-200">
                <i class="fas fa-calendar text-indigo-600 text-xl sm:text-2xl mb-2"></i>
                <span class="text-xs sm:text-sm font-medium text-indigo-800 text-center">Periode</span>
            </a>
            <a href="/pulosarok/organization/struktur-organisasi/" class="flex flex-col items-center p-3 sm:p-4 bg-red-50 hover:bg-red-100 rounded-lg transition-colors duration-200">
                <i class="fas fa-sitemap text-red-600 text-xl sm:text-2xl mb-2"></i>
                <span class="text-xs sm:text-sm font-medium text-red-800 text-center">Struktur</span>
            </a>
        </div>
    </div>

    <!-- Recent Activities & Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-4 sm:mb-6">
        <!-- Recent Activities -->
        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 lg:p-6">
            <div class="flex items-center justify-between mb-3 sm:mb-4">
                <h2 class="text-lg sm:text-xl font-semibold text-gray-900">Aktivitas Terbaru</h2>
                <button onclick="loadRecentActivities()" class="text-primary-600 hover:text-primary-700 text-sm">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div id="recentActivities" class="space-y-3">
                <!-- Recent activities will be loaded here -->
            </div>
            <div id="activitiesLoading" class="flex items-center justify-center py-4">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"></div>
                <span class="ml-2 text-sm text-gray-600">Memuat aktivitas...</span>
            </div>
        </div>

        <!-- Organization Chart -->
        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 lg:p-6">
            <div class="flex items-center justify-between mb-3 sm:mb-4">
                <h2 class="text-lg sm:text-xl font-semibold text-gray-900">Distribusi Organisasi</h2>
                <button onclick="loadOrganizationChart()" class="text-primary-600 hover:text-primary-700 text-sm">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div id="organizationChart" class="h-64">
                <!-- Chart will be loaded here -->
            </div>
            <div id="chartLoading" class="flex items-center justify-center h-64">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"></div>
                <span class="ml-2 text-sm text-gray-600">Memuat grafik...</span>
            </div>
        </div>
    </div>

    <!-- Recent Organizations -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="px-3 sm:px-4 lg:px-6 py-3 sm:py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-lg sm:text-xl font-semibold text-gray-900">Organisasi Terbaru</h2>
                <a href="/pulosarok/organization/data-anggota/" class="text-primary-600 hover:text-primary-700 text-sm font-medium">
                    Lihat Semua
                </a>
            </div>
        </div>
        
        <!-- Desktop Table -->
        <div class="hidden lg:block overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Organisasi</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Anggota</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dibuat</th>
                    </tr>
                </thead>
                <tbody id="organizationsTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Mobile Cards -->
        <div class="lg:hidden" id="organizationsMobileCards">
            <!-- Mobile cards will be loaded here -->
        </div>
        
        <!-- Loading State -->
        <div id="organizationsLoading" class="flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
            <span class="ml-2 text-gray-600">Memuat data organisasi...</span>
        </div>
        
        <!-- Empty State -->
        <div id="organizationsEmpty" class="hidden text-center py-8">
            <i class="fas fa-users text-gray-400 text-4xl mb-4"></i>
            <p class="text-gray-600">Belum ada data organisasi</p>
        </div>
    </div>
</div>

<script>
// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    loadRecentActivities();
    loadOrganizationChart();
    loadRecentOrganizations();
});

// Load dashboard statistics
function loadDashboardStats() {
    // Load organization stats
    fetch('/pulosarok/organization/api/statistics/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalOrganisasi').textContent = data.total_organizations || 0;
        })
        .catch(error => console.error('Error loading organization stats:', error));
    
    // Load member stats
    fetch('/pulosarok/organization/api/anggota-organisasi/statistics/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalAnggota').textContent = data.total_anggota || 0;
        })
        .catch(error => console.error('Error loading member stats:', error));
    
    // Load position stats
    fetch('/pulosarok/organization/api/jabatan/statistics/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalJabatan').textContent = data.total_jabatan || 0;
        })
        .catch(error => console.error('Error loading position stats:', error));
    
    // Load gallery stats
    fetch('/pulosarok/organization/api/galeri-kegiatan/statistics/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalGaleri').textContent = data.total_galeri || 0;
        })
        .catch(error => console.error('Error loading gallery stats:', error));
}

// Load recent activities
function loadRecentActivities() {
    document.getElementById('activitiesLoading').classList.remove('hidden');
    
    // Simulate recent activities (replace with actual API call)
    setTimeout(() => {
        const activities = [
            {
                type: 'member_added',
                message: 'Anggota baru ditambahkan ke Karang Taruna',
                time: '2 jam yang lalu',
                icon: 'fa-user-plus',
                color: 'text-green-600'
            },
            {
                type: 'gallery_uploaded',
                message: 'Foto kegiatan PKK diupload',
                time: '4 jam yang lalu',
                icon: 'fa-images',
                color: 'text-blue-600'
            },
            {
                type: 'organization_created',
                message: 'Organisasi baru "Posyandu Melati" dibuat',
                time: '1 hari yang lalu',
                icon: 'fa-plus-circle',
                color: 'text-purple-600'
            },
            {
                type: 'structure_updated',
                message: 'Struktur organisasi BPD diperbarui',
                time: '2 hari yang lalu',
                icon: 'fa-sitemap',
                color: 'text-orange-600'
            },
            {
                type: 'period_changed',
                message: 'Periode kepengurusan RT 01 diperbarui',
                time: '3 hari yang lalu',
                icon: 'fa-calendar',
                color: 'text-indigo-600'
            }
        ];
        
        const activitiesContainer = document.getElementById('recentActivities');
        activitiesContainer.innerHTML = activities.map(activity => `
            <div class="flex items-start space-x-3 p-3 hover:bg-gray-50 rounded-lg transition-colors duration-200">
                <div class="flex-shrink-0">
                    <i class="fas ${activity.icon} ${activity.color} text-sm"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm text-gray-900">${activity.message}</p>
                    <p class="text-xs text-gray-500">${activity.time}</p>
                </div>
            </div>
        `).join('');
        
        document.getElementById('activitiesLoading').classList.add('hidden');
    }, 1000);
}

// Load organization chart
function loadOrganizationChart() {
    document.getElementById('chartLoading').classList.remove('hidden');
    
    fetch('/pulosarok/organization/api/organizations/chart-data/')
        .then(response => response.json())
        .then(data => {
            renderOrganizationChart(data);
            document.getElementById('chartLoading').classList.add('hidden');
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
            // Fallback to sample data
            const sampleData = [
                { name: 'Karang Taruna', value: 5, color: '#3B82F6' },
                { name: 'PKK', value: 8, color: '#10B981' },
                { name: 'BPD', value: 3, color: '#8B5CF6' },
                { name: 'RT/RW', value: 12, color: '#F59E0B' },
                { name: 'Posyandu', value: 6, color: '#EF4444' }
            ];
            renderOrganizationChart(sampleData);
            document.getElementById('chartLoading').classList.add('hidden');
        });
}

// Render organization chart
function renderOrganizationChart(data) {
    const chartContainer = document.getElementById('organizationChart');
    const total = data.reduce((sum, item) => sum + item.value, 0);
    
    chartContainer.innerHTML = `
        <div class="space-y-3">
            ${data.map(item => {
                const percentage = total > 0 ? (item.value / total * 100) : 0;
                return `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-4 h-4 rounded-full" style="background-color: ${item.color}"></div>
                            <span class="text-sm font-medium text-gray-700">${item.name}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-24 bg-gray-200 rounded-full h-2">
                                <div class="h-2 rounded-full" style="background-color: ${item.color}; width: ${percentage}%"></div>
                            </div>
                            <span class="text-sm font-semibold text-gray-900 w-8 text-right">${item.value}</span>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
        <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-700">Total Organisasi</span>
                <span class="text-lg font-bold text-gray-900">${total}</span>
            </div>
        </div>
    `;
}

// Load recent organizations
function loadRecentOrganizations() {
    document.getElementById('organizationsLoading').classList.remove('hidden');
    
    fetch('/pulosarok/organization/api/organizations/?limit=5&ordering=-created_at')
        .then(response => response.json())
        .then(data => {
            renderRecentOrganizations(data.results || []);
            
            if ((data.results || []).length === 0) {
                document.getElementById('organizationsEmpty').classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error loading recent organizations:', error);
            document.getElementById('organizationsEmpty').classList.remove('hidden');
        })
        .finally(() => {
            document.getElementById('organizationsLoading').classList.add('hidden');
        });
}

// Render recent organizations
function renderRecentOrganizations(organizations) {
    const tableBody = document.getElementById('organizationsTableBody');
    const mobileCards = document.getElementById('organizationsMobileCards');
    
    // Desktop table
    tableBody.innerHTML = organizations.map(org => `
        <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="flex-shrink-0 h-10 w-10">
                        <div class="h-10 w-10 rounded-full bg-primary-100 flex items-center justify-center">
                            <i class="fas fa-users text-primary-600"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">${org.name || 'Nama tidak tersedia'}</div>
                        <div class="text-sm text-gray-500">${org.description || 'Tidak ada deskripsi'}</div>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    ${org.organization_type || 'Umum'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${org.members_count || 0} orang
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                    org.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                }">
                    ${org.is_active ? 'Aktif' : 'Non Aktif'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${new Date(org.created_at).toLocaleDateString('id-ID')}
            </td>
        </tr>
    `).join('');
    
    // Mobile cards
    mobileCards.innerHTML = organizations.map(org => `
        <div class="border-b border-gray-200 p-4">
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <div class="h-10 w-10 rounded-full bg-primary-100 flex items-center justify-center">
                        <i class="fas fa-users text-primary-600"></i>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium text-gray-900 truncate">${org.name || 'Nama tidak tersedia'}</h3>
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${
                            org.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }">
                            ${org.is_active ? 'Aktif' : 'Non Aktif'}
                        </span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1">${org.description || 'Tidak ada deskripsi'}</p>
                    <div class="flex items-center justify-between mt-2">
                        <div class="flex items-center space-x-4 text-xs text-gray-500">
                            <span>${org.organization_type || 'Umum'}</span>
                            <span>${org.members_count || 0} anggota</span>
                        </div>
                        <span class="text-xs text-gray-500">${new Date(org.created_at).toLocaleDateString('id-ID')}</span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Refresh all data
function refreshAllData() {
    loadDashboardStats();
    loadRecentActivities();
    loadOrganizationChart();
    loadRecentOrganizations();
    
    // Show notification
    showNotification('Data berhasil diperbarui', 'success');
}

// Show notification
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${
                type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'
            } mr-2"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}