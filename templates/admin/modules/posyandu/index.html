{% extends 'admin/base.html' %}

{% block title %}{{ page_title }}{% endblock %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        color: white;
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .dashboard-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }
    
    .dashboard-card.green {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .dashboard-card.orange {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .dashboard-card.red {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .dashboard-card.yellow {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: #333;
    }
    
    .dashboard-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: translate(30px, -30px);
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
    }
    
    .chart-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 2rem;
    }
    
    @media (max-width: 768px) {
        .dashboard-card {
            padding: 1rem;
        }
        .stat-card {
            padding: 1rem;
        }
        .chart-container {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-6">
        <!-- Welcome Section -->
        <div class="mb-8">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
                            Selamat Datang di Dashboard Posyandu
                        </h1>
                        <p class="text-gray-600">
                            Kelola semua data kesehatan masyarakat dengan mudah dan efisien
                        </p>
                    </div>
                    <div class="mt-4 md:mt-0">
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Terakhir diperbarui</p>
                            <p class="text-lg font-semibold text-gray-900" id="lastUpdate">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 md:gap-6 mb-8">
            <div class="dashboard-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90 mb-1">Total Kader</p>
                        <p class="text-2xl md:text-3xl font-bold" id="totalKader">-</p>
                    </div>
                    <div class="text-3xl md:text-4xl opacity-80">
                        <i class="fas fa-user-nurse"></i>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card green">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90 mb-1">Ibu Hamil</p>
                        <p class="text-2xl md:text-3xl font-bold" id="totalIbuHamil">-</p>
                    </div>
                    <div class="text-3xl md:text-4xl opacity-80">
                        <i class="fas fa-user-plus"></i>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card orange">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90 mb-1">Balita</p>
                        <p class="text-2xl md:text-3xl font-bold" id="totalBalita">-</p>
                    </div>
                    <div class="text-3xl md:text-4xl opacity-80">
                        <i class="fas fa-baby"></i>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card red">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90 mb-1">Lansia</p>
                        <p class="text-2xl md:text-3xl font-bold" id="totalLansia">-</p>
                    </div>
                    <div class="text-3xl md:text-4xl opacity-80">
                        <i class="fas fa-user-friends"></i>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card yellow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90 mb-1">Stunting</p>
                        <p class="text-2xl md:text-3xl font-bold" id="totalStunting">-</p>
                    </div>
                    <div class="text-3xl md:text-4xl opacity-80">
                        <i class="fas fa-child"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 md:gap-6 mb-8">
            <a href="{% url 'posyandu:kader_admin' %}" class="stat-card hover:bg-blue-50 transition-colors group">
                <div class="text-center">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-blue-200 transition-colors">
                        <i class="fas fa-user-nurse text-blue-600 text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-1">Input Kader</h3>
                    <p class="text-sm text-gray-600">Kelola data kader posyandu</p>
                </div>
            </a>
            
            <a href="{% url 'posyandu:ibu_hamil_admin' %}" class="stat-card hover:bg-green-50 transition-colors group">
                <div class="text-center">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-green-200 transition-colors">
                        <i class="fas fa-user-plus text-green-600 text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-1">Data Ibu Hamil</h3>
                    <p class="text-sm text-gray-600">Input data ibu hamil</p>
                </div>
            </a>
            
            <a href="{% url 'posyandu:view_balita' %}" class="stat-card hover:bg-orange-50 transition-colors group">
                <div class="text-center">
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-orange-200 transition-colors">
                        <i class="fas fa-baby text-orange-600 text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-1">Data Balita</h3>
                    <p class="text-sm text-gray-600">Lihat data balita</p>
                </div>
            </a>
            
            <a href="{% url 'posyandu:view_lansia' %}" class="stat-card hover:bg-purple-50 transition-colors group">
                <div class="text-center">
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-purple-200 transition-colors">
                        <i class="fas fa-user-friends text-purple-600 text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-1">Data Lansia</h3>
                    <p class="text-sm text-gray-600">Lihat data lansia</p>
                </div>
            </a>
            
            <a href="{% url 'posyandu:stunting_admin' %}" class="stat-card hover:bg-red-50 transition-colors group">
                <div class="text-center">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:bg-red-200 transition-colors">
                        <i class="fas fa-child text-red-600 text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-gray-900 mb-1">Data Stunting</h3>
                    <p class="text-sm text-gray-600">Input data stunting</p>
                </div>
            </a>
        </div>

        <!-- Charts and Statistics -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Nutrition Status Chart -->
            <div class="chart-container">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Status Gizi Balita</h3>
                <div class="h-64 flex items-center justify-center">
                    <canvas id="nutritionChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <!-- Pregnancy Risk Chart -->
            <div class="chart-container">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Risiko Kehamilan</h3>
                <div class="h-64 flex items-center justify-center">
                    <canvas id="pregnancyChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Recent Registrations -->
            <div class="stat-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Pendaftaran Terbaru</h3>
                    <button onclick="refreshRecentData()" class="text-blue-600 hover:text-blue-800 transition-colors">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div id="recentRegistrations" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Memuat data...</p>
                    </div>
                </div>
            </div>
            
            <!-- Upcoming Schedules -->
            <div class="stat-card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Jadwal Mendatang</h3>
                    <button onclick="refreshScheduleData()" class="text-blue-600 hover:text-blue-800 transition-colors">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div id="upcomingSchedules" class="space-y-3">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Memuat data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let nutritionChart = null;
let pregnancyChart = null;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    loadCharts();
    loadRecentActivities();
    setLastUpdate();
    
    // Refresh data every 5 minutes
    setInterval(function() {
        loadDashboardStats();
        loadRecentActivities();
        setLastUpdate();
    }, 300000);
});

function setLastUpdate() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('id-ID', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    document.getElementById('lastUpdate').textContent = timeString;
}

function loadDashboardStats() {
    // Load basic statistics
    fetch('/pulosarok/posyandu/api/stats/')
        .then(response => response.json())
        .then(data => {
            // Update main stats cards
            document.getElementById('totalKader').textContent = data.total_kader || '0';
            document.getElementById('totalIbuHamil').textContent = data.total_ibu_hamil || '0';
            document.getElementById('totalBalita').textContent = data.total_balita || '0';
            document.getElementById('totalLansia').textContent = data.total_lansia || '0';
            document.getElementById('totalStunting').textContent = data.total_stunting || '0';
            
            // Update charts with real data
            updateCharts(data);
        })
        .catch(error => {
            console.error('Error loading dashboard stats:', error);
            // Set default values on error
            document.getElementById('totalKader').textContent = '0';
            document.getElementById('totalIbuHamil').textContent = '0';
            document.getElementById('totalBalita').textContent = '0';
            document.getElementById('totalLansia').textContent = '0';
            document.getElementById('totalStunting').textContent = '0';
        });
}

function updateCharts(data) {
    // Update Nutrition Status Chart
    if (nutritionChart && data.nutrition_status) {
        const nutritionLabels = data.nutrition_status.map(item => item.nutrition_status);
        const nutritionData = data.nutrition_status.map(item => item.count);
        
        nutritionChart.data.labels = nutritionLabels;
        nutritionChart.data.datasets[0].data = nutritionData;
        nutritionChart.update();
    }
    
    // Update Pregnancy Risk Chart
    if (pregnancyChart && data.pregnancy_risk) {
        const riskLabels = data.pregnancy_risk.map(item => item.risiko_kehamilan);
        const riskData = data.pregnancy_risk.map(item => item.count);
        
        pregnancyChart.data.labels = riskLabels;
        pregnancyChart.data.datasets[0].data = riskData;
        pregnancyChart.update();
    }
}

function loadCharts() {
    // Nutrition Status Chart
    const nutritionCtx = document.getElementById('nutritionChart').getContext('2d');
    nutritionChart = new Chart(nutritionCtx, {
        type: 'doughnut',
        data: {
            labels: ['Memuat data...'],
            datasets: [{
                data: [1],
                backgroundColor: [
                    '#10B981',
                    '#F59E0B',
                    '#EF4444',
                    '#8B5CF6'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });

    // Pregnancy Risk Chart
    const pregnancyCtx = document.getElementById('pregnancyChart').getContext('2d');
    pregnancyChart = new Chart(pregnancyCtx, {
        type: 'bar',
        data: {
            labels: ['Memuat data...'],
            datasets: [{
                label: 'Jumlah Ibu Hamil',
                data: [1],
                backgroundColor: [
                    '#10B981',
                    '#EF4444'
                ],
                borderRadius: 8,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#F3F4F6'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function loadRecentActivities() {
    loadRecentRegistrations();
    loadUpcomingSchedules();
}

function loadRecentRegistrations() {
    const container = document.getElementById('recentRegistrations');
    
    // Load recent data from APIs
    Promise.all([
        fetch('/pulosarok/posyandu/api/kader/').then(r => r.json()),
        fetch('/pulosarok/posyandu/api/ibu-hamil/').then(r => r.json()),
        fetch('/pulosarok/posyandu/api/stunting/').then(r => r.json())
    ])
    .then(([kaderData, ibuHamilData, stuntingData]) => {
        const recentData = [];
        
        // Add recent kader
        if (kaderData.results && kaderData.results.length > 0) {
            const kader = kaderData.results[0];
            recentData.push({
                name: kader.nama,
                type: 'Kader',
                date: kader.created_at.split(' ')[0],
                icon: 'fa-user-nurse',
                color: 'text-purple-600'
            });
        }
        
        // Add recent ibu hamil
        if (ibuHamilData.results && ibuHamilData.results.length > 0) {
            const ibu = ibuHamilData.results[0];
            recentData.push({
                name: ibu.nama,
                type: 'Ibu Hamil',
                date: ibu.created_at.split(' ')[0],
                icon: 'fa-user-plus',
                color: 'text-green-600'
            });
        }
        
        // Add recent stunting
        if (stuntingData.results && stuntingData.results.length > 0) {
            const stunting = stuntingData.results[0];
            recentData.push({
                name: stunting.nama_balita,
                type: 'Stunting',
                date: stunting.created_at.split(' ')[0],
                icon: 'fa-child',
                color: 'text-red-600'
            });
        }
        
        // If no real data, show message
        if (recentData.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-info-circle text-2xl mb-2"></i>
                    <p>Belum ada data terbaru</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        recentData.forEach(item => {
            html += `
                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                    <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                        <i class="fas ${item.icon} ${item.color}"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">${item.name}</p>
                        <p class="text-xs text-gray-500">${item.type} • ${item.date}</p>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    })
    .catch(error => {
        console.error('Error loading recent data:', error);
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                <p>Gagal memuat data terbaru</p>
            </div>
        `;
    });
}

function loadUpcomingSchedules() {
    const container = document.getElementById('upcomingSchedules');
    
    // Load upcoming schedules from API
    fetch('/pulosarok/posyandu/api/schedules/')
        .then(response => response.json())
        .then(data => {
            if (data.results && data.results.length > 0) {
                const upcomingSchedules = data.results
                    .filter(schedule => new Date(schedule.schedule_date) >= new Date())
                    .slice(0, 3);
                
                if (upcomingSchedules.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-calendar-times text-2xl mb-2"></i>
                            <p>Tidak ada jadwal mendatang</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                upcomingSchedules.forEach(schedule => {
                    html += `
                        <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-calendar text-blue-600"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900">${schedule.title}</p>
                                <p class="text-xs text-gray-500">${schedule.location_name} • ${schedule.schedule_date} ${schedule.start_time}</p>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } else {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-calendar-times text-2xl mb-2"></i>
                        <p>Tidak ada jadwal tersedia</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading schedules:', error);
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p>Gagal memuat jadwal</p>
                </div>
            `;
        });
}

function refreshRecentData() {
    const container = document.getElementById('recentRegistrations');
    container.innerHTML = `
        <div class="text-center py-8 text-gray-500">
            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
            <p>Memuat ulang data...</p>
        </div>
    `;
    
    setTimeout(() => {
        loadRecentRegistrations();
    }, 1000);
}

function refreshScheduleData() {
    const container = document.getElementById('upcomingSchedules');
    container.innerHTML = `
        <div class="text-center py-8 text-gray-500">
            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
            <p>Memuat ulang data...</p>
        </div>
    `;
    
    setTimeout(() => {
        loadUpcomingSchedules();
    }, 1000);
}

// Utility function to format numbers
function formatNumber(num) {
    return new Intl.NumberFormat('id-ID').format(num);
}

// Add animation to count up numbers
function animateValue(element, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        element.textContent = Math.floor(progress * (end - start) + start);
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    window.requestAnimationFrame(step);
}

// Show toast notifications
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${
        type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' :
        type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' :
        'bg-blue-100 border border-blue-400 text-blue-700'
    }`;
    toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} mr-2"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-sm">×</button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
